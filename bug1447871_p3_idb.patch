# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  9d788bae61674281ffad20e2976210afe2db543b
Bug 1447871 P3 Make IDBDatabase invalidate any transactions on DisconnectFromOwner(). r=asuth

diff --git a/dom/indexedDB/IDBDatabase.cpp b/dom/indexedDB/IDBDatabase.cpp
--- a/dom/indexedDB/IDBDatabase.cpp
+++ b/dom/indexedDB/IDBDatabase.cpp
@@ -1193,16 +1193,23 @@ NS_IMPL_CYCLE_COLLECTION_UNLINK_BEGIN_IN
   // Don't unlink mFactory!
 
   // We've been unlinked, at the very least we should be able to prevent further
   // transactions from starting and unblock any other SetVersion callers.
   tmp->CloseInternal();
 NS_IMPL_CYCLE_COLLECTION_UNLINK_END
 
 void
+IDBDatabase::DisconnectFromOwner()
+{
+  InvalidateInternal();
+  IDBWrapperCache::DisconnectFromOwner();
+}
+
+void
 IDBDatabase::LastRelease()
 {
   AssertIsOnOwningThread();
 
   CloseInternal();
 
   if (mBackgroundActor) {
     mBackgroundActor->SendDeleteMeInternal();
diff --git a/dom/indexedDB/IDBDatabase.h b/dom/indexedDB/IDBDatabase.h
--- a/dom/indexedDB/IDBDatabase.h
+++ b/dom/indexedDB/IDBDatabase.h
@@ -282,16 +282,20 @@ public:
   Spec() const
   {
     return mSpec;
   }
 
   NS_DECL_ISUPPORTS_INHERITED
   NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED(IDBDatabase, IDBWrapperCache)
 
+  // DOMEventTargetHelper
+  void
+  DisconnectFromOwner() override;
+
   // nsIDOMEventTarget
   virtual void
   LastRelease() override;
 
   virtual nsresult
   PostHandleEvent(EventChainPostVisitor& aVisitor) override;
 
   // nsWrapperCache
