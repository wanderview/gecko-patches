# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  02636c4d21d4dd684f5d91f647bac91468e7e9f2
Bug 1331038 P1 Make nsPipe handle OOM conditions gracefully. r=froydnj

diff --git a/xpcom/io/nsPipe3.cpp b/xpcom/io/nsPipe3.cpp
--- a/xpcom/io/nsPipe3.cpp
+++ b/xpcom/io/nsPipe3.cpp
@@ -865,17 +865,19 @@ nsPipe::GetWriteSegment(char*& aSegment,
     // being written into the pipe.
     if (IsAdvanceBufferFull(mon)) {
       return NS_BASE_STREAM_WOULD_BLOCK;
     }
 
     // The nsSegmentedBuffer is configured to be "infinite", so this
     // should never return nullptr here.
     char* seg = mBuffer.AppendNewSegment();
-    MOZ_DIAGNOSTIC_ASSERT(seg);
+    if (!seg) {
+      return NS_ERROR_OUT_OF_MEMORY;
+    }
 
     LOG(("OOO appended new segment\n"));
     mWriteCursor = seg;
     mWriteLimit = mWriteCursor + mBuffer.GetSegmentSize();
     ++mWriteSegment;
   }
 
   // make sure read cursor is initialized
