# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  c44f60c43432d468639b5fe078420e60c13fd3de
Bug 1450358 P4 Add a MediaQueryList event listener leak test. r=baku

diff --git a/layout/style/test/mochitest.ini b/layout/style/test/mochitest.ini
--- a/layout/style/test/mochitest.ini
+++ b/layout/style/test/mochitest.ini
@@ -363,8 +363,9 @@ skip-if = toolkit == 'android' # TIMED_O
 skip-if = toolkit == 'android' # TIMED_OUT for android
 [test_visited_reftests.html]
 skip-if = toolkit == 'android' # TIMED_OUT for android
 [test_webkit_device_pixel_ratio.html]
 [test_webkit_flex_display.html]
 [test_first_letter_restrictions.html]
 [test_first_line_restrictions.html]
 [test_placeholder_restrictions.html]
+[test_mql_event_listener_leaks.html]
diff --git a/layout/style/test/test_mql_event_listener_leaks.html b/layout/style/test/test_mql_event_listener_leaks.html
new file mode 100644
--- /dev/null
+++ b/layout/style/test/test_mql_event_listener_leaks.html
@@ -0,0 +1,97 @@
+<!--
+  Any copyright is dedicated to the Public Domain.
+  http://creativecommons.org/publicdomain/zero/1.0/
+-->
+<!DOCTYPE HTML>
+<html>
+<head>
+  <title>Bug 1450271 - Test MediaQueryList event listener leak conditions</title>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<p id="display"></p>
+<div id="content" style="display: none"></div>
+<pre id="test"></pre>
+<script class="testbody" type="text/javascript">
+// Utility function to create a loaded iframe.
+async function withFrame(doc, url) {
+  let frame = doc.createElement('iframe');
+  frame.src = url;
+  doc.body.appendChild(frame);
+  await new Promise(resolve => frame.onload = resolve);
+  return frame;
+}
+
+// Manipulate MediaQueryList.  Its important here that we create a
+// listener callback from the DOM objects back to the frame's global
+// in order to exercise the leak condition.
+async function useMediaQuery(name, contentWindow) {
+  contentWindow.messageCount = 0;
+
+  let mql = contentWindow.matchMedia("(max-width: 600px)");
+  mql.onchange = _ => {
+    contentWindow.mediaCount += 1;
+  };
+}
+
+// This function defines the basic form of the test cases.  We create an
+// iframe, manipulate a MediaQueryList DOM object, remove the frame
+// from the DOM and then check to see if the frame was GC'd.  The caller
+// may optionally pass in a callback that will be executed with the
+// frame as an argument before removing it from the DOM.
+async function leakTest(name, callback) {
+  let frame = await withFrame(document, "about:blank");
+
+  await useMediaQuery(name, frame.contentWindow);
+
+  let weakRef = SpecialPowers.Cu.getWeakReference(frame.contentWindow);
+  ok(weakRef.get(), `should be able to create a weak reference - ${name}`);
+
+  if (callback) {
+    await callback(frame);
+  }
+
+  frame.remove();
+  frame = null;
+
+  await new Promise(resolve => SpecialPowers.exactGC(resolve));
+  await new Promise(resolve => SpecialPowers.exactGC(resolve));
+  ok(!weakRef.get(), `iframe content window should be garbage collected - ${name}`);
+}
+
+async function runTest() {
+  try {
+    // Test if we leak in the case where we do nothing special to
+    // te frame before removing it from the DOM.
+    await leakTest("default");
+
+    // Test the case where we navigate the frame before removing it
+    // from the DOM so that the MediaQueryList using window ends up
+    // in bfcache.
+    await leakTest("bfcache", frame => {
+      frame.src = "about:blank";
+      return new Promise(resolve => frame.onload = resolve);
+    });
+
+    // Test the case where we document.open() the frame before removing
+    // it from the DOM so that the MediaQueryList using window ends
+    // up getting replaced.
+    await leakTest("document.open()", frame => {
+      frame.contentDocument.open();
+      frame.contentDocument.close();
+    });
+  } catch (e) {
+    ok(false, e);
+  } finally {
+    SimpleTest.finish();
+  }
+}
+
+SimpleTest.waitForExplicitFinish();
+addEventListener("load", runTest, { once: true });
+</script>
+</pre>
+</body>
+</html>
+
