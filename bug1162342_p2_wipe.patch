# HG changeset patch
# Parent 6567c6ca22d4f1a8de45fd332b69a81d21014bd6
# User Ben Kelly <ben@wanderview.com>
Bug 1162342 P2 Remove the WAL journal file when wiping the Cache sqlite db. r=ehsan


diff --git a/dom/cache/DBAction.cpp b/dom/cache/DBAction.cpp
--- a/dom/cache/DBAction.cpp
+++ b/dom/cache/DBAction.cpp
@@ -179,17 +179,39 @@ DBAction::OpenConnection(const QuotaInfo
   conn.forget(aConnOut);
 
   return rv;
 }
 
 nsresult
 DBAction::WipeDatabase(nsIFile* aDBFile, nsIFile* aDBDir)
 {
-  nsresult rv = aDBFile->Remove(false);
+  // Calculate the WAL journal file name
+  nsCOMPtr<nsIFile> walFile;
+  nsresult rv = aDBFile->Clone(getter_AddRefs(walFile));
+  if (NS_WARN_IF(NS_FAILED(rv))) { return rv; }
+
+  nsAutoCString leafName;
+  rv = walFile->GetNativeLeafName(leafName);
+  if (NS_WARN_IF(NS_FAILED(rv))) { return rv; }
+
+  leafName.Append(NS_LITERAL_CSTRING("-wal"));
+  rv = walFile->SetNativeLeafName(leafName);
+  if (NS_WARN_IF(NS_FAILED(rv))) { return rv; }
+
+  // Delete the main database file
+  rv = aDBFile->Remove(false /* recursive */);
+  if (NS_WARN_IF(NS_FAILED(rv))) { return rv; }
+
+  // Delete the WAL journal file, if its there
+  rv = walFile->Remove(false /* recursive */);
+  if (rv == NS_ERROR_FILE_NOT_FOUND ||
+      rv == NS_ERROR_FILE_TARGET_DOES_NOT_EXIST) {
+    rv = NS_OK;
+  }
   if (NS_WARN_IF(NS_FAILED(rv))) { return rv; }
 
   // Delete the morgue as well.
   rv = BodyDeleteDir(aDBDir);
   if (NS_WARN_IF(NS_FAILED(rv))) { return rv; }
 
   return rv;
 }
