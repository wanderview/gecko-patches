# HG changeset patch
# Parent 88d81b0a7ab448c1bfb66a02adcfb19a1343962d
# User Ben Kelly <ben@wanderview.com>
Bug 1155193 interdiff 001 fix try failures

diff --git a/storage/src/mozStorageService.cpp b/storage/src/mozStorageService.cpp
--- a/storage/src/mozStorageService.cpp
+++ b/storage/src/mozStorageService.cpp
@@ -324,17 +324,18 @@ Service::unregisterConnection(Connection
   {
     mRegistrationMutex.AssertNotCurrentThreadOwns();
     MutexAutoLock mutex(mRegistrationMutex);
 
     for (uint32_t i = 0 ; i < mConnections.Length(); ++i) {
       if (mConnections[i] == aConnection) {
         // Ensure the connection is released on its opening thread
         if (NS_GetCurrentThread() != mConnections[i]->threadOpenedOn) {
-          NS_ProxyRelease(mConnections[i]->threadOpenedOn,
+          nsCOMPtr<nsIThread> thread = mConnections[i]->threadOpenedOn;
+          NS_ProxyRelease(thread,
             static_cast<mozIStorageConnection*>(mConnections[i].forget().take()));
         }
         mConnections.RemoveElementAt(i);
         return;
       }
     }
 
     MOZ_ASSERT_UNREACHABLE("Attempt to unregister unknown storage connection!");
