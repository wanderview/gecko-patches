# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  69ec3dc408a2a720cb2b8210fea33e3504aeec22
Bug 1249351 P2 Clean up test_importscript.html and add multiple-url importScript() case. r=bz

diff --git a/dom/workers/test/serviceworkers/importscript_worker.js b/dom/workers/test/serviceworkers/importscript_worker.js
--- a/dom/workers/test/serviceworkers/importscript_worker.js
+++ b/dom/workers/test/serviceworkers/importscript_worker.js
@@ -1,28 +1,36 @@
 var counter = 0;
 function callByScript() {
   ++counter;
 }
 
-importScripts(['importscript.sjs']);
-importScripts(['importscript.sjs']);
+// Use multiple scripts in this load to verify we support the case correctly.
+// See bug 1249351 for a case where we broke this.
+importScripts('lorum_script.js', 'importscript.sjs');
 
+importScripts('importscript.sjs');
+
+var missingScriptFailed = false;
 try {
   importScripts(['there-is-nothing-here.js']);
-} catch (ex) {
-  // Importing a non-existent script should not abort the SW load, bug 1198982.
+} catch(e) {
+  missingScriptFailed = true;
 }
 
 onmessage = function(e) {
   self.clients.matchAll().then(function(res) {
     if (!res.length) {
       dump("ERROR: no clients are currently controlled.\n");
     }
 
+    if (!missingScriptFailed) {
+      res[0].postMessage("KO");
+    }
+
     try {
       importScripts(['importscript.sjs']);
       res[0].postMessage("KO");
       return;
     } catch(e) {}
 
     res[0].postMessage(counter == 2 ? "OK" : "KO");
   });
diff --git a/dom/workers/test/serviceworkers/mochitest.ini b/dom/workers/test/serviceworkers/mochitest.ini
--- a/dom/workers/test/serviceworkers/mochitest.ini
+++ b/dom/workers/test/serviceworkers/mochitest.ini
@@ -192,16 +192,17 @@ support-files =
   redirect_post.sjs
   xslt_worker.js
   xslt/*
   unresolved_fetch_worker.js
   header_checker.sjs
   openWindow_worker.js
   redirect.sjs
   open_window/client.html
+  lorum_script.js
 
 [test_bug1151916.html]
 skip-if = e10s && debug && os == 'win'
 [test_claim.html]
 skip-if = e10s && debug && os == 'win'
 [test_claim_fetch.html]
 skip-if = e10s && debug && os == 'win'
 [test_claim_oninstall.html]
