# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  d0be57e84807ce0853b2406de7ff6abb195ac898
Bug 1273070 P2 Execute fetch() mochitests in nested workers. r=khuey

diff --git a/dom/tests/mochitest/fetch/fetch_test_framework.js b/dom/tests/mochitest/fetch/fetch_test_framework.js
--- a/dom/tests/mochitest/fetch/fetch_test_framework.js
+++ b/dom/tests/mochitest/fetch/fetch_test_framework.js
@@ -31,16 +31,37 @@ function testScript(script) {
       worker.onerror = function(event) {
         reject("Worker error: " + event.message);
       };
 
       worker.postMessage({ "script": script });
     });
   }
 
+  function nestedWorkerTest() {
+    return new Promise(function(resolve, reject) {
+      var worker = new Worker("nested_worker_wrapper.js");
+      worker.onmessage = function(event) {
+        if (event.data.context != "NestedWorker") {
+          return;
+        }
+        if (event.data.type == 'finish') {
+          resolve();
+        } else if (event.data.type == 'status') {
+          ok(event.data.status, event.data.context + ": " + event.data.msg);
+        }
+      }
+      worker.onerror = function(event) {
+        reject("Nested Worker error: " + event.message);
+      };
+
+      worker.postMessage({ "script": script });
+    });
+  }
+
   function serviceWorkerTest() {
     var isB2G = !navigator.userAgent.includes("Android") &&
                 /Mobile|Tablet/.test(navigator.userAgent);
     if (isB2G) {
       // TODO B2G doesn't support running service workers for now due to bug 1137683.
       dump("Skipping running the test in SW until bug 1137683 gets fixed.\n");
       return Promise.resolve();
     }
@@ -108,16 +129,19 @@ function testScript(script) {
   setupPrefs()
     .then(function() {
       return windowTest();
     })
     .then(function() {
       return workerTest();
     })
     .then(function() {
+      return nestedWorkerTest();
+    })
+    .then(function() {
       return serviceWorkerTest();
     })
     .catch(function(e) {
       ok(false, "Some test failed in " + script);
       info(e);
       info(e.message);
       return Promise.resolve();
     })
diff --git a/dom/tests/mochitest/fetch/mochitest.ini b/dom/tests/mochitest/fetch/mochitest.ini
--- a/dom/tests/mochitest/fetch/mochitest.ini
+++ b/dom/tests/mochitest/fetch/mochitest.ini
@@ -5,16 +5,17 @@ support-files =
   test_fetch_basic.js
   test_fetch_basic_http.js
   test_fetch_cors.js
   test_formdataparsing.js
   test_headers_common.js
   test_request.js
   test_response.js
   utils.js
+  nested_worker_wrapper.js
   worker_wrapper.js
   message_receiver.html
   reroute.html
   reroute.js
   reroute.js^headers^
   sw_reroute.js
   empty.js
   empty.js^headers^
diff --git a/dom/tests/mochitest/fetch/nested_worker_wrapper.js b/dom/tests/mochitest/fetch/nested_worker_wrapper.js
new file mode 100644
--- /dev/null
+++ b/dom/tests/mochitest/fetch/nested_worker_wrapper.js
@@ -0,0 +1,25 @@
+addEventListener('message', function nestedWorkerWrapperOnMessage(evt) {
+  removeEventListener('message', nestedWorkerWrapperOnMessage);
+
+  var worker = new Worker('worker_wrapper.js');
+
+  worker.addEventListener('message', function(evt) {
+    self.postMessage({
+      context: 'NestedWorker',
+      type: evt.data.type,
+      status: evt.data.status,
+      msg: evt.data.msg,
+    });
+  });
+
+  worker.addEventListener('error', function(evt) {
+    self.postMessage({
+      context: 'NestedWorker',
+      type: 'status',
+      status: false,
+      msg: 'Nested worker error: ' + evt.message,
+    });
+  });
+
+  worker.postMessage(evt.data);
+});
