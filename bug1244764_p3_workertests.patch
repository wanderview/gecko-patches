# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  24e082d5cb21253123e8fcb0611e91ee61b90c4d
Bug 1244764 P3 Make service worker tests pass with new Cache add()/addAll() behavior. r=ehsan

diff --git a/dom/workers/test/serviceworkers/fetch/origin/https/origin_test.js b/dom/workers/test/serviceworkers/fetch/origin/https/origin_test.js
--- a/dom/workers/test/serviceworkers/fetch/origin/https/origin_test.js
+++ b/dom/workers/test/serviceworkers/fetch/origin/https/origin_test.js
@@ -1,15 +1,21 @@
 var prefix = "/tests/dom/workers/test/serviceworkers/fetch/origin/https/";
 
+function addOpaqueRedirect(cache, file) {
+  return fetch(new Request(prefix + file, { redirect: "manual" })).then(function(response) {
+    return cache.put(prefix + file, response);
+  });
+}
+
 self.addEventListener("install", function(event) {
   event.waitUntil(
     self.caches.open("origin-cache")
       .then(c => {
-        return c.add(new Request(prefix + 'index-https.sjs', {redirect: "manual"}));
+        return addOpaqueRedirect(c, 'index-https.sjs');
       })
   );
 });
 
 self.addEventListener("fetch", function(event) {
   if (event.request.url.indexOf("index-cached-https.sjs") >= 0) {
     event.respondWith(
       self.caches.open("origin-cache")
diff --git a/dom/workers/test/serviceworkers/fetch/origin/origin_test.js b/dom/workers/test/serviceworkers/fetch/origin/origin_test.js
--- a/dom/workers/test/serviceworkers/fetch/origin/origin_test.js
+++ b/dom/workers/test/serviceworkers/fetch/origin/origin_test.js
@@ -1,18 +1,24 @@
 var prefix = "/tests/dom/workers/test/serviceworkers/fetch/origin/";
 
+function addOpaqueRedirect(cache, file) {
+  return fetch(new Request(prefix + file, { redirect: "manual" })).then(function(response) {
+    return cache.put(prefix + file, response);
+  });
+}
+
 self.addEventListener("install", function(event) {
   event.waitUntil(
     self.caches.open("origin-cache")
       .then(c => {
         return Promise.all(
           [
-            c.add(new Request(prefix + 'index.sjs', {redirect: "manual"})),
-            c.add(new Request(prefix + 'index-to-https.sjs', {redirect: "manual"}))
+            addOpaqueRedirect(c, 'index.sjs'),
+            addOpaqueRedirect(c, 'index-to-https.sjs')
           ]
         );
       })
   );
 });
 
 self.addEventListener("fetch", function(event) {
   if (event.request.url.indexOf("index-cached.sjs") >= 0) {
