# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  acfb2c3ac6ae0a704e2756184815296ac1314f89
Bug 1299887 P1 Make dom/cache FetchHandler cycle collected. r=bz

diff --git a/dom/cache/Cache.cpp b/dom/cache/Cache.cpp
--- a/dom/cache/Cache.cpp
+++ b/dom/cache/Cache.cpp
@@ -217,20 +217,28 @@ private:
     mPromise->MaybeReject(rv);
   }
 
   RefPtr<CacheWorkerHolder> mWorkerHolder;
   RefPtr<Cache> mCache;
   nsTArray<RefPtr<Request>> mRequestList;
   RefPtr<Promise> mPromise;
 
-  NS_DECL_ISUPPORTS
+  NS_DECL_CYCLE_COLLECTING_ISUPPORTS
+  NS_DECL_CYCLE_COLLECTION_CLASS(Cache::FetchHandler)
 };
 
-NS_IMPL_ISUPPORTS0(Cache::FetchHandler)
+NS_IMPL_CYCLE_COLLECTION(Cache::FetchHandler, mCache, mRequestList, mPromise);
+
+NS_IMPL_CYCLE_COLLECTING_ADDREF(Cache::FetchHandler)
+NS_IMPL_CYCLE_COLLECTING_RELEASE(Cache::FetchHandler)
+
+NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(Cache::FetchHandler)
+  NS_INTERFACE_MAP_ENTRY(nsISupports)
+NS_INTERFACE_MAP_END
 
 NS_IMPL_CYCLE_COLLECTING_ADDREF(mozilla::dom::cache::Cache);
 NS_IMPL_CYCLE_COLLECTING_RELEASE(mozilla::dom::cache::Cache);
 NS_IMPL_CYCLE_COLLECTION_WRAPPERCACHE(mozilla::dom::cache::Cache, mGlobal);
 
 NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(Cache)
   NS_WRAPPERCACHE_INTERFACE_MAP_ENTRY
   NS_INTERFACE_MAP_ENTRY(nsISupports)
