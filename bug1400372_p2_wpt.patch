# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  524f279cbee494525a3d546d04b9fa0b200376f4
Bug 1400372 P2 Add a WPT test that verifies a redirecting importScripts() can trigger an update. r=hopang

diff --git a/testing/web-platform/meta/MANIFEST.json b/testing/web-platform/meta/MANIFEST.json
--- a/testing/web-platform/meta/MANIFEST.json
+++ b/testing/web-platform/meta/MANIFEST.json
@@ -620444,17 +620444,17 @@
    "6cafc3245c88f7d96f6a4672b327d3b58ee4a0ee",
    "testharness"
   ],
   "service-workers/service-worker/immutable-prototype-serviceworker.https.html": [
    "5c17042fa54cd1fdba6f7aae513412d4a223b432",
    "testharness"
   ],
   "service-workers/service-worker/import-scripts-redirect.https.html": [
-   "4ff11da0e7ae6745232a8202cd67edaf6c5497d1",
+   "ad5ca174b55222c41d1dc1a21fe0bc070357062b",
    "testharness"
   ],
   "service-workers/service-worker/import-scripts-resource-map.https.html": [
    "6bc46467c667f942fd30de063806474e8c94cff0",
    "testharness"
   ],
   "service-workers/service-worker/import-scripts-updated-flag.https.html": [
    "e902940bec870cf548c576b5fd06d2e71fd3f97a",
@@ -620820,21 +620820,21 @@
    "963e8436d3c2571fb971f05aaa4710f5d3dd7abe",
    "support"
   ],
   "service-workers/service-worker/resources/blank.html": [
    "0ddb4f1cf84729ed673295719ec58a3e5d600a12",
    "support"
   ],
   "service-workers/service-worker/resources/bytecheck-worker-imported-script.py": [
-   "772d029d4efbe22f62f3473d4afe9e501a792571",
+   "b488558e1bb16901b0a9b60f40aeddab9c464021",
    "support"
   ],
   "service-workers/service-worker/resources/bytecheck-worker.py": [
-   "66ec51461bc4da5862a9c4d06a9468a8dbe1d134",
+   "11a8883c24628b25f3faa1470da05caddd5eb094",
    "support"
   ],
   "service-workers/service-worker/resources/claim-shared-worker-fetch-iframe.html": [
    "2f7b5ec149446b2a81044e8b50ccc644facb4e42",
    "support"
   ],
   "service-workers/service-worker/resources/claim-shared-worker-fetch-worker.js": [
    "f5b8d26920aecfde1ee34657aa6006304c7da5a3",
@@ -621248,17 +621248,17 @@
    "95d29c9b8749cabf795d9a867e260827a8360640",
    "support"
   ],
   "service-workers/service-worker/resources/import-scripts-redirect-import.js": [
    "34472e2e6dac507ca6c937f3ce872d0b5718b89a",
    "support"
   ],
   "service-workers/service-worker/resources/import-scripts-redirect-worker.js": [
-   "f29c77e2c504ba8e5a72c260233f6deba76dfb5d",
+   "9507f4a23a9f54a898139c19e62fdf6ce3b21690",
    "support"
   ],
   "service-workers/service-worker/resources/import-scripts-resource-map-worker.js": [
    "bafc81b044c2a52f4ceefcd15a0b8b3c7553146e",
    "support"
   ],
   "service-workers/service-worker/resources/import-scripts-updated-flag-worker.js": [
    "b83d48b7ed268293b4788e36bcd7293b1b15e751",
@@ -628464,29 +628464,29 @@
    "16bdf435f3d05ceca30394dee6d82adcb64c997b",
    "wdspec"
   ],
   "webdriver/tests/retrieval/__init__.py": [
    "da39a3ee5e6b4b0d3255bfef95601890afd80709",
    "support"
   ],
   "webdriver/tests/retrieval/find_element.py": [
-   "eeddcad4917fa1c01cda6e9c61f922243935d8d7",
+   "a2d29c9c8dd5303d196d0682a19f3f3560b35872",
    "wdspec"
   ],
   "webdriver/tests/retrieval/find_element_from_element.py": [
-   "d08f125d788b2bba224f26415a7d5f7bc0294a30",
+   "78d5e503bf979307f313b72f7578c55264c6e207",
    "wdspec"
   ],
   "webdriver/tests/retrieval/find_element_from_elements.py": [
-   "ad0baf0ad3506051f7959eea72c077b41c994167",
+   "0be0eb0bd904fa8f7e5332d43cef2b36dae1a579",
    "wdspec"
   ],
   "webdriver/tests/retrieval/find_elements.py": [
-   "5f052a79bfe687ec7cdb2583649bf689a9d0e984",
+   "7df448c94c89bdb9f6818a69a9d52b21faa4b944",
    "wdspec"
   ],
   "webdriver/tests/sessions/new_session/conftest.py": [
    "d2df38e506cb9a3e501f03fe03e2a31af42d6f04",
    "support"
   ],
   "webdriver/tests/sessions/new_session/create.py": [
    "f47ffcbaf22af9f445e4202ebeaa03bb9415fbc9",
diff --git a/testing/web-platform/tests/service-workers/service-worker/import-scripts-redirect.https.html b/testing/web-platform/tests/service-workers/service-worker/import-scripts-redirect.https.html
--- a/testing/web-platform/tests/service-workers/service-worker/import-scripts-redirect.https.html
+++ b/testing/web-platform/tests/service-workers/service-worker/import-scripts-redirect.https.html
@@ -9,10 +9,25 @@
 promise_test(async t => {
     const scope = 'resources/import-scripts-redirect';
     await service_worker_unregister(t, scope);
     let reg = await navigator.serviceWorker.register(
       'resources/import-scripts-redirect-worker.js', { scope: scope });
     assert_not_equals(reg.installing, null, 'worker is installing');
     await reg.unregister();
   }, 'importScripts() supports redirects');
+
+promise_test(async t => {
+    const scope = 'resources/import-scripts-redirect';
+    await service_worker_unregister(t, scope);
+    let reg = await navigator.serviceWorker.register(
+      'resources/import-scripts-redirect-worker.js', { scope: scope });
+    assert_not_equals(reg.installing, null, 'worker is installing');
+    await wait_for_state(t, reg.installing, 'activated');
+    await Promise.all([
+      wait_for_update(t, reg),
+      reg.update()
+    ]);
+    assert_not_equals(reg.installing, null, 'worker is installing');
+    await reg.unregister();
+  }, 'importScripts() supports redirects and can be updated');
 </script>
 </body>
diff --git a/testing/web-platform/tests/service-workers/service-worker/resources/import-scripts-redirect-worker.js b/testing/web-platform/tests/service-workers/service-worker/resources/import-scripts-redirect-worker.js
--- a/testing/web-platform/tests/service-workers/service-worker/resources/import-scripts-redirect-worker.js
+++ b/testing/web-platform/tests/service-workers/service-worker/resources/import-scripts-redirect-worker.js
@@ -1,1 +1,1 @@
-importScripts('redirect.py?Redirect=import-scripts-redirect-import.js');
+importScripts('redirect.py?Redirect=import-scripts-version.py');
