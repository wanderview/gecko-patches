# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  df9bcf4ccd099ecb4787b6dd2ba3c39b7909f020
Bug 1231211 P6 Automatically set the controller on the LoadInfo for subresource requests. r=asuth

diff --git a/netwerk/base/LoadInfo.cpp b/netwerk/base/LoadInfo.cpp
--- a/netwerk/base/LoadInfo.cpp
+++ b/netwerk/base/LoadInfo.cpp
@@ -112,16 +112,25 @@ LoadInfo::LoadInfo(nsIPrincipal* aLoadin
   }
 
   if (aLoadingContext) {
     // Ensure that all network requests for a window client have the ClientInfo
     // properly set.
     // TODO: The ClientInfo is not set properly for worker initiated requests yet.
     mClientInfo = aLoadingContext->OwnerDoc()->GetClientInfo();
 
+    // For subresource loads set the service worker based on the calling
+    // context's controller.
+    // TODO: The controller is not set properly for all requests initiated from a
+    //       worker context.  Some workers will not have an nsINode loading context
+    //       here.
+    if (!nsContentUtils::IsNonSubresourceInternalPolicyType(mInternalContentPolicyType)) {
+      mController = aLoadingContext->OwnerDoc()->GetController();
+    }
+
     nsCOMPtr<nsPIDOMWindowOuter> contextOuter = aLoadingContext->OwnerDoc()->GetWindow();
     if (contextOuter) {
       ComputeIsThirdPartyContext(contextOuter);
       mOuterWindowID = contextOuter->WindowID();
       nsCOMPtr<nsPIDOMWindowOuter> parent = contextOuter->GetScriptableParent();
       mParentOuterWindowID = parent ? parent->WindowID() : mOuterWindowID;
       mTopOuterWindowID = FindTopOuterWindowID(contextOuter);
     }
