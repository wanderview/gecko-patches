# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  de1303b272f65a67f1228c7a93517cd7175afa9d
Bug 1425975 P5 Make ServiceWorkerManager::RemoveRegistration assert there is no controlled document. r=asuth

diff --git a/dom/workers/ServiceWorkerManager.cpp b/dom/workers/ServiceWorkerManager.cpp
--- a/dom/workers/ServiceWorkerManager.cpp
+++ b/dom/workers/ServiceWorkerManager.cpp
@@ -2304,27 +2304,28 @@ ServiceWorkerManager::RemoveScopeAndRegi
     return;
   }
 
   if (auto entry = data->mUpdateTimers.Lookup(aRegistration->mScope)) {
     entry.Data()->Cancel();
     entry.Remove();
   }
 
-  // The registration should generally only be removed if there are no controlled
-  // documents, but mControlledDocuments can contain references to potentially
-  // controlled docs.  This happens when the service worker is not active yet.
-  // We must purge these references since we are evicting the registration.
+  // Verify there are no controlled documents for the purged registration.
+#ifdef MOZ_DIAGNOSTIC_ASSERT_ENABLED
   for (auto iter = swm->mControlledDocuments.Iter(); !iter.Done(); iter.Next()) {
     ServiceWorkerRegistrationInfo* reg = iter.UserData();
-    MOZ_ASSERT(reg);
     if (reg->mScope.Equals(aRegistration->mScope)) {
+      MOZ_DIAGNOSTIC_ASSERT(false,
+                            "controlled document when removing registration");
       iter.Remove();
+      break;
     }
   }
+#endif
 
   RefPtr<ServiceWorkerRegistrationInfo> info;
   data->mInfos.Remove(aRegistration->mScope, getter_AddRefs(info));
   data->mOrderedScopes.RemoveElement(aRegistration->mScope);
   swm->NotifyListenersOnUnregister(info);
 
   swm->MaybeRemoveRegistrationInfo(scopeKey);
   swm->NotifyServiceWorkerRegistrationRemoved(aRegistration);
