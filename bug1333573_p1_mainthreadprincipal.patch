# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  8ff550409e1d1f8b54f6f7f115545dbef857be0b
Bug 1333573 P1 Make WorkerPrivate use an nsMainThreadPtrHandle for its nsIPrincipal. r=baku

diff --git a/dom/workers/WorkerPrivate.h b/dom/workers/WorkerPrivate.h
--- a/dom/workers/WorkerPrivate.h
+++ b/dom/workers/WorkerPrivate.h
@@ -581,17 +581,17 @@ public:
   DOMHighResTimeStamp TimeStampToDOMHighRes(const TimeStamp& aTimeStamp) const
   {
     MOZ_ASSERT(!aTimeStamp.IsNull());
     TimeDuration duration = aTimeStamp - mCreationTimeStamp;
     return duration.ToMilliseconds();
   }
 
   nsIPrincipal*
-  GetPrincipal() const
+  GetPrincipal()
   {
     AssertIsOnMainThread();
     return mLoadInfo.mPrincipal;
   }
 
   nsILoadGroup*
   GetLoadGroup() const
   {
diff --git a/dom/workers/Workers.h b/dom/workers/Workers.h
--- a/dom/workers/Workers.h
+++ b/dom/workers/Workers.h
@@ -9,16 +9,17 @@
 
 #include "jsapi.h"
 #include "mozilla/Attributes.h"
 #include "mozilla/Mutex.h"
 #include <stdint.h>
 #include "nsAutoPtr.h"
 #include "nsCOMPtr.h"
 #include "nsDebug.h"
+#include "nsProxyRelease.h"
 #include "nsString.h"
 #include "nsTArray.h"
 
 #include "nsILoadContext.h"
 #include "nsIWeakReferenceUtils.h"
 #include "nsIInterfaceRequestor.h"
 #include "mozilla/dom/ChannelInfo.h"
 #include "mozilla/net/ReferrerPolicy.h"
@@ -209,17 +210,17 @@ enum WorkerPreference
 
 // Implemented in WorkerPrivate.cpp
 
 struct WorkerLoadInfo
 {
   // All of these should be released in WorkerPrivateParent::ForgetMainThreadObjects.
   nsCOMPtr<nsIURI> mBaseURI;
   nsCOMPtr<nsIURI> mResolvedScriptURI;
-  nsCOMPtr<nsIPrincipal> mPrincipal;
+  nsMainThreadPtrHandle<nsIPrincipal> mPrincipal;
   nsCOMPtr<nsIScriptContext> mScriptContext;
   nsCOMPtr<nsPIDOMWindowInner> mWindow;
   nsCOMPtr<nsIContentSecurityPolicy> mCSP;
   nsCOMPtr<nsIChannel> mChannel;
   nsCOMPtr<nsILoadGroup> mLoadGroup;
 
   // mLoadFailedAsyncRunnable will execute on main thread if script loading
   // fails during script loading.  If script loading is never started due to
