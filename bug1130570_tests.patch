
# HG changeset patch
# User Andrea Marchesini <amarchesini@mozilla.com>
# Date 1423782611 28800
# Node ID 4055d0104e77e3ec0146f917d7928f308b6eb8bd
# Parent  2690e12e01d0de2d48887caeee8127c56856af24
Bug 1130570 - Fix tests to use iframe to work on b2g. r=nsm

diff --git a/dom/workers/test/serviceworkers/controller/index.html b/dom/workers/test/serviceworkers/controller/index.html
--- a/dom/workers/test/serviceworkers/controller/index.html
+++ b/dom/workers/test/serviceworkers/controller/index.html
@@ -12,21 +12,21 @@
 <body>
 <p id="display"></p>
 <div id="content" style="display: none"></div>
 <pre id="test"></pre>
 <script class="testbody" type="text/javascript">
 
   // Make sure to use good, unique messages, since the actual expression will not show up in test results.
   function my_ok(result, msg) {
-    window.opener.postMessage({status: "ok", result: result, message: msg}, "*");
+    parent.postMessage({status: "ok", result: result, message: msg}, "*");
   }
 
   function finish() {
-    window.opener.postMessage({status: "done"}, "*");
+    parent.postMessage({status: "done"}, "*");
   }
 
   navigator.serviceWorker.ready.then(function(swr) {
     my_ok(swr.scope.match(/serviceworkers\/control$/),
           "This page should be controlled by upper level registration");
     my_ok(swr.installing == undefined,
           "Upper level registration should not have a installing worker.");
     if (navigator.serviceWorker.controller) {
diff --git a/dom/workers/test/serviceworkers/test_controller.html b/dom/workers/test/serviceworkers/test_controller.html
--- a/dom/workers/test/serviceworkers/test_controller.html
+++ b/dom/workers/test/serviceworkers/test_controller.html
@@ -10,39 +10,48 @@
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
 </head>
 <body>
 <p id="display"></p>
 <div id="content" style="display: none"></div>
 <pre id="test"></pre>
 <script class="testbody" type="text/javascript">
 
+  var content;
+  var iframe;
+
   function simpleRegister() {
     // We use the control scope for the less specific registration. The window will register a worker on controller/
     return navigator.serviceWorker.register("worker.js", { scope: "./control" });
   }
 
   function testController() {
     var p = new Promise(function(resolve, reject) {
       window.onmessage = function(e) {
         if (e.data.status == "ok") {
           ok(e.data.result, e.data.message);
         } else if (e.data.status == "done") {
           window.onmessage = null;
-          w.close();
+          content.removeChild(iframe);
           resolve();
         }
       }
     });
 
-    var w = window.open("controller/index.html");
+    content = document.getElementById("content");
+    ok(content, "Parent exists.");
+
+    iframe = document.createElement("iframe");
+    iframe.setAttribute('src', "controller/index.html");
+    content.appendChild(iframe);
+
     return p;
   }
 
-  // This document just flips the prefs and opens the window for the actual test.
+  // This document just flips the prefs and opens the iframe for the actual test.
   function runTest() {
     simpleRegister()
       .then(testController)
       .then(function() {
         SimpleTest.finish();
       }).catch(function(e) {
         ok(false, "Some test failed with error " + e);
         SimpleTest.finish();

