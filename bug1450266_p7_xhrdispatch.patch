# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  e02785017b1fba0f8a2069dbcf570f78ba47f6b4
Bug 1450266 P7 Make XMLHttpRequestMainThread check for a valid inner window before dispatching events. r=baku r=smaug

diff --git a/dom/xhr/XMLHttpRequestMainThread.cpp b/dom/xhr/XMLHttpRequestMainThread.cpp
--- a/dom/xhr/XMLHttpRequestMainThread.cpp
+++ b/dom/xhr/XMLHttpRequestMainThread.cpp
@@ -1320,16 +1320,20 @@ XMLHttpRequestMainThread::DispatchProgre
 
 void
 XMLHttpRequestMainThread::DispatchOrStoreEvent(DOMEventTargetHelper* aTarget,
                                                Event* aEvent)
 {
   MOZ_ASSERT(aTarget);
   MOZ_ASSERT(aEvent);
 
+  if (NS_FAILED(CheckInnerWindowCorrectness())) {
+    return;
+  }
+
   if (mEventDispatchingSuspended) {
     PendingEvent* event = mPendingEvents.AppendElement();
     event->mTarget = aTarget;
     event->mEvent = aEvent;
     return;
   }
 
   bool dummy;
@@ -1347,16 +1351,20 @@ void
 XMLHttpRequestMainThread::ResumeEventDispatching()
 {
   MOZ_ASSERT(mEventDispatchingSuspended);
   mEventDispatchingSuspended = false;
 
   nsTArray<PendingEvent> pendingEvents;
   pendingEvents.SwapElements(mPendingEvents);
 
+  if (NS_FAILED(CheckInnerWindowCorrectness())) {
+    return;
+  }
+
   for (uint32_t i = 0; i < pendingEvents.Length(); ++i) {
     bool dummy;
     pendingEvents[i].mTarget->DispatchEvent(pendingEvents[i].mEvent, &dummy);
   }
 }
 
 already_AddRefed<nsIHttpChannel>
 XMLHttpRequestMainThread::GetCurrentHttpChannel()
