# HG changeset patch
# Parent 37052366edead1f0443ef3710fd2d1d8afb0675e
# User Ben Kelly <ben@wanderview.com>

diff --git a/dom/workers/moz.build b/dom/workers/moz.build
--- a/dom/workers/moz.build
+++ b/dom/workers/moz.build
@@ -108,15 +108,19 @@ TEST_DIRS += [
     'test/extensions/traditional',
 ]
 
 MOCHITEST_MANIFESTS += [
     'test/mochitest.ini',
     'test/serviceworkers/mochitest.ini',
 ]
 
+BROWSER_CHROME_MANIFESTS += [
+    'test/serviceworkers/browser.ini',
+]
+
 MOCHITEST_CHROME_MANIFESTS += ['test/chrome.ini']
 
 XPCSHELL_TESTS_MANIFESTS += ['test/xpcshell/xpcshell.ini']
 
 BROWSER_CHROME_MANIFESTS += ['test/browser.ini']
 
 TEST_DIRS += ['test/gtest']
diff --git a/dom/workers/test/serviceworkers/browser.ini b/dom/workers/test/serviceworkers/browser.ini
new file mode 100644
--- /dev/null
+++ b/dom/workers/test/serviceworkers/browser.ini
@@ -0,0 +1,8 @@
+[DEFAULT]
+support-files =
+  browser_base_force_refresh.html
+  browser_cached_force_refresh.html
+  browser_force_refresh_worker.js
+
+[browser_force_refresh.js]
+skip-if = e10s
diff --git a/dom/workers/test/serviceworkers/browser_base_force_refresh.html b/dom/workers/test/serviceworkers/browser_base_force_refresh.html
new file mode 100644
--- /dev/null
+++ b/dom/workers/test/serviceworkers/browser_base_force_refresh.html
@@ -0,0 +1,35 @@
+<!--
+  Any copyright is dedicated to the Public Domain.
+  http://creativecommons.org/publicdomain/zero/1.0/
+-->
+<!DOCTYPE HTML>
+<html>
+<head>
+</head>
+<body>
+<script type="text/javascript">
+addEventListener('load', function(event) {
+  navigator.serviceWorker.getRegistration('./').then(function(swr) {
+    if (swr) {
+      return;
+    }
+    return navigator.serviceWorker.register('browser_force_refresh_worker.js');
+  }).then(function(swr) {
+    if (!swr) {
+      return;
+    }
+    var custom = new Event('base-register', { bubbles: true });
+    document.dispatchEvent(custom);
+  });
+
+  navigator.serviceWorker.ready.then(function() {
+    var custom = new Event('base-sw-ready', { bubbles: true });
+    document.dispatchEvent(custom);
+  });
+
+  var custom = new Event('base-load', { bubbles: true });
+  document.dispatchEvent(custom);
+});
+</script>
+</body>
+</html>
diff --git a/dom/workers/test/serviceworkers/browser_cached_force_refresh.html b/dom/workers/test/serviceworkers/browser_cached_force_refresh.html
new file mode 100644
--- /dev/null
+++ b/dom/workers/test/serviceworkers/browser_cached_force_refresh.html
@@ -0,0 +1,17 @@
+<!--
+  Any copyright is dedicated to the Public Domain.
+  http://creativecommons.org/publicdomain/zero/1.0/
+-->
+<!DOCTYPE HTML>
+<html>
+<head>
+</head>
+<body>
+<script type="text/javascript">
+addEventListener('load', function(event) {
+  var custom = new Event('cached-load', { bubbles: true });
+  document.dispatchEvent(custom);
+});
+</script>
+</body>
+</html>
diff --git a/dom/workers/test/serviceworkers/browser_force_refresh.js b/dom/workers/test/serviceworkers/browser_force_refresh.js
new file mode 100644
--- /dev/null
+++ b/dom/workers/test/serviceworkers/browser_force_refresh.js
@@ -0,0 +1,67 @@
+/* Any copyright is dedicated to the Public Domain.
+ * http://creativecommons.org/publicdomain/zero/1.0/ */
+
+var gTestRoot = getRootDirectory(gTestPath).replace("chrome://mochitests/content/",
+                                                    "http://mochi.test:8888/")
+
+function refresh() {
+  EventUtils.synthesizeKey('R', { ctrlKey: true });
+}
+
+function forceRefresh() {
+  EventUtils.synthesizeKey('R', { ctrlKey: true, shiftKey: true });
+}
+
+function test() {
+  waitForExplicitFinish();
+  SpecialPowers.pushPrefEnv({'set': [['dom.serviceWorkers.enabled', true],
+                                     ['dom.serviceWorkers.exemptFromPerDomainMax', true],
+                                     ['dom.serviceWorkers.testing.enabled', true]]},
+                            function() {
+    var url = gTestRoot + 'browser_base_force_refresh.html';
+    var tab = gBrowser.addTab(url);
+    gBrowser.selectedTab = tab;
+
+    ok(true);
+
+    var count  = 0;
+
+    function eventHandler(event) {
+      dump("### ### got " + event.type + "\n");
+
+      if (event.type === 'base-register') {
+        refresh();
+      } else if (event.type === 'base-sw-ready') {
+        refresh();
+      } else if (event.type === 'cached-load') {
+        forceRefresh();
+      }
+
+      return;
+
+      /*
+      count += 1;
+      if (count < 3) {
+        refresh();
+        return;
+      }
+
+      gBrowser.removeTab(tab);
+      executeSoon(finish);
+      */
+    }
+
+    addEventListener('base-load', eventHandler, true, true);
+    addEventListener('base-register', eventHandler, true, true);
+    addEventListener('base-ready', eventHandler, true, true);
+    addEventListener('base-sw-ready', eventHandler, true, true);
+    addEventListener('cached-load', eventHandler, true, true);
+
+    /*
+    tab.linkedBrowser.addEventListener('load', function onLoad(event) {
+      tab.linkedBrowser.removeEventListener('load', onLoad);
+      dump("### ### " + tab.linkedBrowser.contentWindow.location.href + "\n");
+    }, true);
+    */
+  });
+}
diff --git a/dom/workers/test/serviceworkers/browser_force_refresh_worker.js b/dom/workers/test/serviceworkers/browser_force_refresh_worker.js
new file mode 100644
--- /dev/null
+++ b/dom/workers/test/serviceworkers/browser_force_refresh_worker.js
@@ -0,0 +1,24 @@
+var name = 'browserRefresherCache';
+
+self.addEventListener('install', function(event) {
+  dump("### ### got install event\n");
+  event.waitUntil(
+    Promise.all([caches.open(name),
+                 fetch('./browser_cached_force_refresh.html')]).then(function(results) {
+      var cache = results[0];
+      var response = results[1];
+      return cache.put('./browser_base_force_refresh.html', response);
+    })
+  );
+});
+
+self.addEventListener('fetch', function (event) {
+  dump("### ### got fetch event: " + event.request.url + "\n");
+  event.respondWith(
+    caches.open(name).then(function(cache) {
+      return cache.match(event.request);
+    }).then(function(response) {
+      return response || fetch(event.request);
+    })
+  );
+});
