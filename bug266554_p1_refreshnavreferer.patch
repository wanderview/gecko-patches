# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  6d4ad65b9f6ef35ee8b91b6445c1f420083e4088
Bug 266554 P1 Set the current document's URL as the referer when navigating via <meta http-equiv="refresh">. r=bz

diff --git a/docshell/base/nsDocShell.cpp b/docshell/base/nsDocShell.cpp
--- a/docshell/base/nsDocShell.cpp
+++ b/docshell/base/nsDocShell.cpp
@@ -6405,23 +6405,20 @@ nsDocShell::ForceRefreshURI(nsIURI* aURI
   if (NS_SUCCEEDED(rv) && (!equalUri) && aMetaRefresh &&
       aDelay <= REFRESH_REDIRECT_TIMER) {
     /* It is a META refresh based redirection within the threshold time
      * we have in mind (15000 ms as defined by REFRESH_REDIRECT_TIMER).
      * Pass a REPLACE flag to LoadURI().
      */
     loadInfo->SetLoadType(nsIDocShellLoadInfo::loadNormalReplace);
 
-    /* for redirects we mimic HTTP, which passes the
-     *  original referrer
-     */
-    nsCOMPtr<nsIURI> internalReferrer;
-    GetReferringURI(getter_AddRefs(internalReferrer));
-    if (internalReferrer) {
-      loadInfo->SetReferrer(internalReferrer);
+    loadInfo->SetSendReferrer(true);
+    nsCOMPtr<nsIDocument> doc = GetDocument();
+    if (doc) {
+      loadInfo->SetReferrerPolicy(doc->GetReferrerPolicy());
     }
   } else {
     loadInfo->SetLoadType(nsIDocShellLoadInfo::loadRefresh);
   }
 
   /*
    * LoadURI(...) will cancel all refresh timers... This causes the
    * Timer and its refreshData instance to be released...
