# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  7a08acc182fc8bd9da653271d994d01ed9f510d6

diff --git a/dom/serviceworkers/ServiceWorkerRegistrationImpl.cpp b/dom/serviceworkers/ServiceWorkerRegistrationImpl.cpp
--- a/dom/serviceworkers/ServiceWorkerRegistrationImpl.cpp
+++ b/dom/serviceworkers/ServiceWorkerRegistrationImpl.cpp
@@ -65,17 +65,17 @@ ServiceWorkerRegistrationMainThread::Sta
 
   RefPtr<ServiceWorkerManager> swm = ServiceWorkerManager::GetInstance();
   NS_ENSURE_TRUE_VOID(swm);
 
   mInfo = swm->GetRegistration(mDescriptor.PrincipalInfo(),
                                mDescriptor.Scope());
   NS_ENSURE_TRUE_VOID(mInfo);
 
-  mInfo->AddInstance(this);
+  mInfo->AddInstance(this, mDescriptor);
   mListeningForEvents = true;
 }
 
 void
 ServiceWorkerRegistrationMainThread::StopListeningForEvents()
 {
   MOZ_ASSERT(NS_IsMainThread());
   if (!mListeningForEvents) {
@@ -665,17 +665,17 @@ public:
 
     RefPtr<ServiceWorkerManager> swm = ServiceWorkerManager::GetInstance();
     NS_ENSURE_TRUE_VOID(swm);
 
     mInfo = swm->GetRegistration(mDescriptor.PrincipalInfo(),
                                  mDescriptor.Scope());
     NS_ENSURE_TRUE_VOID(mInfo);
 
-    mInfo->AddInstance(this);
+    mInfo->AddInstance(this, mDescriptor);
     mListeningForEvents = true;
   }
 
   void
   StopListeningForEvents()
   {
     MOZ_ASSERT(NS_IsMainThread());
 
diff --git a/dom/serviceworkers/ServiceWorkerRegistrationInfo.cpp b/dom/serviceworkers/ServiceWorkerRegistrationInfo.cpp
--- a/dom/serviceworkers/ServiceWorkerRegistrationInfo.cpp
+++ b/dom/serviceworkers/ServiceWorkerRegistrationInfo.cpp
@@ -111,20 +111,31 @@ ServiceWorkerRegistrationInfo::ServiceWo
 {}
 
 ServiceWorkerRegistrationInfo::~ServiceWorkerRegistrationInfo()
 {
   MOZ_DIAGNOSTIC_ASSERT(!IsControllingClients());
 }
 
 void
-ServiceWorkerRegistrationInfo::AddInstance(ServiceWorkerRegistrationListener* aInstance)
+ServiceWorkerRegistrationInfo::AddInstance(ServiceWorkerRegistrationListener* aInstance,
+                                           const ServiceWorkerRegistrationDescriptor& aDescriptor)
 {
   MOZ_DIAGNOSTIC_ASSERT(aInstance);
   MOZ_ASSERT(!mInstanceList.Contains(aInstance));
+  MOZ_DIAGNOSTIC_ASSERT(aDescriptor.Id() == mDescriptor.Id());
+  MOZ_DIAGNOSTIC_ASSERT(aDescriptor.PrincipalInfo() == mDescriptor.PrincipalInfo());
+  MOZ_DIAGNOSTIC_ASSERT(aDescriptor.Scope() == mDescriptor.Scope());
+  MOZ_DIAGNOSTIC_ASSERT(aDescriptor.Version() <= mDescriptor.Version());
+  for (auto& entry : mVersionList) {
+    if (aDescriptor.Version() > entry->mDescriptor.Version()) {
+      continue;
+    }
+    aInstance->UpdateState(entry->mDescriptor);
+  }
   mInstanceList.AppendElement(aInstance);
 }
 
 void
 ServiceWorkerRegistrationInfo::RemoveInstance(ServiceWorkerRegistrationListener* aInstance)
 {
   MOZ_DIAGNOSTIC_ASSERT(aInstance);
   DebugOnly<bool> removed = mInstanceList.RemoveElement(aInstance);
@@ -433,16 +444,28 @@ ServiceWorkerRegistrationInfo::UpdateReg
   UpdateRegistrationState(mDescriptor.UpdateViaCache());
 }
 
 void
 ServiceWorkerRegistrationInfo::UpdateRegistrationState(ServiceWorkerUpdateViaCache aUpdateViaCache)
 {
   MOZ_ASSERT(NS_IsMainThread());
 
+  TimeStamp oldest = TimeStamp::Now() - TimeDuration::FromSeconds(30);
+  if (!mVersionList.IsEmpty() && mVersionList[0]->mTimeStamp < oldest) {
+    nsTArray<UniquePtr<VersionEntry>> list;
+    mVersionList.SwapElements(list);
+    for (auto& entry : list) {
+      if (entry->mTimeStamp >= oldest) {
+        mVersionList.AppendElement(std::move(entry));
+      }
+    }
+  }
+  mVersionList.AppendElement(MakeUnique<VersionEntry>(mDescriptor));
+
   // We are going to modify the descriptor, so increase its version number.
   mDescriptor.SetVersion(GetNextVersion());
 
   // Note, this also sets the new version number on the ServiceWorkerInfo
   // objects before we copy over their updated descriptors.
   mDescriptor.SetWorkers(mInstallingWorker, mWaitingWorker, mActiveWorker);
 
   mDescriptor.SetUpdateViaCache(aUpdateViaCache);
diff --git a/dom/serviceworkers/ServiceWorkerRegistrationInfo.h b/dom/serviceworkers/ServiceWorkerRegistrationInfo.h
--- a/dom/serviceworkers/ServiceWorkerRegistrationInfo.h
+++ b/dom/serviceworkers/ServiceWorkerRegistrationInfo.h
@@ -21,16 +21,29 @@ class ServiceWorkerRegistrationListener;
 class ServiceWorkerRegistrationInfo final
   : public nsIServiceWorkerRegistrationInfo
 {
   nsCOMPtr<nsIPrincipal> mPrincipal;
   ServiceWorkerRegistrationDescriptor mDescriptor;
   nsTArray<nsCOMPtr<nsIServiceWorkerRegistrationInfoListener>> mListeners;
   nsTObserverArray<ServiceWorkerRegistrationListener*> mInstanceList;
 
+  struct VersionEntry
+  {
+    const ServiceWorkerRegistrationDescriptor mDescriptor;
+    TimeStamp mTimeStamp;
+
+    explicit VersionEntry(const ServiceWorkerRegistrationDescriptor& aDescriptor)
+      : mDescriptor(aDescriptor)
+      , mTimeStamp(TimeStamp::Now())
+    {
+    }
+  };
+  nsTArray<UniquePtr<VersionEntry>> mVersionList;
+
   uint32_t mControlledClientsCounter;
   uint32_t mDelayMultiplier;
 
   enum
   {
     NoUpdate,
     NeedTimeCheckAndUpdate,
     NeedUpdate
@@ -60,17 +73,18 @@ public:
   NS_DECL_ISUPPORTS
   NS_DECL_NSISERVICEWORKERREGISTRATIONINFO
 
   ServiceWorkerRegistrationInfo(const nsACString& aScope,
                                 nsIPrincipal* aPrincipal,
                                 ServiceWorkerUpdateViaCache aUpdateViaCache);
 
   void
-  AddInstance(ServiceWorkerRegistrationListener* aInstance);
+  AddInstance(ServiceWorkerRegistrationListener* aInstance,
+              const ServiceWorkerRegistrationDescriptor& aDescriptor);
 
   void
   RemoveInstance(ServiceWorkerRegistrationListener* aInstance);
 
   const nsCString&
   Scope() const;
 
   nsIPrincipal*
diff --git a/dom/serviceworkers/ServiceWorkerRegistrationProxy.cpp b/dom/serviceworkers/ServiceWorkerRegistrationProxy.cpp
--- a/dom/serviceworkers/ServiceWorkerRegistrationProxy.cpp
+++ b/dom/serviceworkers/ServiceWorkerRegistrationProxy.cpp
@@ -68,17 +68,17 @@ ServiceWorkerRegistrationProxy::InitOnMa
     swm->GetRegistration(mDescriptor.PrincipalInfo(), mDescriptor.Scope());
   NS_ENSURE_TRUE_VOID(reg);
 
   scopeExit.release();
 
   mReg = new nsMainThreadPtrHolder<ServiceWorkerRegistrationInfo>(
     "ServiceWorkerRegistrationProxy::mInfo", reg);
 
-  mReg->AddInstance(this);
+  mReg->AddInstance(this, mDescriptor);
 
   // Currently the spec only sets an installing worker in step 3 of the Install
   // algorithm:
   //
   //  https://w3c.github.io/ServiceWorker/#installation-algorithm
   //
   // In step 7 it then queues a task to dispatch an "updatefound" event.
   //
