# HG changeset patch
# Parent 3c26bef95d54870e5891b43b5fdbfabd1c8b026e
# User Ben Kelly <ben@wanderview.com>
Bug 1174768 Cache should check if QuotaManager is shutting down before calling GetOrCreate. r=janv


diff --git a/dom/cache/Context.cpp b/dom/cache/Context.cpp
--- a/dom/cache/Context.cpp
+++ b/dom/cache/Context.cpp
@@ -304,17 +304,17 @@ Context::QuotaInitRunnable::Run()
   nsRefPtr<SyncResolver> resolver = new SyncResolver();
 
   switch(mState) {
     // -----------------------------------
     case STATE_CALL_WAIT_FOR_OPEN_ALLOWED:
     {
       MOZ_ASSERT(NS_IsMainThread());
 
-      if (mCanceled) {
+      if (mCanceled || QuotaManager::IsShuttingDown()) {
         resolver->Resolve(NS_ERROR_ABORT);
         break;
       }
 
       QuotaManager* qm = QuotaManager::GetOrCreate();
       if (!qm) {
         resolver->Resolve(NS_ERROR_FAILURE);
         break;
