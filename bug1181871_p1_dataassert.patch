# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent 88d974e827676d68a526008812b4ca8f9e028887
Bug 1181871 P1 Only enforce Cache Context shared data destruction on target thread after init. r=ehsan

diff --git a/dom/cache/Context.cpp b/dom/cache/Context.cpp
--- a/dom/cache/Context.cpp
+++ b/dom/cache/Context.cpp
@@ -78,19 +78,19 @@ public:
     MOZ_ASSERT(mConnection);
   }
 
 private:
   ~Data()
   {
     // We could proxy release our data here, but instead just assert.  The
     // Context code should guarantee that we are destroyed on the target
-    // thread.  If we're not, then QuotaManager might race and try to clear the
-    // origin out from under us.
-    MOZ_ASSERT(mTarget == NS_GetCurrentThread());
+    // thread once the connection is initialized.  If we're not, then
+    // QuotaManager might race and try to clear the origin out from under us.
+    MOZ_ASSERT_IF(mConnection, mTarget == NS_GetCurrentThread());
   }
 
   nsCOMPtr<nsIThread> mTarget;
   nsCOMPtr<mozIStorageConnection> mConnection;
 
   // Threadsafe counting because we're created on the PBackground thread
   // and destroyed on the target IO thread.
   NS_INLINE_DECL_THREADSAFE_REFCOUNTING(Context::Data)
