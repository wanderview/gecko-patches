# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  ba28ea05cee3934e21a68afbb9c60ae0ad129588
Bug 1284621 P2 Make osfile_async_front.jsm explicitly terminate its worker. r=yoric

diff --git a/toolkit/components/osfile/modules/osfile_async_front.jsm b/toolkit/components/osfile/modules/osfile_async_front.jsm
--- a/toolkit/components/osfile/modules/osfile_async_front.jsm
+++ b/toolkit/components/osfile/modules/osfile_async_front.jsm
@@ -291,16 +291,19 @@ var Scheduler = this.Scheduler = {
       try {
         // Enter critical section: no yield in this block
         // (we want to make sure that we remain the only
         // request in the queue).
 
         if (!this.launched || this.shutdown || !this._worker) {
           // Nothing to kill
           this.shutdown = this.shutdown || shutdown;
+          if (this._worker) {
+            this._worker.terminate();
+          }
           this._worker = null;
           return null;
         }
 
         // Exit critical section
 
         let message = ["Meta_shutdown", [reset]];
 
@@ -341,16 +344,19 @@ var Scheduler = this.Scheduler = {
               openedDirectoryIterators.join("\n");
           }
 
           LOG("WARNING: File descriptors leaks detected.\n" + msg);
         }
 
         // Make sure that we do not leave an invalid |worker| around.
         if (killed || shutdown) {
+          if (this._worker) {
+            this._worker.terminate();
+          }
           this._worker = null;
         }
 
         this.shutdown = shutdown;
 
         return resources;
 
       } finally {
