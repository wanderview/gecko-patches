# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  a77b73c7723e1060993045fb31eb2f0a30473486
Bug 1237455 P1 Make file_CrossSiteXHR_server.sjs check headers on redirects. r=ehsan

diff --git a/dom/security/test/cors/file_CrossSiteXHR_server.sjs b/dom/security/test/cors/file_CrossSiteXHR_server.sjs
--- a/dom/security/test/cors/file_CrossSiteXHR_server.sjs
+++ b/dom/security/test/cors/file_CrossSiteXHR_server.sjs
@@ -47,20 +47,23 @@ function handleRequest(request, response
     return;
   }
 
   if (!isPreflight && "headers" in query) {
     headers = eval(query.headers);
     for(headerName in headers) {
       // Content-Type is changed if there was a body 
       if (!(headerName == "Content-Type" && body) &&
-          request.getHeader(headerName) != headers[headerName]) {
+          (!request.hasHeader(headerName) ||
+          request.getHeader(headerName) != headers[headerName])) {
+        var actual = request.hasHeader(headerName) ? request.getHeader(headerName)
+                                                   : "<missing header>";
         sendHttp500(response,
           "Header " + headerName + " had wrong value. Expected " +
-          headers[headerName] + " got " + request.getHeader(headerName));
+          headers[headerName] + " got " + actual);
         return;
       }
     }
   }
 
   if (isPreflight && "requestHeaders" in query &&
       request.getHeader("Access-Control-Request-Headers") != query.requestHeaders) {
     sendHttp500(response,
@@ -146,16 +149,19 @@ function handleRequest(request, response
     if (query.exposeHeaders)
       response.setHeader("Access-Control-Expose-Headers", query.exposeHeaders);
   }
 
   if (!isPreflight && query.hop && query.hop < hops.length) {
     newURL = hops[query.hop].server +
              "/tests/dom/security/test/cors/file_CrossSiteXHR_server.sjs?" +
              "hop=" + (query.hop + 1) + "&hops=" + escape(query.hops);
+    if ("headers" in query) {
+      newURL += "&headers=" + escape(query.headers);
+    }
     response.setStatusLine(null, 307, "redirect");
     response.setHeader("Location", newURL);
 
     return;
   }
 
   // Send response body
   if (!isPreflight && request.method != "HEAD") {
