# HG changeset patch
# Parent 2bc85f95bca57076086b6280d9d4f21168d06c4b
# User Ben Kelly <ben@wanderview.com>
Bug 1157619 P2 Test that service worker is not intercepted on force refresh. r=ehsan

diff --git a/dom/workers/test/serviceworkers/force_refresh_worker.js b/dom/workers/test/serviceworkers/force_refresh_worker.js
new file mode 100644
--- /dev/null
+++ b/dom/workers/test/serviceworkers/force_refresh_worker.js
@@ -0,0 +1,25 @@
+var name = 'refresherCache';
+
+self.addEventListener('install', function(event) {
+  event.waitUntil(
+    Promise.all([caches.open(name),
+                 fetch('./sw_clients/refresher_cached.html'),
+                 fetch('./sw_clients/refresher_cached_compressed.html')]).then(function(results) {
+      var cache = results[0];
+      var response = results[1];
+      var compressed = results[2];
+      return Promise.all([cache.put('./sw_clients/refresher.html', response),
+                          cache.put('./sw_clients/refresher_compressed.html', compressed)]);
+    })
+  );
+});
+
+self.addEventListener('fetch', function (event) {
+  event.respondWith(
+    caches.open(name).then(function(cache) {
+      return cache.match(event.request);
+    }).then(function(response) {
+      return response || fetch(event.request);
+    })
+  );
+});
diff --git a/dom/workers/test/serviceworkers/mochitest.ini b/dom/workers/test/serviceworkers/mochitest.ini
--- a/dom/workers/test/serviceworkers/mochitest.ini
+++ b/dom/workers/test/serviceworkers/mochitest.ini
@@ -93,16 +93,23 @@ support-files =
   swa/worker_scope_too_narrow.js
   swa/worker_scope_too_narrow.js^headers^
   claim_oninstall_worker.js
   claim_worker_1.js
   claim_worker_2.js
   claim_clients/client.html
   claim_fetch_worker.js
   app-protocol/*
+  force_refresh_worker.js
+  sw_clients/refresher.html
+  sw_clients/refresher_compressed.html
+  sw_clients/refresher_compressed.html^headers^
+  sw_clients/refresher_cached.html
+  sw_clients/refresher_cached_compressed.html
+  sw_clients/refresher_cached_compressed.html^headers^
 
 [test_unregister.html]
 [test_installation_simple.html]
 [test_fetch_event.html]
 [test_https_fetch.html]
 [test_https_fetch_cloned_response.html]
 [test_https_synth_fetch_from_cached_sw.html]
 [test_match_all.html]
@@ -132,8 +139,9 @@ support-files =
 [test_claim_oninstall.html]
 [test_claim.html]
 [test_periodic_https_update.html]
 [test_sanitize.html]
 [test_sanitize_domain.html]
 [test_service_worker_allowed.html]
 [test_app_protocol.html]
 [test_claim_fetch.html]
+[test_force_refresh.html]
diff --git a/dom/workers/test/serviceworkers/sw_clients/refresher.html b/dom/workers/test/serviceworkers/sw_clients/refresher.html
new file mode 100644
--- /dev/null
+++ b/dom/workers/test/serviceworkers/sw_clients/refresher.html
@@ -0,0 +1,38 @@
+<!--
+  Any copyright is dedicated to the Public Domain.
+  http://creativecommons.org/publicdomain/zero/1.0/
+-->
+<!DOCTYPE HTML>
+<html>
+<head>
+  <title>Bug 982726 - test match_all not crashing</title>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<p id="display"></p>
+<div id="content" style="display: none"></div>
+<pre id="test"></pre>
+<script class="testbody" type="text/javascript">
+
+  if (!parent) {
+    info("sw_clients/simple.html shouldn't be launched directly!");
+  }
+
+  window.addEventListener("message", function(event) {
+    if (event.data === "REFRESH") {
+      window.location.reload();
+    } else if (event.data === "FORCE_REFRESH") {
+      window.location.reload(true);
+    }
+  });
+
+  navigator.serviceWorker.ready.then(function() {
+    parent.postMessage("READY", "*");
+  });
+
+</script>
+</pre>
+</body>
+</html>
+
diff --git a/dom/workers/test/serviceworkers/sw_clients/refresher_cached.html b/dom/workers/test/serviceworkers/sw_clients/refresher_cached.html
new file mode 100644
--- /dev/null
+++ b/dom/workers/test/serviceworkers/sw_clients/refresher_cached.html
@@ -0,0 +1,38 @@
+<!--
+  Any copyright is dedicated to the Public Domain.
+  http://creativecommons.org/publicdomain/zero/1.0/
+-->
+<!DOCTYPE HTML>
+<html>
+<head>
+  <title>Bug 982726 - test match_all not crashing</title>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<p id="display"></p>
+<div id="content" style="display: none"></div>
+<pre id="test"></pre>
+<script class="testbody" type="text/javascript">
+
+  if (!parent) {
+    info("sw_clients/simple.html shouldn't be launched directly!");
+  }
+
+  window.addEventListener("message", function(event) {
+    if (event.data === "REFRESH") {
+      window.location.reload();
+    } else if (event.data === "FORCE_REFRESH") {
+      window.location.reload(true);
+    }
+  });
+
+  navigator.serviceWorker.ready.then(function() {
+    parent.postMessage("READY_CACHED", "*");
+  });
+
+</script>
+</pre>
+</body>
+</html>
+
diff --git a/dom/workers/test/serviceworkers/sw_clients/refresher_cached_compressed.html b/dom/workers/test/serviceworkers/sw_clients/refresher_cached_compressed.html
new file mode 100644
index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..55e97ac24766f5162f483e0bf707a7ca86db7a8c
GIT binary patch
literal 559
zc$@(*0?_>*iwFQ|+h|n)1C3KnPa821z2{d<eCbj(>y|@5Xf_f}f;fOcfK+jcj6KO3
z9D8L?mTs&5_l|c7<v^vL?0x&@J-_jII-X2M0LQ)q9hxrMO-*1E7&KNZLIV_lYJ|((
zowFJiVXLe!xuhm)j-=EP71<Vb*lvSQWr!Qu^jy<Z<xh-3ekk9|(PT0kO~;Fi`OWR+
z5>9W<&-lBht;-84Gh@{$S#mi0w%fp$&xfB5Kf(kE6Tw!Iu2;%A@PR-_m1^rZQ#tT+
zWzx|$1k^QH3Bn&F?^UY?R6vTl5;99Ad2P3i!yDee*p~N6%%*bS_kzy)2Z-n@k*IT+
zYD5-#p|4XCP)A(9rksJYXGqQ`hk(<&U^-qJu%;5mrpBo*+cpdu+xD;yp3vtrXWM7m
z5hwSU$xO@|5qo+z>LnugVc!MqR7%6YY$^WHmf47d+BFp8Mn(2KfL{zS<kz7P>2al<
zWjM*y2P^Y!L8`;f8UKdh4#BCN*EP?Hu@N=7ZY&PIvc~VM{Aj%ikEJqZ*|N-;O&knk
zA-0&3+Msv`Yc3}ne1Yvte?C$Vltz()s;WR-El;kN*Qa97d6sv9CzT~izN?^2(fjiW
z0A0dYrA{uc=F8Q83sT(SUNlGJJuhChcB3f7GGT13#_u6MVB{iYx{}|FFP_8gEru?a
xO-OV;w4mTz$BWz5{CIx4TyR6g+ouL*m%sD4zhC(@L2`IFqd(F8Fo(ed002Hz5xD>W

diff --git a/dom/workers/test/serviceworkers/sw_clients/refresher_cached_compressed.html^headers^ b/dom/workers/test/serviceworkers/sw_clients/refresher_cached_compressed.html^headers^
new file mode 100644
--- /dev/null
+++ b/dom/workers/test/serviceworkers/sw_clients/refresher_cached_compressed.html^headers^
@@ -0,0 +1,2 @@
+Content-Type: text/html
+Content-Encoding: gzip
diff --git a/dom/workers/test/serviceworkers/sw_clients/refresher_compressed.html b/dom/workers/test/serviceworkers/sw_clients/refresher_compressed.html
new file mode 100644
index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..3cf1f6a4fbf4f39ded4568d475792bf44d4566f1
GIT binary patch
literal 553
zc$@(#0@nQ>iwFQ#+h|n)1C5hSPuwsNhVT0;W_@X>x^c^)A9S-4g+&}dparSogp57A
zF*tT)&xWQ||9i&?OF2-fCp(jOp7A>#&!@B51mMv3phMe7yQv9m0)xhCMQDHmP>pc8
zy>nK>acGqFC8yLx?SYg!q9WU&4owq$Dns1JcF>wZDt}@O@<aJvPG+;kWIjE<IJ&;M
zT*B$~`5AxL)VRE$G7F~8$&$mxx9tYLeBS@G{}E<Dm<Sq0y1rG;fe!>as#IIQnafe1
zGn0<CC7`~=N)Y}ad9OM(Mg^p(D<Lx~$t&Bm4zGFtVq4xPv6#zIKLDNe4-nB+B2n)!
z)rbsw!PhAXs3WdlBj-RlC?xxnqrv%IFg-6VSW^jOQ|nZp%eEXewj07actW4goXbAT
z4%oTJEM{S5L>%O~(13{Chg}!6Qz?!Aa!K)zwk#%W)UKhJwkmSXJ@~}|4*7K`M0&i{
z&T=@(G#D%MZ9%HT)*1hX;10p5t=BcriLntixqd44zB1!?CO=wl!egn7S$2#$vx$vi
zEJTATsSS#Eu;z5K!57%Qtj|Xp0;N%;psFemtL4dRd37pwnrFNVJgJN*`L2R8#ZaG5
z0O%6FiaNPi9W8JF8%S}BJ7~7XdtSWi>_$<DWy085jo(9jz{p9;^d-L;Up$-Jl^DBR
rwjt5^*n)z69Uk9sC&b&Q&Sm`HLEK%ed>S1&zL?1$UkUjix&r_J05%R(

diff --git a/dom/workers/test/serviceworkers/sw_clients/refresher_compressed.html^headers^ b/dom/workers/test/serviceworkers/sw_clients/refresher_compressed.html^headers^
new file mode 100644
--- /dev/null
+++ b/dom/workers/test/serviceworkers/sw_clients/refresher_compressed.html^headers^
@@ -0,0 +1,2 @@
+Content-Type: text/html
+Content-Encoding: gzip
diff --git a/dom/workers/test/serviceworkers/test_force_refresh.html b/dom/workers/test/serviceworkers/test_force_refresh.html
new file mode 100644
--- /dev/null
+++ b/dom/workers/test/serviceworkers/test_force_refresh.html
@@ -0,0 +1,83 @@
+<!--
+  Any copyright is dedicated to the Public Domain.
+  http://creativecommons.org/publicdomain/zero/1.0/
+-->
+<!DOCTYPE HTML>
+<html>
+<head>
+  <title>Bug 982726 - Test service worker post message </title>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<p id="display"></p>
+<div id="content" style="display: none"></div>
+<pre id="test"></pre>
+<script class="testbody" type="text/javascript">
+  var registration;
+  function start() {
+    return navigator.serviceWorker.register("force_refresh_worker.js",
+                                            { scope: "./sw_clients/" })
+      .then((swr) => registration = swr);
+  }
+
+  function unregister() {
+    return registration.unregister().then(function(result) {
+      ok(result, "Unregister should return true.");
+    }, function(e) {
+      dump("Unregistering the SW failed with " + e + "\n");
+    });
+  }
+
+
+  function testForceRefresh(swr) {
+    var p = new Promise(function(res, rej) {
+      var count = 0;
+      var cachedCount = 0;
+      window.onmessage = function(e) {
+        if (e.data === "READY") {
+          count += 1;
+          if (count == 2) {
+            is(cachedCount, 1, "should have received cached message before " +
+                               "second non-cached message");
+            res();
+          }
+          iframe.contentWindow.postMessage("REFRESH", "*");
+        } else if (e.data === "READY_CACHED") {
+          cachedCount += 1;
+          is(count, 1, "should have received non-cached message before " +
+                       "cached message");
+          iframe.contentWindow.postMessage("FORCE_REFRESH", "*");
+        }
+      }
+    });
+
+    var content = document.getElementById("content");
+    ok(content, "Parent exists.");
+
+    iframe = document.createElement("iframe");
+    iframe.setAttribute('src', "sw_clients/refresher_compressed.html");
+    content.appendChild(iframe);
+
+    return p.then(() => content.removeChild(iframe));
+  }
+
+  function runTest() {
+    start()
+      .then(testForceRefresh)
+      .then(unregister)
+      .catch(function(e) {
+        ok(false, "Some test failed with error " + e);
+      }).then(SimpleTest.finish);
+  }
+
+  SimpleTest.waitForExplicitFinish();
+  SpecialPowers.pushPrefEnv({"set": [
+    ["dom.serviceWorkers.exemptFromPerDomainMax", true],
+    ["dom.serviceWorkers.enabled", true],
+    ["dom.serviceWorkers.testing.enabled", true]
+  ]}, runTest);
+</script>
+</pre>
+</body>
+</html>
