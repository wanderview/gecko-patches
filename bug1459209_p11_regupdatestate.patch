# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  c553e288640793d8ea26a8c7997ab36ccd699738
Bug 1459209 P11 Propogate registration state changes back from the parent to the child. r=mrbkap

diff --git a/dom/serviceworkers/PServiceWorkerRegistration.ipdl b/dom/serviceworkers/PServiceWorkerRegistration.ipdl
--- a/dom/serviceworkers/PServiceWorkerRegistration.ipdl
+++ b/dom/serviceworkers/PServiceWorkerRegistration.ipdl
@@ -16,12 +16,14 @@ protocol PServiceWorkerRegistration
 parent:
   async Teardown();
 
   async Unregister() returns (bool aSuccess, CopyableErrorResult aRv);
   async Update() returns (IPCServiceWorkerRegistrationDescriptorOrCopyableErrorResult aResult);
 
 child:
   async __delete__();
+
+  async UpdateState(IPCServiceWorkerRegistrationDescriptor aDescriptor);
 };
 
 } // namespace dom
 } // namespace mozilla
diff --git a/dom/serviceworkers/RemoteServiceWorkerRegistrationImpl.cpp b/dom/serviceworkers/RemoteServiceWorkerRegistrationImpl.cpp
--- a/dom/serviceworkers/RemoteServiceWorkerRegistrationImpl.cpp
+++ b/dom/serviceworkers/RemoteServiceWorkerRegistrationImpl.cpp
@@ -156,10 +156,18 @@ RemoteServiceWorkerRegistrationImpl::Rev
 
   mShutdown = true;
 
   if (mOuter) {
     mOuter->RegistrationRemoved();
   }
 }
 
+void
+RemoteServiceWorkerRegistrationImpl::UpdateState(const ServiceWorkerRegistrationDescriptor& aDescriptor)
+{
+  if (mOuter) {
+    mOuter->UpdateState(aDescriptor);
+  }
+}
+
 } // namespace dom
 } // namespace mozilla
diff --git a/dom/serviceworkers/RemoteServiceWorkerRegistrationImpl.h b/dom/serviceworkers/RemoteServiceWorkerRegistrationImpl.h
--- a/dom/serviceworkers/RemoteServiceWorkerRegistrationImpl.h
+++ b/dom/serviceworkers/RemoteServiceWorkerRegistrationImpl.h
@@ -41,15 +41,18 @@ class RemoteServiceWorkerRegistrationImp
              ServiceWorkerFailureCallback&& aFailureCB) override;
 
 public:
   explicit RemoteServiceWorkerRegistrationImpl(const ServiceWorkerRegistrationDescriptor& aDescriptor);
 
   void
   RevokeActor(ServiceWorkerRegistrationChild* aActor);
 
+  void
+  UpdateState(const ServiceWorkerRegistrationDescriptor& aDescriptor);
+
   NS_INLINE_DECL_REFCOUNTING(RemoteServiceWorkerRegistrationImpl, override)
 };
 
 } // namespace dom
 } // namespace mozilla
 
 #endif // mozilla_dom_remoteserviceworkerregistrationimpl_h__
diff --git a/dom/serviceworkers/ServiceWorkerRegistrationChild.cpp b/dom/serviceworkers/ServiceWorkerRegistrationChild.cpp
--- a/dom/serviceworkers/ServiceWorkerRegistrationChild.cpp
+++ b/dom/serviceworkers/ServiceWorkerRegistrationChild.cpp
@@ -6,30 +6,41 @@
 
 #include "ServiceWorkerRegistrationChild.h"
 
 #include "RemoteServiceWorkerRegistrationImpl.h"
 
 namespace mozilla {
 namespace dom {
 
+using mozilla::ipc::IPCResult;
+
 void
 ServiceWorkerRegistrationChild::ActorDestroy(ActorDestroyReason aReason)
 {
   if (mWorkerHolderToken) {
     mWorkerHolderToken->RemoveListener(this);
     mWorkerHolderToken = nullptr;
   }
 
   if (mOwner) {
     mOwner->RevokeActor(this);
     MOZ_DIAGNOSTIC_ASSERT(!mOwner);
   }
 }
 
+IPCResult
+ServiceWorkerRegistrationChild::RecvUpdateState(const IPCServiceWorkerRegistrationDescriptor& aDescriptor)
+{
+  if (mOwner) {
+    mOwner->UpdateState(ServiceWorkerRegistrationDescriptor(aDescriptor));
+  }
+  return IPC_OK();
+}
+
 void
 ServiceWorkerRegistrationChild::WorkerShuttingDown()
 {
   MaybeStartTeardown();
 }
 
 ServiceWorkerRegistrationChild::ServiceWorkerRegistrationChild(WorkerHolderToken* aWorkerHolderToken)
   : mWorkerHolderToken(aWorkerHolderToken)
diff --git a/dom/serviceworkers/ServiceWorkerRegistrationChild.h b/dom/serviceworkers/ServiceWorkerRegistrationChild.h
--- a/dom/serviceworkers/ServiceWorkerRegistrationChild.h
+++ b/dom/serviceworkers/ServiceWorkerRegistrationChild.h
@@ -21,16 +21,19 @@ class ServiceWorkerRegistrationChild fin
   RefPtr<WorkerHolderToken> mWorkerHolderToken;
   RemoteServiceWorkerRegistrationImpl* mOwner;
   bool mTeardownStarted;
 
   // PServiceWorkerRegistrationChild
   void
   ActorDestroy(ActorDestroyReason aReason) override;
 
+  mozilla::ipc::IPCResult
+  RecvUpdateState(const IPCServiceWorkerRegistrationDescriptor& aDescriptor) override;
+
   // WorkerHolderToken::Listener
   void
   WorkerShuttingDown() override;
 
 public:
   explicit ServiceWorkerRegistrationChild(WorkerHolderToken* aWorkerHolderToken);
   ~ServiceWorkerRegistrationChild() = default;
 
diff --git a/dom/serviceworkers/ServiceWorkerRegistrationProxy.cpp b/dom/serviceworkers/ServiceWorkerRegistrationProxy.cpp
--- a/dom/serviceworkers/ServiceWorkerRegistrationProxy.cpp
+++ b/dom/serviceworkers/ServiceWorkerRegistrationProxy.cpp
@@ -34,17 +34,17 @@ ServiceWorkerRegistrationProxy::MaybeShu
 
 void
 ServiceWorkerRegistrationProxy::UpdateStateOnBGThread(const ServiceWorkerRegistrationDescriptor& aDescriptor)
 {
   AssertIsOnBackgroundThread();
   if (!mActor) {
     return;
   }
-  // TODO: send update
+  Unused << mActor->SendUpdateState(aDescriptor.ToIPC());
 }
 
 void
 ServiceWorkerRegistrationProxy::InitOnMainThread()
 {
   AssertIsOnMainThread();
 
   auto scopeExit = MakeScopeExit([&] {
