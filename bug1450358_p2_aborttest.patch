# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  5a3385b05ab954ecef9d3300ec1d32ac925f275e
Bug 1450458 P2 Test AbortSignal for event listener related runtime leaks. r=baku

diff --git a/dom/abort/tests/mochitest.ini b/dom/abort/tests/mochitest.ini
--- a/dom/abort/tests/mochitest.ini
+++ b/dom/abort/tests/mochitest.ini
@@ -1,7 +1,9 @@
 [DEFAULT]
 support-files =
   worker_abort_controller_fetch.js
   slow.sjs
+  !/dom/events/test/event_leak_utils.js
 
 [test_abort_controller.html]
 [test_abort_controller_fetch.html]
+[test_event_listener_leaks.html]
diff --git a/dom/abort/tests/test_event_listener_leaks.html b/dom/abort/tests/test_event_listener_leaks.html
new file mode 100644
--- /dev/null
+++ b/dom/abort/tests/test_event_listener_leaks.html
@@ -0,0 +1,43 @@
+<!--
+  Any copyright is dedicated to the Public Domain.
+  http://creativecommons.org/publicdomain/zero/1.0/
+-->
+<!DOCTYPE HTML>
+<html>
+<head>
+  <title>Bug 1450271 - Test AbortSignal event listener leak conditions</title>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="text/javascript" src="/tests/dom/events/test/event_leak_utils.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<p id="display"></p>
+<script class="testbody" type="text/javascript">
+// Manipulate AbortSignal.  Its important here that we create a
+// listener callback from the DOM objects back to the frame's global
+// in order to exercise the leak condition.
+async function useAbortSignal(contentWindow) {
+  let controller = new contentWindow.AbortController();
+  let signal = controller.signal;
+  signal.onabort = _ => {
+    contentWindow.abortCount += 1;
+  };
+}
+
+async function runTest() {
+  try {
+    await checkForEventListenerLeaks("AbortSignal", useAbortSignal);
+  } catch (e) {
+    ok(false, e);
+  } finally {
+    SimpleTest.finish();
+  }
+}
+
+SimpleTest.waitForExplicitFinish();
+addEventListener("load", runTest, { once: true });
+</script>
+</pre>
+</body>
+</html>
+
