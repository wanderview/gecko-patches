# HG changeset patch
# Parent 7590d15a3ad90ae9fc90f72be1e1846656e9a733
# User Ben Kelly <ben@wanderview.com>
Bug 1175138 P6 Add a simple test to verify CacheStorage rejects in http origin. r=ehsan


diff --git a/dom/cache/test/mochitest/mochitest.ini b/dom/cache/test/mochitest/mochitest.ini
--- a/dom/cache/test/mochitest/mochitest.ini
+++ b/dom/cache/test/mochitest/mochitest.ini
@@ -37,8 +37,9 @@ support-files =
 [test_cache_delete.html]
 [test_cache_put_reorder.html]
 [test_cache_https.html]
   skip-if = buildapp == 'b2g' # bug 1162353
 [test_cache_restart.html]
 [test_cache_shrink.html]
 [test_cache_orphaned_cache.html]
 [test_cache_orphaned_body.html]
+[test_cache_untrusted.html]
diff --git a/dom/cache/test/mochitest/test_cache_untrusted.html b/dom/cache/test/mochitest/test_cache_untrusted.html
new file mode 100644
--- /dev/null
+++ b/dom/cache/test/mochitest/test_cache_untrusted.html
@@ -0,0 +1,40 @@
+<!-- Any copyright is dedicated to the Public Domain.
+   - http://creativecommons.org/publicdomain/zero/1.0/ -->
+<!DOCTYPE HTML>
+<html>
+<head>
+  <title>Test Cache with QuotaManager Restart</title>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="text/javascript" src="large_url_list.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<script class="testbody" type="text/javascript">
+function setupTestIframe() {
+  return new Promise(function(resolve) {
+    var iframe = document.createElement("iframe");
+    iframe.src = "empty.html";
+    iframe.onload = function() {
+      window.caches = iframe.contentWindow.caches;
+      resolve();
+    };
+    document.body.appendChild(iframe);
+  });
+}
+
+SimpleTest.waitForExplicitFinish();
+SpecialPowers.pushPrefEnv({
+  "set": [["dom.caches.enabled", true]],
+}, function() {
+  setupTestIframe().then(function() {
+    return caches.open('foo');
+  }).then(function(usage) {
+    ok(false, 'caches should not be usable in untrusted http origin');
+  }).catch(function(err) {
+    is(err.name, 'SecurityError', 'caches should reject with SecurityError');
+    SimpleTest.finish();
+  });
+});
+</script>
+</body>
+</html>
