# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  fba4b0cd3823975949765acc0b16b964d1712b75
Bug 1182094 Fix wpt sandboxed-iframes.https.html test to expect rejected promises. r=jgraham

diff --git a/testing/web-platform/meta/service-workers/cache-storage/window/__dir__.ini b/testing/web-platform/meta/service-workers/cache-storage/window/__dir__.ini
new file mode 100644
--- /dev/null
+++ b/testing/web-platform/meta/service-workers/cache-storage/window/__dir__.ini
@@ -0,0 +1,1 @@
+prefs: [dom.caches.enabled:true]
diff --git a/testing/web-platform/meta/service-workers/cache-storage/window/cache-add.https.html.ini b/testing/web-platform/meta/service-workers/cache-storage/window/cache-add.https.html.ini
deleted file mode 100644
--- a/testing/web-platform/meta/service-workers/cache-storage/window/cache-add.https.html.ini
+++ /dev/null
@@ -1,3 +0,0 @@
-[cache-add.https.html]
-  type: testharness
-  prefs: [dom.caches.enabled:true]
diff --git a/testing/web-platform/meta/service-workers/cache-storage/window/cache-delete.https.html.ini b/testing/web-platform/meta/service-workers/cache-storage/window/cache-delete.https.html.ini
deleted file mode 100644
--- a/testing/web-platform/meta/service-workers/cache-storage/window/cache-delete.https.html.ini
+++ /dev/null
@@ -1,3 +0,0 @@
-[cache-delete.https.html]
-  type: testharness
-  prefs: [dom.caches.enabled:true]
diff --git a/testing/web-platform/meta/service-workers/cache-storage/window/cache-storage-keys.https.html.ini b/testing/web-platform/meta/service-workers/cache-storage/window/cache-storage-keys.https.html.ini
deleted file mode 100644
--- a/testing/web-platform/meta/service-workers/cache-storage/window/cache-storage-keys.https.html.ini
+++ /dev/null
@@ -1,3 +0,0 @@
-[cache-storage-keys.https.html]
-  type: testharness
-  prefs: [dom.caches.enabled:true]
diff --git a/testing/web-platform/meta/service-workers/cache-storage/window/cache-storage.https.html.ini b/testing/web-platform/meta/service-workers/cache-storage/window/cache-storage.https.html.ini
deleted file mode 100644
--- a/testing/web-platform/meta/service-workers/cache-storage/window/cache-storage.https.html.ini
+++ /dev/null
@@ -1,3 +0,0 @@
-[cache-storage.https.html]
-  type: testharness
-  prefs: [dom.caches.enabled:true]
diff --git a/testing/web-platform/meta/service-workers/cache-storage/window/sandboxed-iframes.https.html.ini b/testing/web-platform/meta/service-workers/cache-storage/window/sandboxed-iframes.https.html.ini
deleted file mode 100644
--- a/testing/web-platform/meta/service-workers/cache-storage/window/sandboxed-iframes.https.html.ini
+++ /dev/null
@@ -1,6 +0,0 @@
-[sandboxed-iframes.https.html]
-  type: testharness
-  prefs: [dom.caches.enabled:true]
-  [Sandboxed iframe without allow-same-origin is denied access]
-    expected: FAIL
-
diff --git a/testing/web-platform/tests/service-workers/cache-storage/resources/iframe.html b/testing/web-platform/tests/service-workers/cache-storage/resources/iframe.html
--- a/testing/web-platform/tests/service-workers/cache-storage/resources/iframe.html
+++ b/testing/web-platform/tests/service-workers/cache-storage/resources/iframe.html
@@ -1,13 +1,18 @@
 <!DOCTYPE html>
 <title>ok</title>
 <script>
 window.onmessage = function(e) {
     var id = e.data.id;
     try {
-        self.caches;
-        window.parent.postMessage({id: id, result: 'allowed'}, '*');
+        var name = 'checkallowed';
+        self.caches.open(name).then(function (cache) {
+            self.caches.delete(name);
+            window.parent.postMessage({id: id, result: 'allowed'}, '*');
+        }).catch(function(e) {
+            window.parent.postMessage({id: id, result: 'denied', name: e.name, message: e.message}, '*');
+        });
     } catch (e) {
-        window.parent.postMessage({id: id, result: 'denied', name: e.name, message: e.message}, '*');
+        window.parent.postMessage({id: id, result: 'unexpecteddenied', name: e.name, message: e.message}, '*');
     }
 };
 </script>
