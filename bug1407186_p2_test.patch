# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  3ea5af83c0c681bbe4a81ba3fbb6ae71059dd465
Bug 1407186 P2 Test that we reset the interception if ChannelIntercepted() returns an error. r=asuth

diff --git a/netwerk/test/unit/test_synthesized_response.js b/netwerk/test/unit/test_synthesized_response.js
--- a/netwerk/test/unit/test_synthesized_response.js
+++ b/netwerk/test/unit/test_synthesized_response.js
@@ -233,11 +233,21 @@ add_test(function() {
       intercepted.channel.cancel(Cr.NS_BINDING_ABORTED);
       intercepted.finishSynthesizedResponse('');
     });
   });
   chan.asyncOpen2(new ChannelListener(run_next_test, null,
                                      CL_EXPECT_FAILURE | CL_ALLOW_UNKNOWN_CL));
 });
 
+// Ensure that nsIInterceptedChannel.channelIntercepted() can return an error.
+// In this case we should automatically ResetInterception() and complete the
+// network request.
+add_test(function() {
+  var chan = make_channel(URL + '/body', null, function(chan) {
+    throw('boom');
+  });
+  chan.asyncOpen2(new ChannelListener(handle_remote_response, null));
+});
+
 add_test(function() {
   httpServer.stop(run_next_test);
 });
