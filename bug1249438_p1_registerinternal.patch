# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  63be002b4a803df1122823841ef7633b7561d873
Bug 1249438 P1 Move guts of RegisterServiceWorker() into a protected method that can be tested in gtest. r=baku

diff --git a/dom/workers/ServiceWorkerRegistrar.cpp b/dom/workers/ServiceWorkerRegistrar.cpp
--- a/dom/workers/ServiceWorkerRegistrar.cpp
+++ b/dom/workers/ServiceWorkerRegistrar.cpp
@@ -175,29 +175,17 @@ ServiceWorkerRegistrar::RegisterServiceW
   if (mShuttingDown) {
     NS_WARNING("Failed to register a serviceWorker during shutting down.");
     return;
   }
 
   {
     MonitorAutoLock lock(mMonitor);
     MOZ_ASSERT(mDataLoaded);
-
-    bool found = false;
-    for (uint32_t i = 0, len = mData.Length(); i < len; ++i) {
-      if (Equivalent(aData, mData[i])) {
-        mData[i] = aData;
-        found = true;
-        break;
-      }
-    }
-
-    if (!found) {
-      mData.AppendElement(aData);
-    }
+    RegisterServiceWorkerInternal(aData);
   }
 
   ScheduleSaveData();
 }
 
 void
 ServiceWorkerRegistrar::UnregisterServiceWorker(
                                             const PrincipalInfo& aPrincipalInfo,
@@ -511,16 +499,33 @@ ServiceWorkerRegistrar::DeleteData()
     return;
   }
 
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return;
   }
 }
 
+void
+ServiceWorkerRegistrar::RegisterServiceWorkerInternal(const ServiceWorkerRegistrationData& aData)
+{
+  bool found = false;
+  for (uint32_t i = 0, len = mData.Length(); i < len; ++i) {
+    if (Equivalent(aData, mData[i])) {
+      mData[i] = aData;
+      found = true;
+      break;
+    }
+  }
+
+  if (!found) {
+    mData.AppendElement(aData);
+  }
+}
+
 class ServiceWorkerRegistrarSaveDataRunnable final : public nsRunnable
 {
 public:
   ServiceWorkerRegistrarSaveDataRunnable()
     : mThread(do_GetCurrentThread())
   {
     AssertIsOnBackgroundThread();
   }
diff --git a/dom/workers/ServiceWorkerRegistrar.h b/dom/workers/ServiceWorkerRegistrar.h
--- a/dom/workers/ServiceWorkerRegistrar.h
+++ b/dom/workers/ServiceWorkerRegistrar.h
@@ -61,16 +61,18 @@ protected:
   // subclassing it.
   void LoadData();
   void SaveData();
 
   nsresult ReadData();
   nsresult WriteData();
   void DeleteData();
 
+  void RegisterServiceWorkerInternal(const ServiceWorkerRegistrationData& aData);
+
   ServiceWorkerRegistrar();
   virtual ~ServiceWorkerRegistrar();
 
 private:
   void ProfileStarted();
   void ProfileStopped();
 
   void ScheduleSaveData();
