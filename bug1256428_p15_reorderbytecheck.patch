# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  1d3e6adc7861d931b2c3eff20ab20250f9f76eaa
Bug 1256428 P15 Perform byte-for-byte comparison check after validating script URL. r=jdm

diff --git a/dom/workers/ServiceWorkerUpdateJob.cpp b/dom/workers/ServiceWorkerUpdateJob.cpp
--- a/dom/workers/ServiceWorkerUpdateJob.cpp
+++ b/dom/workers/ServiceWorkerUpdateJob.cpp
@@ -270,22 +270,21 @@ ServiceWorkerUpdateJob2::ComparisonResul
     return;
   }
 
   if (NS_WARN_IF(NS_FAILED(aStatus))) {
     FailUpdateJob(aStatus);
     return;
   }
 
-  if (aInCacheAndEqual) {
-    Finish(NS_OK);
-    return;
-  }
-
-  Telemetry::Accumulate(Telemetry::SERVICE_WORKER_UPDATED, 1);
+  // The spec validates the response before performing the byte-for-byte check.
+  // Here we perform the comparison in another module and then validate the
+  // script URL and scope.  Make sure to do this validation before accepting
+  // an byte-for-byte match since the service-worker-allowed header might have
+  // changed since the last time it was installed.
 
   nsCOMPtr<nsIURI> scriptURI;
   nsresult rv = NS_NewURI(getter_AddRefs(scriptURI), mScriptSpec);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     FailUpdateJob(NS_ERROR_DOM_SECURITY_ERR);
     return;
   }
 
@@ -317,16 +316,25 @@ ServiceWorkerUpdateJob2::ComparisonResul
   }
 
   if (!StringBeginsWith(mRegistration->mScope, maxPrefix)) {
     NS_WARNING("By default a service worker's scope is restricted to at or below it's script's location.");
     FailUpdateJob(NS_ERROR_DOM_SECURITY_ERR);
     return;
   }
 
+  // The response has been validated, so now we can consider if its a
+  // byte-for-byte match.
+  if (aInCacheAndEqual) {
+    Finish(NS_OK);
+    return;
+  }
+
+  Telemetry::Accumulate(Telemetry::SERVICE_WORKER_UPDATED, 1);
+
   MOZ_ASSERT(!mServiceWorker);
   mServiceWorker = new ServiceWorkerInfo(mRegistration->mPrincipal,
                                          mRegistration->mScope,
                                          mScriptSpec, aNewCacheName);
 
   nsMainThreadPtrHandle<ServiceWorkerUpdateJob2> handle(
       new nsMainThreadPtrHolder<ServiceWorkerUpdateJob2>(this));
   RefPtr<LifeCycleEventCallback> callback = new ContinueUpdateRunnable(handle);
