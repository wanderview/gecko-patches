# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  14bf383c5caa1657c0cf83ed9f2424241b7c9d37
Bug 1400372 P1 Support redirected importScripts() when updating a service worker script. r=hopang

diff --git a/dom/workers/ServiceWorkerScriptCache.cpp b/dom/workers/ServiceWorkerScriptCache.cpp
--- a/dom/workers/ServiceWorkerScriptCache.cpp
+++ b/dom/workers/ServiceWorkerScriptCache.cpp
@@ -707,19 +707,21 @@ CompareNetwork::Initialize(nsIPrincipal*
                      contentPolicyType, loadGroup, nullptr /* aCallbacks */,
                      mLoadFlags);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
 
   nsCOMPtr<nsIHttpChannel> httpChannel = do_QueryInterface(mChannel);
   if (httpChannel) {
-    // Spec says no redirects allowed for SW scripts.
-    rv = httpChannel->SetRedirectionLimit(0);
-    MOZ_ASSERT(NS_SUCCEEDED(rv));
+    // Spec says no redirects allowed for top-level SW scripts.
+    if (mIsMainScript) {
+      rv = httpChannel->SetRedirectionLimit(0);
+      MOZ_ASSERT(NS_SUCCEEDED(rv));
+    }
 
     rv = httpChannel->SetRequestHeader(NS_LITERAL_CSTRING("Service-Worker"),
                                        NS_LITERAL_CSTRING("script"),
                                        /* merge */ false);
     MOZ_ASSERT(NS_SUCCEEDED(rv));
   }
 
   nsCOMPtr<nsIStreamLoader> loader;
@@ -843,20 +845,19 @@ NS_IMETHODIMP
 CompareNetwork::OnStartRequest(nsIRequest* aRequest, nsISupports* aContext)
 {
   AssertIsOnMainThread();
 
   if (mState == Finished) {
     return NS_OK;
   }
 
-#ifdef DEBUG
   nsCOMPtr<nsIChannel> channel = do_QueryInterface(aRequest);
-  MOZ_ASSERT(channel == mChannel);
-#endif
+  MOZ_ASSERT_IF(mIsMainScript, channel == mChannel);
+  mChannel = channel;
 
   MOZ_ASSERT(!mChannelInfo.IsInitialized());
   mChannelInfo.InitFromChannel(mChannel);
 
   nsresult rv = SetPrincipalInfo(mChannel);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     return rv;
   }
