# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  189f4e5f389b65ea134c462fb406cc2f9022de32
Bug 1362033 Make clients-matchall-client-types.https.html report failure instead of timeout when assertions fail. r=asuth

diff --git a/testing/web-platform/tests/service-workers/service-worker/clients-matchall-client-types.https.html b/testing/web-platform/tests/service-workers/service-worker/clients-matchall-client-types.https.html
--- a/testing/web-platform/tests/service-workers/service-worker/clients-matchall-client-types.https.html
+++ b/testing/web-platform/tests/service-workers/service-worker/clients-matchall-client-types.https.html
@@ -25,19 +25,23 @@ function test_matchall(frame, expected, 
   frame.focus();
   expected.sort(function(a, b) { return a[2] > b[2] ? 1 : -1; });
   return new Promise(function(resolve, reject) {
     var channel = new MessageChannel();
     channel.port1.onmessage = function(e) {
       if (typeof e.data === 'string') {
         return reject(e.data);
       }
-      assert_equals(e.data.length, expected.length);
-      for (var i = 0; i < e.data.length; i++)
-        assert_array_equals(e.data[i], expected[i]);
+      try {
+        assert_equals(e.data.length, expected.length);
+        for (var i = 0; i < e.data.length; i++)
+          assert_array_equals(e.data[i], expected[i]);
+      } catch (e) {
+        reject(e);
+      }
       resolve();
     };
     frame.contentWindow.navigator.serviceWorker.controller.postMessage(
         {port:channel.port2, options:query_options},
         [channel.port2]);
   });
 }
 
@@ -89,12 +93,13 @@ promise_test(function(t) {
                                {type:'sharedworker'});
         })
       .then(function() {
           return test_matchall(frame, expected_window_and_shared_worker, {type:'all'});
         })
       .then(function() {
           frame.remove();
           return service_worker_unregister_and_done(t, scope);
-        });
+        })
+      .catch(unreached_rejection(t));
   }, 'Verify matchAll() with window and sharedworker client types');
 
 </script>
