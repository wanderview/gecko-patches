# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  42a31c97e63486498ab3ed24adc3f08caf1e5eb1
Bug 1340652 P3 Test XHR referer header from redirected worker script. r=baku

diff --git a/testing/web-platform/meta/MANIFEST.json b/testing/web-platform/meta/MANIFEST.json
--- a/testing/web-platform/meta/MANIFEST.json
+++ b/testing/web-platform/meta/MANIFEST.json
@@ -80850,16 +80850,22 @@
     ]
    ],
    "XMLHttpRequest/open-url-multi-window.htm": [
     [
      "/XMLHttpRequest/open-url-multi-window.htm",
      {}
     ]
    ],
+   "XMLHttpRequest/open-url-redirected-worker-origin.htm": [
+    [
+     "/XMLHttpRequest/open-url-redirected-worker-origin.htm",
+     {}
+    ]
+   ],
    "XMLHttpRequest/open-url-worker-origin.htm": [
     [
      "/XMLHttpRequest/open-url-worker-origin.htm",
      {}
     ]
    ],
    "XMLHttpRequest/open-url-worker-simple.htm": [
     [
@@ -136399,16 +136405,20 @@
   "XMLHttpRequest/open-url-multi-window-6.htm": [
    "b45b864be8c189b5b4113e9a7f3820fd8a08df6a",
    "testharness"
   ],
   "XMLHttpRequest/open-url-multi-window.htm": [
    "28603b8d225367ba648bb9271dec5cb3da73d733",
    "testharness"
   ],
+  "XMLHttpRequest/open-url-redirected-worker-origin.htm": [
+   "98c20df1cd8c7e27a94ba55f7c94d19244d7ff59",
+   "testharness"
+  ],
   "XMLHttpRequest/open-url-worker-origin.htm": [
    "e4db65c7c0a98d7f5aa84eac01705259f377f44b",
    "testharness"
   ],
   "XMLHttpRequest/open-url-worker-simple.htm": [
    "224c1502970253197c670bfb04efa15708e034d5",
    "testharness"
   ],
diff --git a/testing/web-platform/tests/XMLHttpRequest/open-url-redirected-worker-origin.htm b/testing/web-platform/tests/XMLHttpRequest/open-url-redirected-worker-origin.htm
new file mode 100644
--- /dev/null
+++ b/testing/web-platform/tests/XMLHttpRequest/open-url-redirected-worker-origin.htm
@@ -0,0 +1,44 @@
+ <!DOCTYPE html>
+<html>
+<head>
+    <meta charset="utf-8" />
+    <title>XMLHttpRequest: redirected worker scripts, origin and referrer</title>
+    <script src="/resources/testharness.js"></script>
+    <script src="/resources/testharnessreport.js"></script>
+    <link rel="help" href="https://xhr.spec.whatwg.org/#the-open()-method" data-tested-assertations="following::OL[1]/LI[3] following::OL[1]/LI[3]/ol[1]/li[1] following::OL[1]/LI[3]/ol[1]/li[2] following::OL[1]/LI[3]/ol[1]/li[3]" />
+</head>
+<body>
+    <div id="log"></div>
+    <script type="text/javascript">
+        var test = async_test() // This "test" does not actually do any assertations. It's just there to have multiple, separate, asyncronous sub-tests.
+        var expectations = {
+            'Referer header': 'referer: '+(location.href.replace(/[^/]*$/, ''))+"resources/workerxhr-origin-referrer.js\n",
+            'Origin header': 'origin: '+location.protocol+'//'+location.hostname+((location.port === "")?"":":"+location.port)+'\n',
+            'Request URL test' : (location.href.replace(/[^/]*$/, ''))+'resources/requri.py?full'
+        }
+        // now start the worker
+        var finalWorkerURL = "workerxhr-origin-referrer.js";
+        var url = "resources/redirect.py?location=" + encodeURIComponent(finalWorkerURL);
+        var worker = new Worker(url, true)
+        worker.onmessage = function (e) {
+            var subtest = async_test(e.data.test)
+            subtest.step(function(){
+                var thisExpectation = expectations[e.data.test]
+                delete expectations[e.data.test]
+                assert_equals(e.data.result, thisExpectation)
+                subtest.done()
+            })
+            var allDone = true
+            for(var prop in expectations){
+                  allDone = false
+            }
+            if(allDone){
+                test.step(function(){
+                    test.done()
+                })
+            }
+        }
+
+    </script>
+</body>
+</html>
