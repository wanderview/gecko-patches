# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  133df20e90e6c335575002dade869df7cb28a492

diff --git a/dom/serviceworkers/ServiceWorkerRegistrationProxy.cpp b/dom/serviceworkers/ServiceWorkerRegistrationProxy.cpp
--- a/dom/serviceworkers/ServiceWorkerRegistrationProxy.cpp
+++ b/dom/serviceworkers/ServiceWorkerRegistrationProxy.cpp
@@ -68,18 +68,17 @@ ServiceWorkerRegistrationProxy::InitOnMa
     swm->GetRegistration(mDescriptor.PrincipalInfo(), mDescriptor.Scope());
   NS_ENSURE_TRUE_VOID(reg);
 
   scopeExit.release();
 
   mReg = new nsMainThreadPtrHolder<ServiceWorkerRegistrationInfo>(
     "ServiceWorkerRegistrationProxy::mInfo", reg);
 
-  swm->AddRegistrationEventListener(NS_ConvertUTF8toUTF16(mDescriptor.Scope()),
-                                    this);
+  mReg->AddInstance(this);
 
   // Currently the spec only sets an installing worker in step 3 of the Install
   // algorithm:
   //
   //  https://w3c.github.io/ServiceWorker/#installation-algorithm
   //
   // In step 7 it then queues a task to dispatch an "updatefound" event.
   //
@@ -131,23 +130,19 @@ ServiceWorkerRegistrationProxy::MaybeShu
 void
 ServiceWorkerRegistrationProxy::StopListeningOnMainThread()
 {
   AssertIsOnMainThread();
 
   if (!mReg) {
     return;
   }
+
+  mReg->RemoveInstance(this);
   mReg = nullptr;
-
-  RefPtr<ServiceWorkerManager> swm = ServiceWorkerManager::GetInstance();
-  NS_ENSURE_TRUE_VOID(swm);
-
-  swm->RemoveRegistrationEventListener(NS_ConvertUTF8toUTF16(mDescriptor.Scope()),
-                                       this);
 }
 
 void
 ServiceWorkerRegistrationProxy::UpdateFound()
 {
   AssertIsOnMainThread();
 
   nsCOMPtr<nsIRunnable> r = NewRunnableMethod(
