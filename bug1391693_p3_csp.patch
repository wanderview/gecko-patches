# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  1a77708b769989f169ec803537dc6571d20b9335
Bug 1391693 P3 Allow CSP report channels to be internally redirected.

diff --git a/dom/security/nsCSPContext.cpp b/dom/security/nsCSPContext.cpp
--- a/dom/security/nsCSPContext.cpp
+++ b/dom/security/nsCSPContext.cpp
@@ -1523,16 +1523,21 @@ CSPReportRedirectSink::~CSPReportRedirec
 }
 
 NS_IMETHODIMP
 CSPReportRedirectSink::AsyncOnChannelRedirect(nsIChannel* aOldChannel,
                                               nsIChannel* aNewChannel,
                                               uint32_t aRedirFlags,
                                               nsIAsyncVerifyRedirectCallback* aCallback)
 {
+  if (aRedirFlags & nsIChannelEventSink::REDIRECT_INTERNAL) {
+    aCallback->OnRedirectVerifyCallback(NS_OK);
+    return NS_OK;
+  }
+
   // cancel the old channel so XHR failure callback happens
   nsresult rv = aOldChannel->Cancel(NS_ERROR_ABORT);
   NS_ENSURE_SUCCESS(rv, rv);
 
   // notify an observer that we have blocked the report POST due to a redirect,
   // used in testing, do this async since we're in an async call now to begin with
   nsCOMPtr<nsIURI> uri;
   rv = aOldChannel->GetURI(getter_AddRefs(uri));
