# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  43f2958e40496c50910b7de8b1627cfe250307ec
Bug 1255604 Allow streams that are async and WOULD_BLOCK to be treated as buffered. r=froydnj

diff --git a/xpcom/io/nsStreamUtils.cpp b/xpcom/io/nsStreamUtils.cpp
--- a/xpcom/io/nsStreamUtils.cpp
+++ b/xpcom/io/nsStreamUtils.cpp
@@ -748,17 +748,17 @@ NS_InputStreamIsBuffered(nsIInputStream*
   nsCOMPtr<nsIBufferedInputStream> bufferedIn = do_QueryInterface(aStream);
   if (bufferedIn) {
     return true;
   }
 
   bool result = false;
   uint32_t n;
   nsresult rv = aStream->ReadSegments(TestInputStream, &result, 1, &n);
-  return result || NS_SUCCEEDED(rv);
+  return result || NS_SUCCEEDED(rv) || rv == NS_BASE_STREAM_WOULD_BLOCK;
 }
 
 static NS_METHOD
 TestOutputStream(nsIOutputStream* aOutStr,
                  void* aClosure,
                  char* aBuffer,
                  uint32_t aOffset,
                  uint32_t aCount,
@@ -774,18 +774,18 @@ NS_OutputStreamIsBuffered(nsIOutputStrea
 {
   nsCOMPtr<nsIBufferedOutputStream> bufferedOut = do_QueryInterface(aStream);
   if (bufferedOut) {
     return true;
   }
 
   bool result = false;
   uint32_t n;
-  aStream->WriteSegments(TestOutputStream, &result, 1, &n);
-  return result;
+  nsresult rv = aStream->WriteSegments(TestOutputStream, &result, 1, &n);
+  return result || NS_SUCCEEDED(rv) || rv == NS_BASE_STREAM_WOULD_BLOCK;
 }
 
 //-----------------------------------------------------------------------------
 
 NS_METHOD
 NS_CopySegmentToStream(nsIInputStream* aInStr,
                        void* aClosure,
                        const char* aBuffer,
