# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  9372b6b1b4eebe31e3ad55b2c693400f49c3ebd7
Bug 1465670 P7 Make the fetch mochitest reroute test framework use a unique scope. r=asuth

diff --git a/dom/tests/mochitest/fetch/sw_reroute.js b/dom/tests/mochitest/fetch/sw_reroute.js
--- a/dom/tests/mochitest/fetch/sw_reroute.js
+++ b/dom/tests/mochitest/fetch/sw_reroute.js
@@ -1,32 +1,35 @@
 var gRegistration;
+var iframe;
 
 function testScript(script) {
+  var scope = "./reroute.html?" + script.replace(".js", "");
   function setupSW(registration) {
     gRegistration = registration;
 
-    var iframe = document.createElement("iframe");
-    iframe.src = "reroute.html?" + script.replace(".js", "");
+    iframe = document.createElement("iframe");
+    iframe.src = scope;
     document.body.appendChild(iframe);
   }
 
   SpecialPowers.pushPrefEnv({
     "set": [["dom.serviceWorkers.enabled", true],
             ["dom.serviceWorkers.testing.enabled", true],
             ["dom.serviceWorkers.exemptFromPerDomainMax", true]]
   }, function() {
     var scriptURL = location.href.includes("sw_empty_reroute.html")
                   ? "empty.js" : "reroute.js";
-    navigator.serviceWorker.register(scriptURL, {scope: "/"})
+    navigator.serviceWorker.register(scriptURL, {scope: scope})
       .then(swr => waitForState(swr.installing, 'activated', swr))
       .then(setupSW);
   });
 }
 
 function finishTest() {
+  iframe.remove();
   gRegistration.unregister().then(SimpleTest.finish, function(e) {
     dump("unregistration failed: " + e + "\n");
     SimpleTest.finish();
   });
 }
 
 SimpleTest.waitForExplicitFinish();
