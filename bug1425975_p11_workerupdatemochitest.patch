# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  487482995d6e417883e44782d1d546b0601d178a
Bug 1425975 P11 Fix test_workerupdatefound.html not to frame loading against SW activation and updatefound events. r=asuth

diff --git a/dom/workers/test/serviceworkers/test_workerupdatefoundevent.html b/dom/workers/test/serviceworkers/test_workerupdatefoundevent.html
--- a/dom/workers/test/serviceworkers/test_workerupdatefoundevent.html
+++ b/dom/workers/test/serviceworkers/test_workerupdatefoundevent.html
@@ -8,24 +8,25 @@
   <title>Bug 1131327 - Test ServiceWorkerRegistration.onupdatefound on ServiceWorker</title>
   <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
 </head>
 <body>
 <p id="display"></p>
 <div id="content"></div>
 <pre id="test"></pre>
+<script src="utils.js"></script>
 <script class="testbody" type="text/javascript">
   var registration;
   var promise;
 
-  function start() {
-    return navigator.serviceWorker.register("worker_updatefoundevent.js",
-                                            { scope: "./updatefoundevent.html" })
-      .then((swr) => registration = swr);
+  async function start() {
+    registration = await navigator.serviceWorker.register("worker_updatefoundevent.js",
+                                                          { scope: "./updatefoundevent.html" })
+    await waitForState(registration.installing, 'activated');
   }
 
   function startWaitForUpdateFound() {
     registration.onupdatefound = function(e) {
     }
 
     promise = new Promise(function(resolve, reject) {
       window.onmessage = function(e) {
diff --git a/dom/workers/test/serviceworkers/worker_updatefoundevent.js b/dom/workers/test/serviceworkers/worker_updatefoundevent.js
--- a/dom/workers/test/serviceworkers/worker_updatefoundevent.js
+++ b/dom/workers/test/serviceworkers/worker_updatefoundevent.js
@@ -1,23 +1,18 @@
 /**
  * Any copyright is dedicated to the Public Domain.
  * http://creativecommons.org/publicdomain/zero/1.0/
  */
 
-onactivate = function(e) {
-  e.waitUntil(new Promise(function(resolve, reject) {
-    registration.onupdatefound = function(e) {
-      clients.matchAll().then(function(clients) {
-        if (!clients.length) {
-          reject("No clients found");
-        }
+registration.onupdatefound = function(e) {
+  clients.matchAll().then(function(clients) {
+    if (!clients.length) {
+      reject("No clients found");
+    }
 
-        if (registration.scope.match(/updatefoundevent\.html$/)) {
-          clients[0].postMessage("finish");
-          resolve();
-        } else {
-          dump("Scope did not match");
-        }
-      }, reject);
+    if (registration.scope.match(/updatefoundevent\.html$/)) {
+      clients[0].postMessage("finish");
+    } else {
+      dump("Scope did not match");
     }
-  }));
+  });
 }
