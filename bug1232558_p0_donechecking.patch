# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  d2a0e1b8528c3179020d664d73881a8c9cb08dec
Bug 1232558 P0 Track service worker job done state. r=ehsan

diff --git a/dom/workers/ServiceWorkerManager.cpp b/dom/workers/ServiceWorkerManager.cpp
--- a/dom/workers/ServiceWorkerManager.cpp
+++ b/dom/workers/ServiceWorkerManager.cpp
@@ -170,26 +170,34 @@ public:
 
   bool
   IsRegisterOrInstallJob() const
   {
     return mJobType == RegisterJob || mJobType == UpdateJob ||
       mJobType == InstallJob;
   }
 
+  bool
+  IsDone() const
+  {
+    return mDone;
+  }
+
 protected:
   // The queue keeps the jobs alive, so they can hold a rawptr back to the
   // queue.
   ServiceWorkerJobQueue* mQueue;
 
   Type mJobType;
+  bool mDone;
 
   explicit ServiceWorkerJob(ServiceWorkerJobQueue* aQueue, Type aJobType)
     : mQueue(aQueue)
     , mJobType(aJobType)
+    , mDone(false)
   {}
 
   virtual ~ServiceWorkerJob()
   {}
 
   void
   Done(nsresult aStatus);
 };
@@ -366,16 +374,22 @@ private:
 
 } // namespace
 
 NS_IMPL_ISUPPORTS0(ServiceWorkerJob)
 
 void
 ServiceWorkerJob::Done(nsresult aStatus)
 {
+  MOZ_ASSERT(!mDone);
+  if (mDone) {
+    return;
+  }
+  mDone = true;
+
   if (NS_WARN_IF(NS_FAILED(aStatus))) {
 #ifdef DEBUG
     nsAutoCString errorName;
     GetErrorName(aStatus, errorName);
 #endif
     NS_WARNING(nsPrintfCString("ServiceWorkerJob failed with error: %s",
                                errorName.get()).get());
   }
