# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  7fa721cab1c07a22a6471eb0f3e7daa5cfae3bd3
Bug 1462069 P0 Allow ServiceWorkerParentInterceptEnabled() to be used off-main-thread. r=asuth

diff --git a/dom/serviceworkers/ServiceWorkerUtils.cpp b/dom/serviceworkers/ServiceWorkerUtils.cpp
--- a/dom/serviceworkers/ServiceWorkerUtils.cpp
+++ b/dom/serviceworkers/ServiceWorkerUtils.cpp
@@ -9,28 +9,24 @@
 #include "mozilla/Preferences.h"
 
 namespace mozilla {
 namespace dom {
 
 bool
 ServiceWorkerParentInterceptEnabled()
 {
-  // For right now we only support main thread.  In the future we could make
-  // this use an atomic bool if we need to support worker threads.
-  MOZ_ASSERT(NS_IsMainThread());
-
   static bool sInit = false;
-  static bool sEnabled;
+  static Atomic<bool> sEnabled;
 
   if (!sInit) {
     MOZ_ASSERT(NS_IsMainThread());
-    Preferences::AddBoolVarCache(&sEnabled,
-                                 "dom.serviceWorkers.parent_intercept",
-                                 false);
+    Preferences::AddAtomicBoolVarCache(&sEnabled,
+                                       "dom.serviceWorkers.parent_intercept",
+                                       false);
     sInit = true;
   }
 
   return sEnabled;
 }
 
 bool
 ServiceWorkerRegistrationDataIsValid(const ServiceWorkerRegistrationData& aData)
