# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  b372c8039fa3c9a2b95eed5cead4219c8c4b81ac
Bug 1450358 P3 Verify that Animation does not leak via event listeners. r=birtles

diff --git a/dom/animation/test/mochitest.ini b/dom/animation/test/mochitest.ini
--- a/dom/animation/test/mochitest.ini
+++ b/dom/animation/test/mochitest.ini
@@ -68,16 +68,17 @@ skip-if = (toolkit == 'android' && debug
 [mozilla/test_restyles.html]
 skip-if = webrender # bug 1424752
 [mozilla/test_restyling_xhr_doc.html]
 [mozilla/test_set_easing.html]
 [mozilla/test_transform_limits.html]
 [mozilla/test_transition_finish_on_compositor.html]
 skip-if = toolkit == 'android' || webrender # bug 1424752 for webrender
 [mozilla/test_underlying_discrete_value.html]
+[mozilla/test_event_listener_leaks.html]
 [style/test_animation-seeking-with-current-time.html]
 [style/test_animation-seeking-with-start-time.html]
 [style/test_animation-setting-effect.html]
 [style/test_composite.html]
 skip-if = webrender # bug 1424752
 [style/test_interpolation-from-interpolatematrix-to-none.html]
 [style/test_missing-keyframe.html]
 [style/test_missing-keyframe-on-compositor.html]
diff --git a/dom/animation/test/mozilla/test_event_listener_leaks.html b/dom/animation/test/mozilla/test_event_listener_leaks.html
new file mode 100644
--- /dev/null
+++ b/dom/animation/test/mozilla/test_event_listener_leaks.html
@@ -0,0 +1,98 @@
+<!--
+  Any copyright is dedicated to the Public Domain.
+  http://creativecommons.org/publicdomain/zero/1.0/
+-->
+<!DOCTYPE HTML>
+<html>
+<head>
+  <title>Bug 1450271 - Test Animation event listener leak conditions</title>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<p id="display"></p>
+<div id="content" style="display: none"></div>
+<pre id="test"></pre>
+<script class="testbody" type="text/javascript">
+// Utility function to create a loaded iframe.
+async function withFrame(doc, url) {
+  let frame = doc.createElement('iframe');
+  frame.src = url;
+  doc.body.appendChild(frame);
+  await new Promise(resolve => frame.onload = resolve);
+  return frame;
+}
+
+// Manipulate Animation.  Its important here that we create a
+// listener callback from the DOM objects back to the frame's global
+// in order to exercise the leak condition.
+async function useAnimation(name, contentWindow) {
+  let div = contentWindow.document.createElement("div");
+  contentWindow.document.body.appendChild(div);
+  let animation = div.animate({}, 100 * 1000);
+  is(animation.playState, "running", "animation should be running");
+  animation.onfinish = _ => {
+    contentWindow.finishCount += 1;
+  };
+}
+
+// This function defines the basic form of the test cases.  We create an
+// iframe, manipulate a Animation DOM object, remove the frame
+// from the DOM and then check to see if the frame was GC'd.  The caller
+// may optionally pass in a callback that will be executed with the
+// frame as an argument before removing it from the DOM.
+async function leakTest(name, callback) {
+  let frame = await withFrame(document, "about:blank");
+
+  await useAnimation(name, frame.contentWindow);
+
+  let weakRef = SpecialPowers.Cu.getWeakReference(frame.contentWindow);
+  ok(weakRef.get(), `should be able to create a weak reference - ${name}`);
+
+  if (callback) {
+    await callback(frame);
+  }
+
+  frame.remove();
+  frame = null;
+
+  await new Promise(resolve => SpecialPowers.exactGC(resolve));
+  await new Promise(resolve => SpecialPowers.exactGC(resolve));
+  ok(!weakRef.get(), `iframe content window should be garbage collected - ${name}`);
+}
+
+async function runTest() {
+  try {
+    // Test if we leak in the case where we do nothing special to
+    // te frame before removing it from the DOM.
+    await leakTest("default");
+
+    // Test the case where we navigate the frame before removing it
+    // from the DOM so that the Animation using window ends up
+    // in bfcache.
+    await leakTest("bfcache", frame => {
+      frame.src = "about:blank";
+      return new Promise(resolve => frame.onload = resolve);
+    });
+
+    // Test the case where we document.open() the frame before removing
+    // it from the DOM so that the Animation using window ends
+    // up getting replaced.
+    await leakTest("document.open()", frame => {
+      frame.contentDocument.open();
+      frame.contentDocument.close();
+    });
+  } catch (e) {
+    ok(false, e);
+  } finally {
+    SimpleTest.finish();
+  }
+}
+
+SimpleTest.waitForExplicitFinish();
+addEventListener("load", runTest, { once: true });
+</script>
+</pre>
+</body>
+</html>
+
