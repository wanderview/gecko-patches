# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  2ffdd1bccf8ff8eed35031499f8682467ea07aa5
Bug 1438211 P4 Make ServiceWorkerRegistration call nsIGlobalObject's Add/RemoveServiceWorkerRegistration() methods. r=asuth

diff --git a/dom/serviceworkers/ServiceWorkerRegistration.cpp b/dom/serviceworkers/ServiceWorkerRegistration.cpp
--- a/dom/serviceworkers/ServiceWorkerRegistration.cpp
+++ b/dom/serviceworkers/ServiceWorkerRegistration.cpp
@@ -34,23 +34,29 @@ NS_INTERFACE_MAP_END_INHERITING(DOMEvent
 
 ServiceWorkerRegistration::ServiceWorkerRegistration(nsIGlobalObject* aGlobal,
                                                      const ServiceWorkerRegistrationDescriptor& aDescriptor,
                                                      ServiceWorkerRegistration::Inner* aInner)
   : DOMEventTargetHelper(aGlobal)
   , mDescriptor(aDescriptor)
   , mInner(aInner)
 {
+  MOZ_DIAGNOSTIC_ASSERT(aGlobal);
   MOZ_DIAGNOSTIC_ASSERT(mInner);
+  aGlobal->AddServiceWorkerRegistration(this);
   UpdateState(mDescriptor);
   mInner->SetServiceWorkerRegistration(this);
 }
 
 ServiceWorkerRegistration::~ServiceWorkerRegistration()
 {
+  nsIGlobalObject* global = GetParentObject();
+  if (global) {
+    global->RemoveServiceWorkerRegistration(this);
+  }
   if (mInner) {
     mInner->ClearServiceWorkerRegistration(this);
   }
 }
 
 JSObject*
 ServiceWorkerRegistration::WrapObject(JSContext* aCx,
                                       JS::Handle<JSObject*> aGivenProto)
@@ -90,16 +96,20 @@ ServiceWorkerRegistration::CreateForWork
                                   inner);
 
   return registration.forget();
 }
 
 void
 ServiceWorkerRegistration::DisconnectFromOwner()
 {
+  nsIGlobalObject* global = GetParentObject();
+  if (global) {
+    global->RemoveServiceWorkerRegistration(this);
+  }
   mInner->ClearServiceWorkerRegistration(this);
   mInner = nullptr;
   DOMEventTargetHelper::DisconnectFromOwner();
 }
 
 already_AddRefed<ServiceWorker>
 ServiceWorkerRegistration::GetInstalling() const
 {
