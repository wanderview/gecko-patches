# HG changeset patch
# Parent 8b9bbfd0fcb6070b2fd7af814f8a3e6fa709749c
# User Ben Kelly <ben@wanderview.com>
Bug 1175138 P4 Enable dom.caches.testing.enabled in existing tests. r=ehsan

diff --git a/dom/cache/test/mochitest/browser_cache_pb_window.js b/dom/cache/test/mochitest/browser_cache_pb_window.js
--- a/dom/cache/test/mochitest/browser_cache_pb_window.js
+++ b/dom/cache/test/mochitest/browser_cache_pb_window.js
@@ -58,17 +58,18 @@ function testKeys(win) {
       resolve();
     });
   });
 }
 
 function test() {
   waitForExplicitFinish();
   SpecialPowers.pushPrefEnv({'set': [['browser.privatebrowing.autostart', true],
-                                     ['dom.caches.enabled', true]]},
+                                     ['dom.caches.enabled', true],
+                                     ['dom.caches.testing.enabled', true]]},
                             function() {
     var privateWin = OpenBrowserWindow({private: true});
     privateWin.addEventListener('load', function() {
       Promise.all([
         testMatch(privateWin),
         testHas(privateWin),
         testOpen(privateWin),
         testDelete(privateWin),
diff --git a/dom/cache/test/mochitest/driver.js b/dom/cache/test/mochitest/driver.js
--- a/dom/cache/test/mochitest/driver.js
+++ b/dom/cache/test/mochitest/driver.js
@@ -16,16 +16,17 @@
 // The caller of this function is responsible to call SimpleTest.finish
 // when the returned promise is resolved.
 
 function runTests(testFile, order) {
   function setupPrefs() {
     return new Promise(function(resolve, reject) {
       SpecialPowers.pushPrefEnv({
         "set": [["dom.caches.enabled", true],
+                ["dom.caches.testing.enabled", true],
                 ["dom.serviceWorkers.enabled", true],
                 ["dom.serviceWorkers.testing.enabled", true],
                 ["dom.serviceWorkers.exemptFromPerDomainMax", true]]
       }, function() {
         resolve();
       });
     });
   }
diff --git a/dom/cache/test/mochitest/test_cache_orphaned_body.html b/dom/cache/test/mochitest/test_cache_orphaned_body.html
--- a/dom/cache/test/mochitest/test_cache_orphaned_body.html
+++ b/dom/cache/test/mochitest/test_cache_orphaned_body.html
@@ -71,16 +71,17 @@ function gc() {
   return new Promise(function(resolve, reject) {
     SpecialPowers.exactGC(window, resolve);
   });
 }
 
 SimpleTest.waitForExplicitFinish();
 SpecialPowers.pushPrefEnv({
   "set": [["dom.caches.enabled", true],
+          ["dom.caches.testing.enabled", true],
           ["dom.quotaManager.testing", true]],
 }, function() {
   var name = 'orphanedBodyOwner';
   var cache = null;
   var response = null;
   var initialUsage = 0;
   var fullUsage = 0;
   var resetUsage = 0;
diff --git a/dom/cache/test/mochitest/test_cache_orphaned_cache.html b/dom/cache/test/mochitest/test_cache_orphaned_cache.html
--- a/dom/cache/test/mochitest/test_cache_orphaned_cache.html
+++ b/dom/cache/test/mochitest/test_cache_orphaned_cache.html
@@ -71,16 +71,17 @@ function gc() {
   return new Promise(function(resolve, reject) {
     SpecialPowers.exactGC(window, resolve);
   });
 }
 
 SimpleTest.waitForExplicitFinish();
 SpecialPowers.pushPrefEnv({
   "set": [["dom.caches.enabled", true],
+          ["dom.caches.testing.enabled", true],
           ["dom.quotaManager.testing", true]],
 }, function() {
   var name = 'toBeOrphaned';
   var cache = null;
   var initialUsage = 0;
   var fullUsage = 0;
   var resetUsage = 0;
   var endUsage = 0;
diff --git a/dom/cache/test/mochitest/test_cache_restart.html b/dom/cache/test/mochitest/test_cache_restart.html
--- a/dom/cache/test/mochitest/test_cache_restart.html
+++ b/dom/cache/test/mochitest/test_cache_restart.html
@@ -34,16 +34,17 @@ function resetStorage() {
     SpecialPowers.resetStorageForURI(document.documentURI, resolve, appId,
                                      inBrowser);
   });
 }
 
 SimpleTest.waitForExplicitFinish();
 SpecialPowers.pushPrefEnv({
   "set": [["dom.caches.enabled", true],
+          ["dom.caches.testing.enabled", true],
           ["dom.quotaManager.testing", true]],
 }, function() {
   var name = 'foo';
   var url = './test_cache_add.js';
   var cache;
   setupTestIframe().then(function() {
     return caches.open(name);
   }).then(function(c) {
diff --git a/dom/cache/test/mochitest/test_cache_shrink.html b/dom/cache/test/mochitest/test_cache_shrink.html
--- a/dom/cache/test/mochitest/test_cache_shrink.html
+++ b/dom/cache/test/mochitest/test_cache_shrink.html
@@ -71,16 +71,17 @@ function gc() {
   return new Promise(function(resolve, reject) {
     SpecialPowers.exactGC(window, resolve);
   });
 }
 
 SimpleTest.waitForExplicitFinish();
 SpecialPowers.pushPrefEnv({
   "set": [["dom.caches.enabled", true],
+          ["dom.caches.testing.enabled", true],
           ["dom.quotaManager.testing", true]],
 }, function() {
   var name = 'foo';
   var cache = null;
   var initialUsage = 0;
   var fullUsage = 0;
   var endUsage = 0;
   // start from a fresh origin directory so other tests do not influence our
diff --git a/dom/cache/test/mochitest/test_chrome_constructor.html b/dom/cache/test/mochitest/test_chrome_constructor.html
--- a/dom/cache/test/mochitest/test_chrome_constructor.html
+++ b/dom/cache/test/mochitest/test_chrome_constructor.html
@@ -9,17 +9,18 @@
 </head>
 <body>
 <script class="testbody" type="text/javascript">
   var Cu = Components.utils;
   Cu.import('resource://gre/modules/Services.jsm');
   SimpleTest.waitForExplicitFinish();
 
   SpecialPowers.pushPrefEnv({
-    "set": [["dom.caches.enabled", true]],
+    "set": [["dom.caches.enabled", true],
+            ["dom.caches.testing.enabled", true]],
   }, function() {
     // attach to a different origin's CacheStorage
     var url = 'http://example.com/';
     var uri = Services.io.newURI(url, null, null);
     var principal = Services.scriptSecurityManager.getNoAppCodebasePrincipal(uri);
     var storage = new CacheStorage('content', principal);
 
     // verify we can use the other origin's CacheStorage as normal
diff --git a/dom/workers/test/serviceworkers/test_installation_simple.html b/dom/workers/test/serviceworkers/test_installation_simple.html
--- a/dom/workers/test/serviceworkers/test_installation_simple.html
+++ b/dom/workers/test/serviceworkers/test_installation_simple.html
@@ -199,15 +199,16 @@
   }
 
   SimpleTest.waitForExplicitFinish();
   SpecialPowers.pushPrefEnv({"set": [
     ["dom.serviceWorkers.exemptFromPerDomainMax", true],
     ["dom.serviceWorkers.interception.enabled", true],
     ["dom.messageChannel.enabled", true],
     ["dom.serviceWorkers.enabled", true],
-    ["dom.serviceWorkers.testing.enabled", true]
+    ["dom.serviceWorkers.testing.enabled", true],
+    ["dom.caches.testing.enabled", true],
   ]}, runTest);
 </script>
 </pre>
 </body>
 </html>
 
