# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  a456475502b80a1264642d9eaee9394a8fad8315
Bug 1447871 Call DisconnectFromOwner() on service worker binding objects in FreeInnerObjects(). r=smaug

diff --git a/dom/base/nsGlobalWindowInner.cpp b/dom/base/nsGlobalWindowInner.cpp
--- a/dom/base/nsGlobalWindowInner.cpp
+++ b/dom/base/nsGlobalWindowInner.cpp
@@ -1374,16 +1374,33 @@ nsGlobalWindowInner::FreeInnerObjects()
     }
     mBeforeUnloadListenerCount = 0;
   }
 
   // If we have any promiseDocumentFlushed callbacks, fire them now so
   // that the Promises can resolve.
   CallDocumentFlushedResolvers();
   mObservingDidRefresh = false;
+
+  // Disconnect service worker objects in FreeInnerObjects().  This is normally
+  // done from CleanUp().  In the future we plan to unify CleanUp() and
+  // FreeInnerObjects().
+  ForEachEventTargetObject([&] (DOMEventTargetHelper* aTarget, bool* aDoneOut) {
+    RefPtr<ServiceWorkerRegistration> swr = do_QueryObject(aTarget);
+    if (swr) {
+      aTarget->DisconnectFromOwner();
+      return;
+    }
+
+    RefPtr<ServiceWorker> sw = do_QueryObject(aTarget);
+    if (sw) {
+      aTarget->DisconnectFromOwner();
+      return;
+    }
+  });
 }
 
 //*****************************************************************************
 // nsGlobalWindowInner::nsISupports
 //*****************************************************************************
 
 // QueryInterface implementation for nsGlobalWindowInner
 NS_INTERFACE_MAP_BEGIN_CYCLE_COLLECTION(nsGlobalWindowInner)
