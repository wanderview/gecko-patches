# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  4f95b92a8a65320d2cc8381fba050cb9b61d2032

diff --git a/dom/serviceworkers/ServiceWorkerContainer.cpp b/dom/serviceworkers/ServiceWorkerContainer.cpp
--- a/dom/serviceworkers/ServiceWorkerContainer.cpp
+++ b/dom/serviceworkers/ServiceWorkerContainer.cpp
@@ -548,16 +548,28 @@ ServiceWorkerContainer::GetReady(ErrorRe
       nsIGlobalObject* global = self->GetGlobalIfValid(rv);
       if (rv.Failed()) {
         outer->MaybeReject(rv);
         return;
       }
       RefPtr<ServiceWorkerRegistration> reg =
         global->GetOrCreateServiceWorkerRegistration(aDescriptor);
       NS_ENSURE_TRUE_VOID(reg);
+
+      // Force update the registration's state if it was pre-existing,
+      // but does not yet know about the active worker.  This is not
+      // exactly correct since it may cause the registration and workers
+      // to skip some statechange events.
+      // TODO: Consider adding an API that lets us receive a callback
+      //       when the registration reaches a particular state version
+      //       number.
+      if (reg->Descriptor().GetActive().isNothing()) {
+        reg->UpdateState(aDescriptor);
+      }
+
       outer->MaybeResolve(reg);
     }, [self, outer] (ErrorResult& aRv) {
       outer->MaybeReject(aRv);
     });
 
   return mReadyPromise;
 }
 
