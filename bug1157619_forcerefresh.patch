# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  1dc2028980d56b23105b019f5ca80d66276fd98d
Bug 1157619 Network requests should not be intercepted when force-refreshed. r=jdm

diff --git a/netwerk/protocol/http/HttpBaseChannel.cpp b/netwerk/protocol/http/HttpBaseChannel.cpp
--- a/netwerk/protocol/http/HttpBaseChannel.cpp
+++ b/netwerk/protocol/http/HttpBaseChannel.cpp
@@ -2062,17 +2062,24 @@ HttpBaseChannel::IsNavigation()
 }
 
 bool
 HttpBaseChannel::ShouldIntercept()
 {
   nsCOMPtr<nsINetworkInterceptController> controller;
   GetCallback(controller);
   bool shouldIntercept = false;
-  if (controller && !mForceNoIntercept) {
+  // Per step 12.1 of the ServiceWorker HandleFetch algorithm, we must
+  // not intercept if the navigation was due to a shift-refresh or
+  // equivalent.  Check for the LOAD_BYPASS_CACHE flag to detect such
+  // a force refresh.  When bug 1120715 lands we will need a way to
+  // distinguish a top level force refresh from a fetch() with a 'no-cache'
+  // RequestCache value.
+  if (controller && !mForceNoIntercept &&
+      !(mLoadFlags & nsIRequest::LOAD_BYPASS_CACHE)) {
     nsresult rv = controller->ShouldPrepareForIntercept(mURI,
                                                         IsNavigation(),
                                                         &shouldIntercept);
     NS_ENSURE_SUCCESS(rv, false);
   }
   return shouldIntercept;
 }
 
