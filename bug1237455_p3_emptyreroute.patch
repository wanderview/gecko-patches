# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  60882206d57e62624c34a03be7ec3b698f870a8e
Bug 1237455 P3 Add a version of test_fetch_cors that reroutes through an empty service worker. r=ehsan

diff --git a/dom/tests/mochitest/fetch/empty.js b/dom/tests/mochitest/fetch/empty.js
new file mode 100644
diff --git a/dom/tests/mochitest/fetch/reroute.js^headers^ b/dom/tests/mochitest/fetch/empty.js^headers^
copy from dom/tests/mochitest/fetch/reroute.js^headers^
copy to dom/tests/mochitest/fetch/empty.js^headers^
diff --git a/dom/tests/mochitest/fetch/mochitest.ini b/dom/tests/mochitest/fetch/mochitest.ini
--- a/dom/tests/mochitest/fetch/mochitest.ini
+++ b/dom/tests/mochitest/fetch/mochitest.ini
@@ -11,36 +11,44 @@ support-files =
   test_response.js
   utils.js
   worker_wrapper.js
   message_receiver.html
   reroute.html
   reroute.js
   reroute.js^headers^
   sw_reroute.js
+  empty.js
+  empty.js^headers^
 
 [test_headers.html]
 [test_headers_sw_reroute.html]
 skip-if = buildapp == 'b2g' # Bug 1137683
 [test_headers_mainthread.html]
 skip-if = (e10s && debug && os == 'win')
 [test_fetch_app_protocol.html]
 skip-if = (e10s && debug && os == 'win')
 [test_fetch_basic.html]
 skip-if = (e10s && debug && os == 'win')
 [test_fetch_basic_sw_reroute.html]
 skip-if = buildapp == 'b2g' || (e10s && debug && os == 'win') # Bug 1137683
+[test_fetch_basic_sw_empty_reroute.html]
+skip-if = buildapp == 'b2g'
 [test_fetch_basic_http.html]
 skip-if = (e10s && debug && os == 'win')
 [test_fetch_basic_http_sw_reroute.html]
 skip-if = buildapp == 'b2g' || (e10s && debug && os == 'win') # Bug 1137683
+[test_fetch_basic_http_sw_empty_reroute.html]
+skip-if = buildapp == 'b2g'
 [test_fetch_cors.html]
 skip-if = buildapp == 'b2g' || (toolkit == 'android' && debug) || (e10s && debug && os == 'win') # Bug 1210552 && 1210282
 [test_fetch_cors_sw_reroute.html]
 skip-if = buildapp == 'b2g' || (toolkit == 'android' && debug) || (e10s && debug && os == 'win') # Bug 1137683 && 1210282
+[test_fetch_cors_sw_empty_reroute.html]
+skip-if = buildapp == 'b2g'
 [test_formdataparsing.html]
 skip-if = (e10s && debug && os == 'win')
 [test_formdataparsing_sw_reroute.html]
 skip-if = buildapp == 'b2g' || (e10s && debug && os == 'win') # Bug 1137683
 [test_request.html]
 skip-if = (e10s && debug && os == 'win')
 [test_request_cache.html]
 skip-if = (e10s && debug && os == 'win')
diff --git a/dom/tests/mochitest/fetch/reroute.html b/dom/tests/mochitest/fetch/reroute.html
--- a/dom/tests/mochitest/fetch/reroute.html
+++ b/dom/tests/mochitest/fetch/reroute.html
@@ -1,11 +1,18 @@
 <!DOCTYPE html>
 <script>
 ["SimpleTest", "ok", "info", "is", "$"]
   .forEach((v) => window[v] = window.parent[v]);
 </script>
 <script type="text/javascript" src="utils.js"> </script>
 <script type="text/javascript" src="fetch_test_framework.js"> </script>
 <script>
-window.isSWPresent = true;
+// If we are using the empty service worker then requests won't actually
+// get intercepted and response URLs will reflect redirects.  This means
+// all our checks should use the "no sw" logic.  Otherwise we need to
+// note that interceptions are taking place so we can adjust our
+// response URL expectations.
+if (!navigator.serviceWorker.controller.scriptURL.endsWith('empty.js')) {
+  window.isSWPresent = true;
+}
 testScript(location.search.substring(1) + ".js");
 </script>
diff --git a/dom/tests/mochitest/fetch/sw_reroute.js b/dom/tests/mochitest/fetch/sw_reroute.js
--- a/dom/tests/mochitest/fetch/sw_reroute.js
+++ b/dom/tests/mochitest/fetch/sw_reroute.js
@@ -12,17 +12,19 @@ function testScript(script) {
   SpecialPowers.pushPrefEnv({
     "set": [["dom.requestcache.enabled", true],
             ["dom.serviceWorkers.enabled", true],
             ["dom.serviceWorkers.interception.opaque.enabled", true],
             ["dom.serviceWorkers.testing.enabled", true],
             ["dom.serviceWorkers.exemptFromPerDomainMax", true]]
   }, function() {
     navigator.serviceWorker.ready.then(setupSW);
-    navigator.serviceWorker.register("reroute.js", {scope: "/"});
+    var scriptURL = location.href.includes("sw_empty_reroute.html")
+                  ? "empty.js" : "reroute.js";
+    navigator.serviceWorker.register(scriptURL, {scope: "/"});
   });
 }
 
 function finishTest() {
   gRegistration.unregister().then(SimpleTest.finish, function(e) {
     dump("unregistration failed: " + e + "\n");
     SimpleTest.finish();
   });
diff --git a/dom/tests/mochitest/fetch/test_fetch_basic_http_sw_reroute.html b/dom/tests/mochitest/fetch/test_fetch_basic_http_sw_empty_reroute.html
copy from dom/tests/mochitest/fetch/test_fetch_basic_http_sw_reroute.html
copy to dom/tests/mochitest/fetch/test_fetch_basic_http_sw_empty_reroute.html
diff --git a/dom/tests/mochitest/fetch/test_fetch_basic_sw_reroute.html b/dom/tests/mochitest/fetch/test_fetch_basic_sw_empty_reroute.html
copy from dom/tests/mochitest/fetch/test_fetch_basic_sw_reroute.html
copy to dom/tests/mochitest/fetch/test_fetch_basic_sw_empty_reroute.html
diff --git a/dom/tests/mochitest/fetch/test_fetch_cors_sw_reroute.html b/dom/tests/mochitest/fetch/test_fetch_cors_sw_empty_reroute.html
copy from dom/tests/mochitest/fetch/test_fetch_cors_sw_reroute.html
copy to dom/tests/mochitest/fetch/test_fetch_cors_sw_empty_reroute.html
