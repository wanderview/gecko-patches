# HG changeset patch
# User Eden Chuang <echuang@mozilla.com>
# Date 1509417262 -28800
#      Tue Oct 31 10:34:22 2017 +0800
# Node ID ad53a6999e68a3efaa2af679b511e339d87604be
# Parent  083a9c84fbd09a6ff9bfecabbf773650842fe1c0
Bug 1413056 - Using utils.js in test_bug1408734.html for waitForState and waitForControlled. r?tt

diff --git a/dom/workers/test/serviceworkers/test_bug1408734.html b/dom/workers/test/serviceworkers/test_bug1408734.html
--- a/dom/workers/test/serviceworkers/test_bug1408734.html
+++ b/dom/workers/test/serviceworkers/test_bug1408734.html
@@ -5,16 +5,17 @@
 <!DOCTYPE HTML>
 <html>
 <head>
   <title>Bug 1408734</title>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>
   <script src="/tests/SimpleTest/SimpleTest.js"></script>
   <script src="/tests/SimpleTest/SpawnTask.js"></script>
   <script src="error_reporting_helpers.js"></script>
+  <script src="utils.js"></script>
 </head>
 <body>
 <p id="display"></p>
 <div id="content" style="display: none"></div>
 <pre id="test"></pre>
 <script class="testbody" type="text/javascript">
 
 // setup prefs
@@ -22,27 +23,27 @@ add_task(() => {
   return SpecialPowers.pushPrefEnv({"set": [
     ["dom.serviceWorkers.enabled", true],
     ["dom.serviceWorkers.testing.enabled", true],
   ]});
 });
 
 // test for bug 1408734
 add_task(async () => {
-  let waitForControlled = new Promise((resolve) => {
-    navigator.serviceWorker.oncontrollerchange = resolve;
-  });
-
   // register a service worker
   let registration = await navigator.serviceWorker.register("fetch.js", {scope: "./"});
-  let worker = registration.installing || registration.active;
+  let sw = registration.installing || registration.active;
+
+
+  // wait for service worker be activated
+  await waitForState(sw, 'activated');
 
   // wait for control changed
-  worker.postMessage('claim');
-  await waitForControlled;
+  sw.postMessage('claim');
+  await waitForControlled(window);
 
   // get the ServiceWorkerRegistration we just register through GetRegistration
   registration = await navigator.serviceWorker.getRegistration("./");
   ok(registration, "should get the registration under scope './'");
 
   // call unregister()
   await registration.unregister();
 
