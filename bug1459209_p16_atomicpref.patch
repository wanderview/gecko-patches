# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  308e8ca4bd9ad23416e99fce8ebc1c944a328616
Bug 1459209 P16 Allow ServiceWorkerParentInterceptEnabled() to be used off-main-thread. r=baku

diff --git a/dom/serviceworkers/ServiceWorkerUtils.cpp b/dom/serviceworkers/ServiceWorkerUtils.cpp
--- a/dom/serviceworkers/ServiceWorkerUtils.cpp
+++ b/dom/serviceworkers/ServiceWorkerUtils.cpp
@@ -12,28 +12,24 @@
 #include "nsIURL.h"
 
 namespace mozilla {
 namespace dom {
 
 bool
 ServiceWorkerParentInterceptEnabled()
 {
-  // For right now we only support main thread.  In the future we could make
-  // this use an atomic bool if we need to support worker threads.
-  MOZ_ASSERT(NS_IsMainThread());
-
   static bool sInit = false;
-  static bool sEnabled;
+  static Atomic<bool> sEnabled;
 
   if (!sInit) {
     MOZ_ASSERT(NS_IsMainThread());
-    Preferences::AddBoolVarCache(&sEnabled,
-                                 "dom.serviceWorkers.parent_intercept",
-                                 false);
+    Preferences::AddAtomicBoolVarCache(&sEnabled,
+                                       "dom.serviceWorkers.parent_intercept",
+                                       false);
     sInit = true;
   }
 
   return sEnabled;
 }
 
 bool
 ServiceWorkerRegistrationDataIsValid(const ServiceWorkerRegistrationData& aData)
