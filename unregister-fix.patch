# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  e40699977332ab1c18c7b38cdc6929b93a2f228c

diff --git a/dom/workers/ServiceWorkerManager.cpp b/dom/workers/ServiceWorkerManager.cpp
--- a/dom/workers/ServiceWorkerManager.cpp
+++ b/dom/workers/ServiceWorkerManager.cpp
@@ -2492,18 +2492,35 @@ ServiceWorkerManager::DispatchFetchEvent
 
   if (!nsContentUtils::IsNonSubresourceRequest(internalChannel)) {
     const Maybe<ServiceWorkerDescriptor>& controller = loadInfo->GetController();
     if (NS_WARN_IF(controller.isNothing())) {
       aRv.Throw(NS_ERROR_FAILURE);
       return;
     }
 
-    serviceWorker = GetActiveWorkerInfoForDescriptor(controller.ref());
-    if (NS_WARN_IF(!serviceWorker)) {
+    nsCOMPtr<nsIPrincipal> principal =
+      PrincipalInfoToPrincipal(controller.ref().PrincipalInfo());
+
+    nsAutoCString scopeKey;
+    aRv = PrincipalToScopeKey(principal, scopeKey);
+    if (NS_WARN_IF(aRv.Failed())) {
+      return;
+    }
+
+    RefPtr<ServiceWorkerRegistrationInfo> registration =
+      GetRegistration(scopeKey, controller.ref().Scope());
+    if (NS_WARN_IF(!registration)) {
+      aRv.Throw(NS_ERROR_FAILURE);
+      return;
+    }
+
+    serviceWorker = registration->GetActive();
+    if (NS_WARN_IF(!serviceWorker) ||
+        NS_WARN_IF(serviceWorker->Descriptor().Id() != controller.ref().Id())) {
       aRv.Throw(NS_ERROR_FAILURE);
       return;
     }
   } else {
     nsCOMPtr<nsIURI> uri;
     aRv = aChannel->GetSecureUpgradedChannelURI(getter_AddRefs(uri));
     if (NS_WARN_IF(aRv.Failed())) {
       return;
