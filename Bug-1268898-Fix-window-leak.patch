# HG changeset patch
# User The 8472 <bugzilla.mozilla.org@infinite-source.de>

Bug 1268898 - Fix leak in sdk/event/dom

diff --git a/addon-sdk/source/lib/sdk/event/dom.js b/addon-sdk/source/lib/sdk/event/dom.js
index df85f09..da99dec 100644
--- a/addon-sdk/source/lib/sdk/event/dom.js
+++ b/addon-sdk/source/lib/sdk/event/dom.js
@@ -12,10 +12,11 @@
 
 var { emit } = require("./core");
 var { when: unload } = require("../system/unload");
-var listeners = new Map();
+var listeners = new WeakMap();
 
 const { Cu } = require("chrome");
 const { ShimWaiver } = Cu.import("resource://gre/modules/ShimWaiver.jsm");
+const { ThreadSafeChromeUtils } = Cu.import("resource://gre/modules/Services.jsm", {});
 
 var getWindowFrom = x =>
                     x instanceof Ci.nsIDOMWindow ? x :
@@ -69,7 +70,8 @@
 }
 
 unload(() => {
-  for (let window of listeners.keys())
+  let keys = ThreadSafeChromeUtils.nondeterministicGetWeakMapKeys(listeners)
+  for (let window of keys)
     removeFromListeners.call(window);
 });
 
