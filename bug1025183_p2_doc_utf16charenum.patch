# HG changeset patch
# Parent 5f122a73ca2a90588b46a957e085b1c254a88626
# User Ben Kelly <ben@wanderview.com>
Bug 1025183 P2 Document how UTF16CharEnumerator treats buffer position on error.


diff --git a/xpcom/string/nsUTF8Utils.h b/xpcom/string/nsUTF8Utils.h
--- a/xpcom/string/nsUTF8Utils.h
+++ b/xpcom/string/nsUTF8Utils.h
@@ -162,16 +162,21 @@ private:
   }
 };
 
 
 /**
  * Extract the next UCS-4 character from the buffer and return it.  The
  * pointer passed in is advanced to the start of the next character in the
  * buffer.  If non-null, the err parameter is filled in if an error occurs.
+ *
+ * If an error occurs that causes UCS2_REPLACEMENT_CHAR to be returned, then
+ * the buffer will be updated to move only a single UCS-2 character.
+ *
+ * Any other error returns 0 and does not move the buffer position.
  */
 
 
 class UTF16CharEnumerator
 {
 public:
   static uint32_t NextChar(const char16_t** aBuffer, const char16_t* aEnd,
                            bool* aErr = nullptr)
@@ -254,20 +259,17 @@ public:
       NS_WARNING("got a low Surrogate but no high surrogate");
       if (aErr) {
         *aErr = true;
       }
       *aBuffer = p;
       return 0xFFFD;
     }
 
-    if (aErr) {
-      *aErr = true;
-    }
-    return 0;
+    MOZ_ASSERT_UNREACHABLE("Impossible UCS-2 character value.");
   }
 };
 
 
 /**
  * A character sink (see |copy_string| in nsAlgorithm.h) for converting
  * UTF-8 to UTF-16
  */
