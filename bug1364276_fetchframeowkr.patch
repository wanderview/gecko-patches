# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  1178b701781de2b1a5afb7b7d6b4954a3a7a51ba
Bug 1364276 Wait for service worker to activate before proceeding in tests. r=asuth

diff --git a/dom/tests/mochitest/fetch/fetch_test_framework.js b/dom/tests/mochitest/fetch/fetch_test_framework.js
--- a/dom/tests/mochitest/fetch/fetch_test_framework.js
+++ b/dom/tests/mochitest/fetch/fetch_test_framework.js
@@ -98,29 +98,18 @@ function testScript(script) {
         iframe.src = "message_receiver.html";
         iframe.onload = function() {
           worker.postMessage({ script: script });
         };
         document.body.appendChild(iframe);
       }
 
       navigator.serviceWorker.register("worker_wrapper.js", {scope: "."})
-        .then(function(registration) {
-          if (registration.installing) {
-            var done = false;
-            registration.installing.onstatechange = function() {
-              if (!done) {
-                done = true;
-                setupSW(registration);
-              }
-            };
-          } else {
-            setupSW(registration);
-          }
-        });
+        .then(swr => waitForState(swr.installing, 'activated', swr))
+        .then(setupSW);
     });
   }
 
   function windowTest() {
     return new Promise(function(resolve, reject) {
       var scriptEl = document.createElement("script");
       scriptEl.setAttribute("src", script);
       scriptEl.onload = function() {
diff --git a/dom/tests/mochitest/fetch/sw_reroute.js b/dom/tests/mochitest/fetch/sw_reroute.js
--- a/dom/tests/mochitest/fetch/sw_reroute.js
+++ b/dom/tests/mochitest/fetch/sw_reroute.js
@@ -9,20 +9,21 @@ function testScript(script) {
     document.body.appendChild(iframe);
   }
 
   SpecialPowers.pushPrefEnv({
     "set": [["dom.serviceWorkers.enabled", true],
             ["dom.serviceWorkers.testing.enabled", true],
             ["dom.serviceWorkers.exemptFromPerDomainMax", true]]
   }, function() {
-    navigator.serviceWorker.ready.then(setupSW);
     var scriptURL = location.href.includes("sw_empty_reroute.html")
                   ? "empty.js" : "reroute.js";
-    navigator.serviceWorker.register(scriptURL, {scope: "/"});
+    navigator.serviceWorker.register(scriptURL, {scope: "/"})
+      .then(swr => waitForState(swr.installing, 'activated', swr))
+      .then(setupSW);
   });
 }
 
 function finishTest() {
   gRegistration.unregister().then(SimpleTest.finish, function(e) {
     dump("unregistration failed: " + e + "\n");
     SimpleTest.finish();
   });
diff --git a/dom/tests/mochitest/fetch/test_fetch_basic_http_sw_empty_reroute.html b/dom/tests/mochitest/fetch/test_fetch_basic_http_sw_empty_reroute.html
--- a/dom/tests/mochitest/fetch/test_fetch_basic_http_sw_empty_reroute.html
+++ b/dom/tests/mochitest/fetch/test_fetch_basic_http_sw_empty_reroute.html
@@ -8,15 +8,16 @@
   <title>Bug 1039846 - Test fetch() http fetching in worker</title>
   <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
 </head>
 <body>
 <p id="display"></p>
 <div id="content" style="display: none"></div>
 <pre id="test"></pre>
+<script type="text/javascript" src="utils.js"> </script>
 <script type="text/javascript" src="sw_reroute.js"> </script>
 <script class="testbody" type="text/javascript">
 testScript("test_fetch_basic_http.js");
 </script>
 </body>
 </html>
 
diff --git a/dom/tests/mochitest/fetch/test_fetch_basic_http_sw_reroute.html b/dom/tests/mochitest/fetch/test_fetch_basic_http_sw_reroute.html
--- a/dom/tests/mochitest/fetch/test_fetch_basic_http_sw_reroute.html
+++ b/dom/tests/mochitest/fetch/test_fetch_basic_http_sw_reroute.html
@@ -8,15 +8,16 @@
   <title>Bug 1039846 - Test fetch() http fetching in worker</title>
   <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
 </head>
 <body>
 <p id="display"></p>
 <div id="content" style="display: none"></div>
 <pre id="test"></pre>
+<script type="text/javascript" src="utils.js"> </script>
 <script type="text/javascript" src="sw_reroute.js"> </script>
 <script class="testbody" type="text/javascript">
 testScript("test_fetch_basic_http.js");
 </script>
 </body>
 </html>
 
diff --git a/dom/tests/mochitest/fetch/test_fetch_basic_sw_empty_reroute.html b/dom/tests/mochitest/fetch/test_fetch_basic_sw_empty_reroute.html
--- a/dom/tests/mochitest/fetch/test_fetch_basic_sw_empty_reroute.html
+++ b/dom/tests/mochitest/fetch/test_fetch_basic_sw_empty_reroute.html
@@ -8,15 +8,16 @@
   <title>Bug 1039846 - Test fetch() function in worker</title>
   <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
 </head>
 <body>
 <p id="display"></p>
 <div id="content" style="display: none"></div>
 <pre id="test"></pre>
+<script type="text/javascript" src="utils.js"> </script>
 <script type="text/javascript" src="sw_reroute.js"> </script>
 <script class="testbody" type="text/javascript">
 testScript("test_fetch_basic.js");
 </script>
 </body>
 </html>
 
diff --git a/dom/tests/mochitest/fetch/test_fetch_basic_sw_reroute.html b/dom/tests/mochitest/fetch/test_fetch_basic_sw_reroute.html
--- a/dom/tests/mochitest/fetch/test_fetch_basic_sw_reroute.html
+++ b/dom/tests/mochitest/fetch/test_fetch_basic_sw_reroute.html
@@ -8,15 +8,16 @@
   <title>Bug 1039846 - Test fetch() function in worker</title>
   <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
 </head>
 <body>
 <p id="display"></p>
 <div id="content" style="display: none"></div>
 <pre id="test"></pre>
+<script type="text/javascript" src="utils.js"> </script>
 <script type="text/javascript" src="sw_reroute.js"> </script>
 <script class="testbody" type="text/javascript">
 testScript("test_fetch_basic.js");
 </script>
 </body>
 </html>
 
diff --git a/dom/tests/mochitest/fetch/test_fetch_cors_sw_empty_reroute.html b/dom/tests/mochitest/fetch/test_fetch_cors_sw_empty_reroute.html
--- a/dom/tests/mochitest/fetch/test_fetch_cors_sw_empty_reroute.html
+++ b/dom/tests/mochitest/fetch/test_fetch_cors_sw_empty_reroute.html
@@ -8,15 +8,16 @@
   <title>Bug 1039846 - Test fetch() CORS mode</title>
   <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
 </head>
 <body>
 <p id="display"></p>
 <div id="content" style="display: none"></div>
 <pre id="test"></pre>
+<script type="text/javascript" src="utils.js"> </script>
 <script type="text/javascript" src="sw_reroute.js"> </script>
 <script class="testbody" type="text/javascript">
 testScript("test_fetch_cors.js");
 </script>
 </body>
 </html>
 
diff --git a/dom/tests/mochitest/fetch/test_fetch_cors_sw_reroute.html b/dom/tests/mochitest/fetch/test_fetch_cors_sw_reroute.html
--- a/dom/tests/mochitest/fetch/test_fetch_cors_sw_reroute.html
+++ b/dom/tests/mochitest/fetch/test_fetch_cors_sw_reroute.html
@@ -8,15 +8,16 @@
   <title>Bug 1039846 - Test fetch() CORS mode</title>
   <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
 </head>
 <body>
 <p id="display"></p>
 <div id="content" style="display: none"></div>
 <pre id="test"></pre>
+<script type="text/javascript" src="utils.js"> </script>
 <script type="text/javascript" src="sw_reroute.js"> </script>
 <script class="testbody" type="text/javascript">
 testScript("test_fetch_cors.js");
 </script>
 </body>
 </html>
 
diff --git a/dom/tests/mochitest/fetch/test_formdataparsing_sw_reroute.html b/dom/tests/mochitest/fetch/test_formdataparsing_sw_reroute.html
--- a/dom/tests/mochitest/fetch/test_formdataparsing_sw_reroute.html
+++ b/dom/tests/mochitest/fetch/test_formdataparsing_sw_reroute.html
@@ -8,15 +8,16 @@
   <title>Bug 1109751 - Test FormData parsing</title>
   <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
 </head>
 <body>
 <p id="display"></p>
 <div id="content" style="display: none"></div>
 <pre id="test"></pre>
+<script type="text/javascript" src="utils.js"> </script>
 <script type="text/javascript" src="sw_reroute.js"> </script>
 <script class="testbody" type="text/javascript">
 testScript("test_formdataparsing.js");
 </script>
 </body>
 </html>
 
diff --git a/dom/tests/mochitest/fetch/test_headers_sw_reroute.html b/dom/tests/mochitest/fetch/test_headers_sw_reroute.html
--- a/dom/tests/mochitest/fetch/test_headers_sw_reroute.html
+++ b/dom/tests/mochitest/fetch/test_headers_sw_reroute.html
@@ -3,14 +3,15 @@
 <!DOCTYPE HTML>
 <html>
 <head>
   <title>Test Fetch Headers - Basic</title>
   <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
 </head>
 <body>
+<script type="text/javascript" src="utils.js"> </script>
 <script type="text/javascript" src="sw_reroute.js"> </script>
 <script class="testbody" type="text/javascript">
 testScript("test_headers_common.js");
 </script>
 </body>
 </html>
diff --git a/dom/tests/mochitest/fetch/test_request_sw_reroute.html b/dom/tests/mochitest/fetch/test_request_sw_reroute.html
--- a/dom/tests/mochitest/fetch/test_request_sw_reroute.html
+++ b/dom/tests/mochitest/fetch/test_request_sw_reroute.html
@@ -8,15 +8,16 @@
   <title>Test Request object in worker</title>
   <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
 </head>
 <body>
 <p id="display"></p>
 <div id="content" style="display: none"></div>
 <pre id="test"></pre>
+<script type="text/javascript" src="utils.js"> </script>
 <script type="text/javascript" src="sw_reroute.js"> </script>
 <script class="testbody" type="text/javascript">
 testScript("test_request.js");
 </script>
 </body>
 </html>
 
diff --git a/dom/tests/mochitest/fetch/test_response_sw_reroute.html b/dom/tests/mochitest/fetch/test_response_sw_reroute.html
--- a/dom/tests/mochitest/fetch/test_response_sw_reroute.html
+++ b/dom/tests/mochitest/fetch/test_response_sw_reroute.html
@@ -8,15 +8,16 @@
   <title>Bug 1039846 - Test Response object in worker</title>
   <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
 </head>
 <body>
 <p id="display"></p>
 <div id="content" style="display: none"></div>
 <pre id="test"></pre>
+<script type="text/javascript" src="utils.js"> </script>
 <script type="text/javascript" src="sw_reroute.js"> </script>
 <script class="testbody" type="text/javascript">
 testScript("test_response.js");
 </script>
 </body>
 </html>
 
diff --git a/dom/tests/mochitest/fetch/utils.js b/dom/tests/mochitest/fetch/utils.js
--- a/dom/tests/mochitest/fetch/utils.js
+++ b/dom/tests/mochitest/fetch/utils.js
@@ -30,8 +30,22 @@ function readAsArrayBuffer(blob) {
       fs.readAsArrayBuffer(blob);
     });
   } else {
     var fs = new FileReaderSync();
     return Promise.resolve(fs.readAsArrayBuffer(blob));
   }
 }
 
+function waitForState(worker, state, context) {
+  return new Promise(resolve => {
+    if (worker.state === state) {
+      resolve(context);
+      return;
+    }
+    worker.addEventListener('statechange', function onStateChange() {
+      if (worker.state === state) {
+        worker.removeEventListener('statechange', onStateChange);
+        resolve(context);
+      }
+    });
+  });
+}
