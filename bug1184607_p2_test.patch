# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  a8412d162c1f523483814a8613908618d0181319
Bug 1184607 P2 Add a wpt test to verify service worker redirect logic. r=ehsan

diff --git a/testing/web-platform/mozilla/meta/MANIFEST.json b/testing/web-platform/mozilla/meta/MANIFEST.json
--- a/testing/web-platform/mozilla/meta/MANIFEST.json
+++ b/testing/web-platform/mozilla/meta/MANIFEST.json
@@ -137,16 +137,22 @@
           }
         ],
         "service-workers/service-worker/fetch-event-network-error.https.html": [
           {
             "path": "service-workers/service-worker/fetch-event-network-error.https.html",
             "url": "/_mozilla/service-workers/service-worker/fetch-event-network-error.https.html"
           }
         ],
+        "service-workers/service-worker/fetch-event-redirect.https.html": [
+          {
+            "path": "service-workers/service-worker/fetch-event-redirect.https.html",
+            "url": "/_mozilla/service-workers/service-worker/fetch-event-redirect.https.html"
+          }
+        ],
         "service-workers/service-worker/fetch-event-respond-with-stops-propagation.https.html": [
           {
             "path": "service-workers/service-worker/fetch-event-respond-with-stops-propagation.https.html",
             "url": "/_mozilla/service-workers/service-worker/fetch-event-respond-with-stops-propagation.https.html"
           }
         ],
         "service-workers/service-worker/fetch-event.https.html": [
           {
diff --git a/testing/web-platform/mozilla/tests/service-workers/service-worker/fetch-event-redirect.https.html b/testing/web-platform/mozilla/tests/service-workers/service-worker/fetch-event-redirect.https.html
new file mode 100644
--- /dev/null
+++ b/testing/web-platform/mozilla/tests/service-workers/service-worker/fetch-event-redirect.https.html
@@ -0,0 +1,631 @@
+<!DOCTYPE html>
+<title>Service Worker: Fetch Event Redirect Handling</title>
+<script src="/resources/testharness.js"></script>
+<script src="resources/testharness-helpers.js"></script>
+<script src="/resources/testharnessreport.js"></script>
+<script src="resources/get-host-info.sub.js"></script>
+<script src="resources/test-helpers.sub.js"></script>
+<body>
+<script>
+
+// Test cases:
+//  Request(navigation-or-not, RequestRedirect, RequestMode), type of SW redirect
+
+// Request(Nav, manual, same-origin), SW fetches same-origin no-creds redirect
+//  - opaqueredirect, interception succeeds
+// Request(Nav, manual, same-origin), SW fetches cross-origin no-creds redirect
+//  - opaqueredirect, interception succeeds
+// Request(Nav, manual, same-origin), SW fetches same-origin creds redirect
+//  - opaqueredirect, interception succeeds
+// Request(Nav, manual, same-origin), SW fetches cross-origin creds redirect
+//  - opaqueredirect, interception succeeds
+
+// add redirect to data URI
+// add test where original redirect URI is cross-origin
+// add cross-origin with CORS headers
+// check that we get additional intercepts when following redirects
+// fixup test names to match final expectations
+
+var host_info = get_host_info();
+var worker = 'resources/fetch-rewrite-worker.js';
+var frameURL = host_info['HTTPS_ORIGIN'] + base_path() +
+               'resources/fetch-event-redirect-iframe.html';
+var baseScope = 'resources/';
+var redirect = 'redirect.py';
+var success = base_path() + 'resources/success.json';
+
+function redirect_fetch_test(t, test) {
+  var scope = baseScope + test.name;
+  service_worker_unregister_and_register(t, worker, scope).then(function(reg) {
+    return wait_for_state(t, reg.installing, 'activated');
+  }).then(function() {
+    return with_iframe(scope + '?url=' + encodeURIComponent(frameURL));
+  }).then(function(frame) {
+    var hostKeySuffix = test['url_credentials'] ? '_WITH_CREDS' : '';
+    var host = test['cross_origin']
+             ? host_info['HTTPS_REMOTE_ORIGIN' + hostKeySuffix]
+             : host_info['HTTPS_ORIGIN' + hostKeySuffix];
+    var expectedTypeParam = test['expected_type']
+                          ?  '&expected_type=' + test['expected_type']
+                          : '';
+    var url = scope +
+              '?url=' + encodeURIComponent(redirect + '?Redirect=' +
+                        encodeURIComponent(host + success)) +
+              expectedTypeParam
+
+    var p = new Promise(function(resolve, reject) {
+      var channel = new MessageChannel();
+      channel.port1.onmessage = function(e) {
+        if (e.data.result === 'reject') {
+          frame.remove();
+          reject(e.data.detail);
+        } else if (e.data.result === 'success') {
+          frame.remove();
+          resolve(e.data.result);
+        } else {
+          frame.remove();
+          resolve(e.data.detail);
+        }
+      };
+      frame.contentWindow.postMessage({
+        url: url,
+        request_init: test.request_init
+      }, '*', [channel.port2]);
+    });
+
+    if (test.should_reject) {
+      return assert_promise_rejects(p);
+    }
+
+    return p.then(function(result) {
+      if (result !== 'success') {
+        throw(new Error(result));
+      }
+    });
+  }).then(function() {
+    return service_worker_unregister_and_done(t, scope);
+  }).catch(unreached_rejection(t));
+}
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-manual-cors-redirects-to-sameorigin-nocreds',
+    cross_origin: false,
+    url_credentials: false,
+    expected_type: 'opaqueredirect',
+    request_init: {
+      redirect: 'manual',
+      mode: 'cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, manual redirect, cors mode Request redirected to ' +
+   'same-origin without credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-manual-cors-redirects-to-crossorigin-nocreds',
+    cross_origin: true,
+    url_credentials: false,
+    expected_type: 'opaqueredirect',
+    request_init: {
+      redirect: 'manual',
+      mode: 'cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, manual redirect, cors mode Request redirected to ' +
+   'cross-origin without credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-manual-sameorigin-redirects-to-sameorigin-nocreds',
+    cross_origin: false,
+    url_credentials: false,
+    expected_type: 'opaqueredirect',
+    request_init: {
+      redirect: 'manual',
+      mode: 'same-origin'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, manual redirect, same-origin mode Request redirected to ' +
+   'same-origin without credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-manual-sameorigin-redirects-to-crossorigin-nocreds',
+    cross_origin: true,
+    url_credentials: false,
+    expected_type: 'opaqueredirect',
+    request_init: {
+      redirect: 'manual',
+      mode: 'same-origin'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, manual redirect, same-origin mode Request redirected to ' +
+   'cross-origin without credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-manual-nocors-redirects-to-sameorigin-nocreds',
+    cross_origin: false,
+    url_credentials: false,
+    expected_type: 'opaqueredirect',
+    request_init: {
+      redirect: 'manual',
+      mode: 'no-cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, manual redirect, no-cors mode Request redirected to ' +
+   'same-origin without credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-manual-nocors-redirects-to-crossorigin-nocreds',
+    cross_origin: true,
+    url_credentials: false,
+    expected_type: 'opaqueredirect',
+    request_init: {
+      redirect: 'manual',
+      mode: 'no-cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, manual redirect, no-cors mode Request redirected to ' +
+   'cross-origin without credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-manual-cors-redirects-to-sameorigin-creds',
+    cross_origin: false,
+    url_credentials: true,
+    expected_type: 'opaqueredirect',
+    request_init: {
+      redirect: 'manual',
+      mode: 'cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, manual redirect, cors mode Request redirected to ' +
+   'same-origin with credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-manual-cors-redirects-to-crossorigin-creds',
+    cross_origin: true,
+    url_credentials: true,
+    expected_type: 'opaqueredirect',
+    request_init: {
+      redirect: 'manual',
+      mode: 'cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, manual redirect, cors mode Request redirected to ' +
+   'cross-origin with credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-manual-sameorigin-redirects-to-sameorigin-creds',
+    cross_origin: false,
+    url_credentials: true,
+    expected_type: 'opaqueredirect',
+    request_init: {
+      redirect: 'manual',
+      mode: 'same-origin'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, manual redirect, same-origin mode Request redirected to ' +
+   'same-origin with credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-manual-sameorigin-redirects-to-crossorigin-creds',
+    cross_origin: true,
+    url_credentials: true,
+    expected_type: 'opaqueredirect',
+    request_init: {
+      redirect: 'manual',
+      mode: 'same-origin'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, manual redirect, same-origin mode Request redirected to ' +
+   'cross-origin with credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-manual-nocors-redirects-to-sameorigin-creds',
+    cross_origin: false,
+    url_credentials: true,
+    expected_type: 'opaqueredirect',
+    request_init: {
+      redirect: 'manual',
+      mode: 'no-cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, manual redirect, no-cors mode Request redirected to ' +
+   'same-origin with credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-manual-nocors-redirects-to-crossorigin-creds',
+    cross_origin: true,
+    url_credentials: true,
+    expected_type: 'opaqueredirect',
+    request_init: {
+      redirect: 'manual',
+      mode: 'no-cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, manual redirect, no-cors mode Request redirected to ' +
+   'cross-origin with credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-follow-cors-redirects-to-sameorigin-nocreds',
+    cross_origin: false,
+    url_credentials: false,
+    expected_type: 'basic',
+    request_init: {
+      redirect: 'follow',
+      mode: 'cors'
+    },
+    should_reject: false
+  });
+}, 'Non-navigation, follow redirect, cors mode Request redirected to ' +
+   'same-origin without credentials should succeed interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-follow-cors-redirects-to-crossorigin-nocreds',
+    cross_origin: true,
+    url_credentials: false,
+    expected_type: 'basic',
+    request_init: {
+      redirect: 'follow',
+      mode: 'cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, follow redirect, cors mode Request redirected to ' +
+   'cross-origin without credentials should succeed interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-follow-sameorigin-redirects-to-sameorigin-nocreds',
+    cross_origin: false,
+    url_credentials: false,
+    expected_type: 'basic',
+    request_init: {
+      redirect: 'follow',
+      mode: 'same-origin'
+    },
+    should_reject: false
+  });
+}, 'Non-navigation, follow redirect, same-origin mode Request redirected to ' +
+   'same-origin without credentials should succeed interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-follow-sameorigin-redirects-to-crossorigin-nocreds',
+    cross_origin: true,
+    url_credentials: false,
+    expected_type: 'basic',
+    request_init: {
+      redirect: 'follow',
+      mode: 'same-origin'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, follow redirect, same-origin mode Request redirected to ' +
+   'cross-origin without credentials should succeed interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-follow-nocors-redirects-to-sameorigin-nocreds',
+    cross_origin: false,
+    url_credentials: false,
+    expected_type: 'basic',
+    request_init: {
+      redirect: 'follow',
+      mode: 'no-cors'
+    },
+    should_reject: false
+  });
+}, 'Non-navigation, follow redirect, no-cors mode Request redirected to ' +
+   'same-origin without credentials should succeed interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-follow-nocors-redirects-to-crossorigin-nocreds',
+    cross_origin: true,
+    url_credentials: false,
+    expected_type: 'basic',
+    request_init: {
+      redirect: 'follow',
+      mode: 'no-cors'
+    },
+    should_reject: false
+  });
+}, 'Non-navigation, follow redirect, no-cors mode Request redirected to ' +
+   'cross-origin without credentials should succeed interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-follow-cors-redirects-to-sameorigin-creds',
+    cross_origin: false,
+    url_credentials: true,
+    expected_type: 'basic',
+    request_init: {
+      redirect: 'follow',
+      mode: 'cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, follow redirect, cors mode Request redirected to ' +
+   'same-origin with credentials should succeed interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-follow-cors-redirects-to-crossorigin-creds',
+    cross_origin: true,
+    url_credentials: true,
+    expected_type: 'basic',
+    request_init: {
+      redirect: 'follow',
+      mode: 'cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, follow redirect, cors mode Request redirected to ' +
+   'cross-origin with credentials should succeed interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-follow-sameorigin-redirects-to-sameorigin-creds',
+    cross_origin: false,
+    url_credentials: true,
+    expected_type: 'basic',
+    request_init: {
+      redirect: 'follow',
+      mode: 'same-origin'
+    },
+    should_reject: false
+  });
+}, 'Non-navigation, follow redirect, same-origin mode Request redirected to ' +
+   'same-origin with credentials should succeed interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-follow-sameorigin-redirects-to-crossorigin-creds',
+    cross_origin: true,
+    url_credentials: true,
+    expected_type: 'basic',
+    request_init: {
+      redirect: 'follow',
+      mode: 'same-origin'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, follow redirect, same-origin mode Request redirected to ' +
+   'cross-origin with credentials should succeed interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-follow-nocors-redirects-to-sameorigin-creds',
+    cross_origin: false,
+    url_credentials: true,
+    expected_type: 'basic',
+    request_init: {
+      redirect: 'follow',
+      mode: 'no-cors'
+    },
+    should_reject: false
+  });
+}, 'Non-navigation, follow redirect, no-cors mode Request redirected to ' +
+   'same-origin with credentials should succeed interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-follow-nocors-redirects-to-crossorigin-creds',
+    cross_origin: true,
+    url_credentials: true,
+    expected_type: 'basic',
+    request_init: {
+      redirect: 'follow',
+      mode: 'no-cors'
+    },
+    should_reject: false
+  });
+}, 'Non-navigation, follow redirect, no-cors mode Request redirected to ' +
+   'cross-origin with credentials should succeed interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-error-cors-redirects-to-sameorigin-nocreds',
+    cross_origin: false,
+    url_credentials: false,
+    expected_type: 'error',
+    request_init: {
+      redirect: 'error',
+      mode: 'cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, error redirect, cors mode Request redirected to ' +
+   'same-origin without credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-error-cors-redirects-to-crossorigin-nocreds',
+    cross_origin: true,
+    url_credentials: false,
+    expected_type: 'error',
+    request_init: {
+      redirect: 'error',
+      mode: 'cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, error redirect, cors mode Request redirected to ' +
+   'cross-origin without credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-error-sameorigin-redirects-to-sameorigin-nocreds',
+    cross_origin: false,
+    url_credentials: false,
+    expected_type: 'error',
+    request_init: {
+      redirect: 'error',
+      mode: 'same-origin'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, error redirect, same-origin mode Request redirected to ' +
+   'same-origin without credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-error-sameorigin-redirects-to-crossorigin-nocreds',
+    cross_origin: true,
+    url_credentials: false,
+    expected_type: 'error',
+    request_init: {
+      redirect: 'error',
+      mode: 'same-origin'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, error redirect, same-origin mode Request redirected to ' +
+   'cross-origin without credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-error-nocors-redirects-to-sameorigin-nocreds',
+    cross_origin: false,
+    url_credentials: false,
+    expected_type: 'error',
+    request_init: {
+      redirect: 'error',
+      mode: 'no-cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, error redirect, no-cors mode Request redirected to ' +
+   'same-origin without credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-error-nocors-redirects-to-crossorigin-nocreds',
+    cross_origin: true,
+    url_credentials: false,
+    expected_type: 'error',
+    request_init: {
+      redirect: 'error',
+      mode: 'no-cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, error redirect, no-cors mode Request redirected to ' +
+   'cross-origin without credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-error-cors-redirects-to-sameorigin-creds',
+    cross_origin: false,
+    url_credentials: true,
+    expected_type: 'error',
+    request_init: {
+      redirect: 'error',
+      mode: 'cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, error redirect, cors mode Request redirected to ' +
+   'same-origin with credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-error-cors-redirects-to-crossorigin-creds',
+    cross_origin: true,
+    url_credentials: true,
+    expected_type: 'error',
+    request_init: {
+      redirect: 'error',
+      mode: 'cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, error redirect, cors mode Request redirected to ' +
+   'cross-origin with credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-error-sameorigin-redirects-to-sameorigin-creds',
+    cross_origin: false,
+    url_credentials: true,
+    expected_type: 'error',
+    request_init: {
+      redirect: 'error',
+      mode: 'same-origin'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, error redirect, same-origin mode Request redirected to ' +
+   'same-origin with credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-error-sameorigin-redirects-to-crossorigin-creds',
+    cross_origin: true,
+    url_credentials: true,
+    expected_type: 'error',
+    request_init: {
+      redirect: 'error',
+      mode: 'same-origin'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, error redirect, same-origin mode Request redirected to ' +
+   'cross-origin with credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-error-nocors-redirects-to-sameorigin-creds',
+    cross_origin: false,
+    url_credentials: true,
+    expected_type: 'error',
+    request_init: {
+      redirect: 'error',
+      mode: 'no-cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, error redirect, no-cors mode Request redirected to ' +
+   'same-origin with credentials should fail opaqueredirect interception');
+
+async_test(function(t) {
+  redirect_fetch_test(t, {
+    name: 'nonav-error-nocors-redirects-to-crossorigin-creds',
+    cross_origin: true,
+    url_credentials: true,
+    expected_type: 'error',
+    request_init: {
+      redirect: 'error',
+      mode: 'no-cors'
+    },
+    should_reject: true
+  });
+}, 'Non-navigation, error redirect, no-cors mode Request redirected to ' +
+   'cross-origin with credentials should fail opaqueredirect interception');
+
+</script>
+</body>
diff --git a/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/fetch-event-redirect-iframe.html b/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/fetch-event-redirect-iframe.html
new file mode 100644
--- /dev/null
+++ b/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/fetch-event-redirect-iframe.html
@@ -0,0 +1,19 @@
+<script>
+window.addEventListener('message', function(evt) {
+  var port = evt.ports[0];
+  executeFetch(evt.data).then(function(response) {
+    return response.json();
+  }).then(function(body) {
+    port.postMessage({result: body.result, detail: body.detail});
+  }).catch(function(e) {
+    port.postMessage({result: 'reject', detail: e.toString()});
+  });
+});
+
+function executeFetch(data) {
+  return new Promise(function(resolve, reject) {
+    var request = new Request(data.url, data.request_init);
+    fetch(request).then(resolve, reject);
+  });
+}
+</script>
diff --git a/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/fetch-rewrite-worker.js b/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/fetch-rewrite-worker.js
--- a/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/fetch-rewrite-worker.js
+++ b/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/fetch-rewrite-worker.js
@@ -7,33 +7,28 @@ function get_query_params(url) {
   var params = search.substring(1).split('&');
   params.forEach(function(param) {
       var element = param.split('=');
       ret[decodeURIComponent(element[0])] = decodeURIComponent(element[1]);
     });
   return ret;
 }
 
-function get_request_init(params) {
+function get_request_init(base, params) {
   var init = {};
-  if (params['method']) {
-    init['method'] = params['method'];
-  }
-  if (params['mode']) {
-    init['mode'] = params['mode'];
-  }
-  if (params['credentials']) {
-    init['credentials'] = params['credentials'];
-  }
+  init['method'] = params['method'] || base['method'];
+  init['mode'] = params['mode'] || base['mode'];
+  init['credentials'] = params['credentials'] || base['credentials'];
+  init['redirect'] = params['redirect'] || base['redirect'];
   return init;
 }
 
 self.addEventListener('fetch', function(event) {
     var params = get_query_params(event.request.url);
-    var init = get_request_init(params);
+    var init = get_request_init(event.request, params);
     var url = params['url'];
     if (params['ignore']) {
       return;
     }
     if (params['reject']) {
       event.respondWith(new Promise(function(resolve, reject) {
           reject();
         }));
@@ -57,11 +52,24 @@ self.addEventListener('fetch', function(
       event.respondWith(new Response(new Blob([array], {type: 'image/png'})));
       return;
     }
     event.respondWith(new Promise(function(resolve, reject) {
         var request = event.request;
         if (url) {
           request = new Request(url, init);
         }
-        fetch(request).then(resolve, reject);
+        fetch(request).then(function(response) {
+          var expectedType = params['expected_type'];
+          if (expectedType && response.type !== expectedType) {
+            // Resolve a JSON object with a failure instead of rejecting
+            // in order to distinguish this from a NetworkError, which
+            // may be expected even if the type is correct.
+            resolve(new Response(JSON.stringify({
+              result: 'failure',
+              detail: 'got ' + response.type + ' Response.type instead of ' +
+                      expectedType
+            })));
+          }
+          resolve(response);
+        }, reject)
       }));
   });
diff --git a/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/get-host-info.sub.js b/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/get-host-info.sub.js
--- a/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/get-host-info.sub.js
+++ b/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/get-host-info.sub.js
@@ -12,13 +12,15 @@ function get_host_info() {
     HTTPS_PORT = eval('{{ports[https][0]}}');
     ORIGINAL_HOST = eval('\'{{host}}\'');
     REMOTE_HOST = 'www1.' + ORIGINAL_HOST;
   } catch (e) {
   }
   return {
     HTTP_ORIGIN: 'http://' + ORIGINAL_HOST + ':' + HTTP_PORT,
     HTTPS_ORIGIN: 'https://' + ORIGINAL_HOST + ':' + HTTPS_PORT,
+    HTTPS_ORIGIN_WITH_CREDS: 'https://foo:bar@' + ORIGINAL_HOST + ':' + HTTPS_PORT,
     HTTP_REMOTE_ORIGIN: 'http://' + REMOTE_HOST + ':' + HTTP_PORT,
     HTTPS_REMOTE_ORIGIN: 'https://' + REMOTE_HOST + ':' + HTTPS_PORT,
+    HTTPS_REMOTE_ORIGIN_WITH_CREDS: 'https://foo:bar@' + REMOTE_HOST + ':' + HTTPS_PORT,
     UNAUTHENTICATED_ORIGIN: 'http://' + UNAUTHENTICATED_HOST + ':' + HTTP_PORT
   };
 }
diff --git a/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/redirect.py b/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/redirect.py
new file mode 100644
--- /dev/null
+++ b/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/redirect.py
@@ -0,0 +1,25 @@
+def main(request, response):
+    if 'Status' in request.GET:
+        status = int(request.GET["status"])
+    else:
+        status = 302
+
+    headers = []
+
+    url = request.GET['Redirect']
+    headers.append(("Location", url))
+
+    if "ACAOrigin" in request.GET:
+        for item in request.GET["ACAOrigin"].split(","):
+            headers.append(("Access-Control-Allow-Origin", item))
+
+    for suffix in ["Headers", "Methods", "Credentials"]:
+        query = "ACA%s" % suffix
+        header = "Access-Control-Allow-%s" % suffix
+        if query in request.GET:
+            headers.append((header, request.GET[query]))
+
+    if "ACEHeaders" in request.GET:
+        headers.append(("Access-Control-Expose-Headers", request.GET[query]))
+
+    return status, headers, ""
diff --git a/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/success.json b/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/success.json
new file mode 100644
--- /dev/null
+++ b/testing/web-platform/mozilla/tests/service-workers/service-worker/resources/success.json
@@ -0,0 +1,1 @@
+{ "result": "success" }
