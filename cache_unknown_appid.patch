# HG changeset patch
# Parent 82066bb60765af8bc64a7199f285e85269e066db
# User Ben Kelly <ben@wanderview.com>
CacheStorage creation should throw for Principal with unknown app ID instead of crashing.


diff --git a/dom/cache/CacheStorage.cpp b/dom/cache/CacheStorage.cpp
--- a/dom/cache/CacheStorage.cpp
+++ b/dom/cache/CacheStorage.cpp
@@ -60,17 +60,30 @@ CacheStorage::CreateOnMainThread(Namespa
   bool nullPrincipal;
   nsresult rv = aPrincipal->GetIsNullPrincipal(&nullPrincipal);
   if (NS_WARN_IF(NS_FAILED(rv))) {
     aRv.Throw(rv);
     return nullptr;
   }
 
   if (nullPrincipal) {
-    NS_WARNING("CacheStorage is not supported on this principal.");
+    NS_WARNING("CacheStorage not supported on null principal.");
+    aRv.Throw(NS_ERROR_FAILURE);
+    return nullptr;
+  }
+
+  bool unknownAppId;
+  rv = aPrincipal->GetUnknownAppId(&unknownAppId);
+  if (NS_WARN_IF(NS_FAILED(rv))) {
+    aRv.Throw(rv);
+    return nullptr;
+  }
+
+  if (unknownAppId) {
+    NS_WARNING("CacheStorage not supported on principal with unknown appId.");
     aRv.Throw(NS_ERROR_FAILURE);
     return nullptr;
   }
 
   nsAutoCString origin;
   rv = aPrincipal->GetOrigin(getter_Copies(origin));
   if (NS_WARN_IF(NS_FAILED(rv))) {
     aRv.Throw(rv);
