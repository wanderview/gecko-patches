# HG changeset patch
# Parent d1755ba4f81454864553b5d19659054c9a7c5050
# User Ben Kelly <ben@wanderview.com>
Bug 1133939 P1 interdiff 001 address review feedback.


diff --git a/xpcom/io/nsPipe3.cpp b/xpcom/io/nsPipe3.cpp
--- a/xpcom/io/nsPipe3.cpp
+++ b/xpcom/io/nsPipe3.cpp
@@ -610,24 +610,26 @@ nsPipe::AdvanceReadSegment(nsPipeReadSta
 }
 
 void
 nsPipe::DrainInputStream(nsPipeReadState& aReadState, nsPipeEvents& aEvents,
                          uint32_t* aAvailableOut)
 {
   ReentrantMonitorAutoEnter mon(mReentrantMonitor);
 
+  *aAvailableOut = 0;
+
   bool modified = false;
-  while(mWriteSegment > aReadState.mSegment) {
+  while(mWriteSegment >= aReadState.mSegment) {
     modified = AdvanceReadSegment(aReadState) || modified;
   }
 
   // if we've free'd up a segment, notify output stream that pipe has
   // room for a new segment.
-  if (true && mOutput.OnOutputWritable(aEvents)) {
+  if (modified && mOutput.OnOutputWritable(aEvents)) {
     mon.Notify();
   }
 }
 
 nsresult
 nsPipe::GetWriteSegment(char*& aSegment, uint32_t& aSegmentLen)
 {
   ReentrantMonitorAutoEnter mon(mReentrantMonitor);
