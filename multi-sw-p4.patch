# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  23df7c3a21d63207bf8f8d60e0ed762496d7eb18
Multiple SW instances P4 - Add a preference

diff --git a/dom/workers/ServiceWorkerPrivate.cpp b/dom/workers/ServiceWorkerPrivate.cpp
--- a/dom/workers/ServiceWorkerPrivate.cpp
+++ b/dom/workers/ServiceWorkerPrivate.cpp
@@ -1771,21 +1771,25 @@ ServiceWorkerPrivate::SpawnWorkerIfNeede
   // spin up a new worker.
   MOZ_ASSERT(mSupportsArray.IsEmpty());
 
   if (NS_WARN_IF(!mInfo)) {
     NS_WARNING("Trying to wake up a dead service worker.");
     return NS_ERROR_FAILURE;
   }
 
-  const uint32_t kNumInstances = 3;
+  uint32_t numInstances = Preferences::GetInt("dom.serviceWorkers.num_instances", 1);
+  if (numInstances < 1) {
+    numInstances = 0;
+  }
+
   mNextWorkerPrivateIndex = 0;
 
-  nsTArray<RefPtr<WorkerPrivate>> workerPrivateList(kNumInstances);
-  for (uint32_t i = 0; i < kNumInstances; ++i) {
+  nsTArray<RefPtr<WorkerPrivate>> workerPrivateList(numInstances);
+  for (uint32_t i = 0; i < numInstances; ++i) {
     RefPtr<WorkerPrivate> workerPrivate;
     nsresult rv = SpawnWorker(mInfo, aLoadFailedRunnable, aLoadGroup,
                               getter_AddRefs(workerPrivate));
     if (NS_WARN_IF(NS_FAILED(rv))) {
       return rv;
     }
     workerPrivateList.AppendElement(workerPrivate.forget());
   }
