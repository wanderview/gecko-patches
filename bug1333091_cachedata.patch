# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  053e2f56e682f7283998470f890a3f5cd5875555
Bug 1333091 Clear Cache API shared data if Context fails to initialize. r=asuth

diff --git a/dom/cache/Context.cpp b/dom/cache/Context.cpp
--- a/dom/cache/Context.cpp
+++ b/dom/cache/Context.cpp
@@ -988,16 +988,21 @@ Context::Start()
 {
   NS_ASSERT_OWNINGTHREAD(Context);
 
   // Previous context closing delayed our start, but then we were canceled.
   // In this case, just do nothing here.
   if (mState == STATE_CONTEXT_CANCELED) {
     MOZ_DIAGNOSTIC_ASSERT(!mInitRunnable);
     MOZ_DIAGNOSTIC_ASSERT(!mInitAction);
+    // If we can't initialize the quota subsystem we will never be able to
+    // clear our shared data object via the target IO thread.  Instead just
+    // clear it here to maintain the invariant that the shared data is
+    // cleared before Context destruction.
+    mData = nullptr;
     return;
   }
 
   MOZ_DIAGNOSTIC_ASSERT(mState == STATE_CONTEXT_PREINIT);
   MOZ_DIAGNOSTIC_ASSERT(!mInitRunnable);
 
   mInitRunnable = new QuotaInitRunnable(this, mManager, mData, mTarget,
                                         mInitAction);
