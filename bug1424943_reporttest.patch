# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  e5998d29e9e4ddbf8194fa345871516da3ba4277
Bug 1424943 Fix test_error_reporting.html not to race network vs Clients API. r=tt

diff --git a/dom/workers/test/serviceworkers/sw_storage_not_allow.js b/dom/workers/test/serviceworkers/sw_storage_not_allow.js
--- a/dom/workers/test/serviceworkers/sw_storage_not_allow.js
+++ b/dom/workers/test/serviceworkers/sw_storage_not_allow.js
@@ -1,21 +1,34 @@
 let clientId;
 addEventListener('fetch', function(event) {
-  if (event.request.url.includes('getClients')) {
-    // Excepted to fail since the storage access is not allowed.
-    self.clients.matchAll();
-  } else if (event.request.url.includes('getClient-stage1')) {
-    self.clients.matchAll().then(function(clients) {
+  event.respondWith(async function() {
+    if (event.request.url.includes('getClients')) {
+      // Expected to fail since the storage access is not allowed.
+      try {
+        await self.clients.matchAll();
+      } catch (e) {
+        // expected failure
+      }
+    } else if (event.request.url.includes('getClient-stage1')) {
+      let clients = await self.clients.matchAll();
       clientId = clients[0].id;
-    });
-  } else if (event.request.url.includes('getClient-stage2')) {
-    // Excepted to fail since the storage access is not allowed.
-    self.clients.get(clientId);
-  }
+    } else if (event.request.url.includes('getClient-stage2')) {
+      // Expected to fail since the storage access is not allowed.
+      try {
+        await self.clients.get(clientId);
+      } catch(e) {
+        // expected failure
+      }
+    }
+
+    // Pass through the network request once our various Clients API
+    // promises have completed.
+    return await fetch(event.request);
+  }());
 });
 
 addEventListener('message', function(event) {
   if (event.data === 'claim') {
     event.waitUntil(clients.claim());
   }
 });
 
