# HG changeset patch
# Parent cb717fd15dbd2e64f8b55fce3da983c77d8b95a5
# User Ben Kelly <ben@wanderview.com>
Bug 1181871 Delay creation of shared Data object until Cache Context actually started. r=ehsan


diff --git a/dom/cache/Context.cpp b/dom/cache/Context.cpp
--- a/dom/cache/Context.cpp
+++ b/dom/cache/Context.cpp
@@ -789,17 +789,16 @@ Context::Create(Manager* aManager, nsITh
   nsRefPtr<Context> context = new Context(aManager, aTarget, aInitAction);
   context->Init(aOldContext);
   return context.forget();
 }
 
 Context::Context(Manager* aManager, nsIThread* aTarget, Action* aInitAction)
   : mManager(aManager)
   , mTarget(aTarget)
-  , mData(new Data(aTarget))
   , mState(STATE_CONTEXT_PREINIT)
   , mOrphanedData(false)
   , mInitAction(aInitAction)
 {
   MOZ_ASSERT(mManager);
   MOZ_ASSERT(mTarget);
 }
 
@@ -942,18 +941,21 @@ Context::Start()
   // In this case, just do nothing here.
   if (mState == STATE_CONTEXT_CANCELED) {
     MOZ_ASSERT(!mInitRunnable);
     MOZ_ASSERT(!mInitAction);
     return;
   }
 
   MOZ_ASSERT(mState == STATE_CONTEXT_PREINIT);
+  MOZ_ASSERT(!mThreadsafeHandle);
+  MOZ_ASSERT(!mData);
   MOZ_ASSERT(!mInitRunnable);
 
+  mData = new Data(mTarget);
   mInitRunnable = new QuotaInitRunnable(this, mManager, mData, mTarget,
                                         mInitAction);
   mInitAction = nullptr;
 
   mState = STATE_CONTEXT_INIT;
 
   nsresult rv = mInitRunnable->Dispatch();
   if (NS_FAILED(rv)) {
