# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  2dfb45d74f42d2a0010696f5fd47c7a7da94cedb
Bug 1238954 P1 Purge potentially controlled document entries when evicting service worker registrations. r=ehsan

diff --git a/dom/workers/ServiceWorkerManager.cpp b/dom/workers/ServiceWorkerManager.cpp
--- a/dom/workers/ServiceWorkerManager.cpp
+++ b/dom/workers/ServiceWorkerManager.cpp
@@ -3228,16 +3228,28 @@ ServiceWorkerManager::RemoveScopeAndRegi
   }
 
   nsCOMPtr<nsITimer> timer = data->mUpdateTimers.Get(aRegistration->mScope);
   if (timer) {
     timer->Cancel();
     data->mUpdateTimers.Remove(aRegistration->mScope);
   }
 
+  // The registration should generally only be removed if there are no controlled
+  // documents, but mControlledDocuments can contain references to potentially
+  // controlled docs.  This happens when the service worker is not active yet.
+  // We must purge these references since we are evicting the registration.
+  for (auto iter = swm->mControlledDocuments.Iter(); !iter.Done(); iter.Next()) {
+    ServiceWorkerRegistrationInfo* reg = iter.UserData();
+    MOZ_ASSERT(reg);
+    if (reg->mScope.Equals(aRegistration->mScope)) {
+      iter.Remove();
+    }
+  }
+
   RefPtr<ServiceWorkerRegistrationInfo> info;
   data->mInfos.Get(aRegistration->mScope, getter_AddRefs(info));
 
   data->mInfos.Remove(aRegistration->mScope);
   data->mOrderedScopes.RemoveElement(aRegistration->mScope);
   swm->NotifyListenersOnUnregister(info);
 
   swm->MaybeRemoveRegistrationInfo(scopeKey);
