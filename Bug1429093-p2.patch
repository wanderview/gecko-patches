# HG changeset patch
# User Tom Tung <shes050117@gmail.com>
# Date 1516159891 -28800
#      Wed Jan 17 11:31:31 2018 +0800
# Node ID 077ffe1374d1cd1f703de2dd12a44b921f5c6b20
# Parent  f44b587ba0601d393e64be9405cb19e7d5616c13
Bug 1429093 - P2: A test to verify the close event is not allowed to window interaction. r=bkelly

diff --git a/dom/workers/test/serviceworkers/notificationclose.html b/dom/workers/test/serviceworkers/notificationclose.html
--- a/dom/workers/test/serviceworkers/notificationclose.html
+++ b/dom/workers/test/serviceworkers/notificationclose.html
@@ -22,16 +22,16 @@
     return swr.getNotifications();
   }).then(function(notifications) {
     notifications.forEach(function(notification) {
       notification.close();
     });
   });
 
   navigator.serviceWorker.onmessage = function(msg) {
-    testWindow.callback(msg.data.result);
+    testWindow.callback(msg.data);
   };
 </script>
 
 </head>
 <body>
 </body>
 </html>
diff --git a/dom/workers/test/serviceworkers/notificationclose.js b/dom/workers/test/serviceworkers/notificationclose.js
--- a/dom/workers/test/serviceworkers/notificationclose.js
+++ b/dom/workers/test/serviceworkers/notificationclose.js
@@ -1,19 +1,28 @@
 // Any copyright is dedicated to the Public Domain.
 // http://creativecommons.org/publicdomain/zero/1.0/
 //
 onnotificationclose = function(e) {
-  self.clients.matchAll().then(function(clients) {
-    if (clients.length === 0) {
-      dump("********************* CLIENTS LIST EMPTY! Test will timeout! ***********************\n");
-      return;
-    }
+  e.waitUntil(async function() {
+    let windowOpened = true;
+    await clients.openWindow("hello.html")
+      .catch(err => {
+        windowOpened = false;
+      });
 
-    clients.forEach(function(client) {
-      client.postMessage({ result: e.notification.data &&
-                                   e.notification.data['complex'] &&
-                                   e.notification.data['complex'][0] == "jsval" &&
-                                   e.notification.data['complex'][1] == 5 });
+    self.clients.matchAll().then(function(clients) {
+      if (clients.length === 0) {
+        dump("*** CLIENTS LIST EMPTY! Test will timeout! ***\n");
+        return;
+      }
 
+      clients.forEach(function(client) {
+        client.postMessage({ result: e.notification.data &&
+                                     e.notification.data['complex'] &&
+                                     e.notification.data['complex'][0] == "jsval" &&
+                                     e.notification.data['complex'][1] == 5,
+                             windowOpened: windowOpened});
+
+      });
     });
-  });
+  }());
 }
diff --git a/dom/workers/test/serviceworkers/test_notificationclose.html b/dom/workers/test/serviceworkers/test_notificationclose.html
--- a/dom/workers/test/serviceworkers/test_notificationclose.html
+++ b/dom/workers/test/serviceworkers/test_notificationclose.html
@@ -19,21 +19,23 @@ https://bugzilla.mozilla.org/show_bug.cg
 </pre>
 <script src="utils.js"></script>
 <script type="text/javascript">
   SimpleTest.requestFlakyTimeout("Mock alert service dispatches show, click, and close events.");
 
   function testFrame(src) {
     var iframe = document.createElement("iframe");
     iframe.src = src;
-    window.callback = function(result) {
+    window.callback = function(data) {
       window.callback = null;
       document.body.removeChild(iframe);
       iframe = null;
-      ok(result, "Got notificationclose event with correct data.");
+      ok(data.result, "Got notificationclose event with correct data.");
+      ok(!data.windowOpened,
+         "Shouldn't allow to openWindow in notificationclose");
       MockServices.unregister();
       registration.unregister().then(function() {
         SimpleTest.finish();
       });
     };
     document.body.appendChild(iframe);
   }
 
