# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  e7ae9a3a5cb0f0077cc3f402e9e17c556b874cad
Bug 1363848 P2 Do not intercept internal redirects regardless of LOAD_BYPASS_SERVICE_WORKER flag. r=dragana

diff --git a/netwerk/protocol/http/HttpBaseChannel.cpp b/netwerk/protocol/http/HttpBaseChannel.cpp
--- a/netwerk/protocol/http/HttpBaseChannel.cpp
+++ b/netwerk/protocol/http/HttpBaseChannel.cpp
@@ -2931,17 +2931,20 @@ HttpBaseChannel::BypassServiceWorker() c
 }
 
 bool
 HttpBaseChannel::ShouldIntercept(nsIURI* aURI)
 {
   nsCOMPtr<nsINetworkInterceptController> controller;
   GetCallback(controller);
   bool shouldIntercept = false;
-  if (controller && !BypassServiceWorker() && mLoadInfo) {
+  bool internalRedirect =
+    mLastRedirectFlags & (nsIChannelEventSink::REDIRECT_INTERNAL |
+                          nsIChannelEventSink::REDIRECT_STS_UPGRADE);
+  if (controller && mLoadInfo && !BypassServiceWorker() && !internalRedirect) {
     nsresult rv = controller->ShouldPrepareForIntercept(aURI ? aURI : mURI.get(),
                                                         nsContentUtils::IsNonSubresourceRequest(this),
                                                         &shouldIntercept);
     if (NS_FAILED(rv)) {
       return false;
     }
   }
   return shouldIntercept;
