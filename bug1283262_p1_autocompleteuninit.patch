# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  cde56ead650fd302be1d440507485b9abf7c163a
Bug 1283262 P1 Make AutoCompleteE10S clear its popup cache when the associated browser window is closed. r=mrbkap

diff --git a/toolkit/components/satchel/AutoCompleteE10S.jsm b/toolkit/components/satchel/AutoCompleteE10S.jsm
--- a/toolkit/components/satchel/AutoCompleteE10S.jsm
+++ b/toolkit/components/satchel/AutoCompleteE10S.jsm
@@ -86,31 +86,48 @@ this.AutoCompleteE10S = {
     messageManager.addMessageListener("FormAutoComplete:GetSelectedIndex", this);
     messageManager.addMessageListener("FormAutoComplete:MaybeOpenPopup", this);
     messageManager.addMessageListener("FormAutoComplete:ClosePopup", this);
     messageManager.addMessageListener("FormAutoComplete:Disconnect", this);
     messageManager.addMessageListener("FormAutoComplete:RemoveEntry", this);
   },
 
   _initPopup: function(browserWindow, rect, direction) {
+    if (this._popupCache) {
+      this._popupCache.browserWindow.removeEventListener("unload", this);
+    }
+    browserWindow.addEventListener("unload", this);
+
     this._popupCache = { browserWindow, rect, direction };
 
     this.browser = browserWindow.gBrowser.selectedBrowser;
     this.popup = this.browser.autoCompletePopup;
     this.popup.hidden = false;
     // don't allow the popup to become overly narrow
     this.popup.setAttribute("width", Math.max(100, rect.width));
     this.popup.style.direction = direction;
 
     this.x = rect.left;
     this.y = rect.top;
     this.width = rect.width;
     this.height = rect.height;
   },
 
+  handleEvent: function(evt) {
+    if (evt.type === "unload") {
+      this._uninitPopup();
+    }
+  },
+
+  _uninitPopup: function() {
+    this._popupCache = null;
+    this.browser = null;
+    this.popup = null;
+  },
+
   _showPopup: function(results) {
     AutoCompleteE10SView.clearResults();
 
     let resultsArray = [];
     let count = results.matchCount;
     for (let i = 0; i < count; i++) {
       // The actual result for each match in the results object is the value.
       // We return that in order to submit the correct value. However, we have
