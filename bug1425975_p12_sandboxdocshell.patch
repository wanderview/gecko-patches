# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  6b7cbdd259f0f3e8332bf0cefd264425bfa9d748
Bug 1425975 P12 Don't mark an initial about:blank client as controlled if its sandboxed. r=asuth

diff --git a/docshell/base/nsDocShell.cpp b/docshell/base/nsDocShell.cpp
--- a/docshell/base/nsDocShell.cpp
+++ b/docshell/base/nsDocShell.cpp
@@ -3413,17 +3413,17 @@ nsDocShell::MaybeCreateInitialClientSour
   // when DoChannelLoad() is called before CreateAboutBlankContentViewer.
   if (mInitialClientSource) {
     return;
   }
 
   // Don't pre-allocate the client when we are sandboxed.  The inherited
   // principal does not take sandboxing into account.
   // TODO: Refactor sandboxing principal code out so we can use it here.
-  if (!aPrincipal && (mSandboxFlags & SANDBOXED_ORIGIN)) {
+  if (!aPrincipal && mSandboxFlags) {
     return;
   }
 
   nsIPrincipal* principal = aPrincipal ? aPrincipal
                                        : GetInheritedPrincipal(false);
 
   // Sometimes there is no principal available when we are called from
   // CreateAboutBlankContentViewer.  For example, sometimes the principal
@@ -3455,18 +3455,21 @@ nsDocShell::MaybeCreateInitialClientSour
   nsCOMPtr<nsIDocShell> parent = GetParentDocshell();
   nsPIDOMWindowOuter* parentOuter = parent ? parent->GetWindow() : nullptr;
   nsPIDOMWindowInner* parentInner =
     parentOuter ? parentOuter->GetCurrentInnerWindow() : nullptr;
   if (!parentInner) {
     return;
   }
 
+  // We're done if there is no parent controller.  Also, don't inherit
+  // the controller if we're sandboxed.  This matches our behavior in
+  // ShouldPrepareForIntercept(),
   Maybe<ServiceWorkerDescriptor> controller(parentInner->GetController());
-  if (controller.isNothing()) {
+  if (controller.isNothing() || mSandboxFlags) {
     return;
   }
 
   nsCOMPtr<nsIServiceWorkerManager> swm = mozilla::services::GetServiceWorkerManager();
   if (!swm) {
     return;
   }
 
