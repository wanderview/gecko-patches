# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  1152d99d8c53ac9dae371a6e6d9fab03d3f98697
Bug 1266221 P2 Expand devtools test to verify toolbox service worker option works with nested iframes. r=bgrins

diff --git a/devtools/client/framework/test/browser_toolbox_options_enable_serviceworkers_testing.js b/devtools/client/framework/test/browser_toolbox_options_enable_serviceworkers_testing.js
--- a/devtools/client/framework/test/browser_toolbox_options_enable_serviceworkers_testing.js
+++ b/devtools/client/framework/test/browser_toolbox_options_enable_serviceworkers_testing.js
@@ -55,16 +55,20 @@ function testSelectTool(aToolbox) {
 function register() {
   return executeInContent("devtools:sw-test:register");
 }
 
 function unregister(swr) {
   return executeInContent("devtools:sw-test:unregister");
 }
 
+function registerAndUnregisterInFrame() {
+  return executeInContent("devtools:sw-test:iframe:register-and-unregister");
+}
+
 function testRegisterFails(data) {
   is(data.success, false, "Register should fail with security error");
   return promise.resolve();
 }
 
 function toggleServiceWorkersTestingCheckbox() {
   let panel = toolbox.getCurrentPanel();
   let cbx = panel.panelDoc.getElementById(ELEMENT_ID);
@@ -102,16 +106,18 @@ function testRegisterSuccesses(data) {
 function start() {
   register()
     .then(testRegisterFails)
     .then(toggleServiceWorkersTestingCheckbox)
     .then(reload)
     .then(register)
     .then(testRegisterSuccesses)
     .then(unregister)
+    .then(registerAndUnregisterInFrame)
+    .then(testRegisterSuccesses)
     // Workers should be turned back off when we closes the toolbox
     .then(toolbox.destroy.bind(toolbox))
     .then(reload)
     .then(register)
     .then(testRegisterFails)
     .catch(function(e) {
       ok(false, "Some test failed with error " + e);
     }).then(finishUp);
diff --git a/devtools/client/framework/test/browser_toolbox_options_enable_serviceworkers_testing_frame_script.js b/devtools/client/framework/test/browser_toolbox_options_enable_serviceworkers_testing_frame_script.js
--- a/devtools/client/framework/test/browser_toolbox_options_enable_serviceworkers_testing_frame_script.js
+++ b/devtools/client/framework/test/browser_toolbox_options_enable_serviceworkers_testing_frame_script.js
@@ -19,8 +19,28 @@ addMessageListener("devtools:sw-test:reg
 addMessageListener("devtools:sw-test:unregister", function(msg) {
   content.navigator.serviceWorker.getRegistration().then(swr => {
     swr.unregister().then(result => {
       sendAsyncMessage("devtools:sw-test:unregister",
                        {success: result ? true : false});
     });
   });
 });
+
+addMessageListener("devtools:sw-test:iframe:register-and-unregister", function(msg) {
+  var frame = content.document.createElement("iframe");
+  frame.addEventListener("load", function onLoad() {
+    frame.removeEventListener("load", onLoad);
+    frame.contentWindow.navigator.serviceWorker.register("serviceworker.js")
+      .then(swr => {
+        return swr.unregister();
+      }).then(_ => {
+        frame.remove();
+        sendAsyncMessage("devtools:sw-test:iframe:register-and-unregister",
+                         {success: true});
+      }).catch(error => {
+        sendAsyncMessage("devtools:sw-test:iframe:register-and-unregister",
+                         {success: false});
+      });
+  });
+  frame.src = "browser_toolbox_options_enabled_serviceworkers_testing.html";
+  content.document.body.appendChild(frame);
+});
