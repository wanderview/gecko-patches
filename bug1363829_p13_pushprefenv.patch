# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  b5c7a4a9e53b5a76b1271a8fbf8b0090ba11f552
Bug 1363829 P13 Make pushPrefEnv() use setTimeout(1) since setTimeout(0) fires slightly faster now. r=ehsan

diff --git a/testing/specialpowers/content/specialpowersAPI.js b/testing/specialpowers/content/specialpowersAPI.js
--- a/testing/specialpowers/content/specialpowersAPI.js
+++ b/testing/specialpowers/content/specialpowersAPI.js
@@ -697,37 +697,42 @@ SpecialPowersAPI.prototype = {
   removePendingCrashDumpFiles: function() {
     var message = {
       op: "delete-pending-crash-dump-files"
     };
     var removed = this._sendSyncMessage("SPProcessCrashService", message)[0];
     return removed;
   },
 
+  // Note: We increased the setTimeout(f, 0) to setTimeout(f, 1) here in
+  //       bug 1363829.  This was necessary because the bug sped up
+  //       setTimeout(f, 0) enough that some tests failed.  Using a delay
+  //       of 1ms is closer to our historical test timing.
+
   _setTimeout: function(callback) {
     // for mochitest-browser
     if (typeof window != 'undefined')
-      setTimeout(callback, 0);
+      setTimeout(callback, 1);
     // for mochitest-plain
     else
-      content.window.setTimeout(callback, 0);
+      content.window.setTimeout(callback, 1);
   },
 
   _delayCallbackTwice: function(callback) {
      function delayedCallback() {
        function delayAgain(aCallback) {
          // Using this._setTimeout doesn't work here
          // It causes failures in mochtests that use
          // multiple pushPrefEnv calls
          // For chrome/browser-chrome mochitests
          if (typeof window != 'undefined')
-           setTimeout(aCallback, 0);
+           setTimeout(aCallback, 1);
          // For mochitest-plain
          else
-           content.window.setTimeout(aCallback, 0);
+           content.window.setTimeout(aCallback, 1);
        }
        delayAgain(delayAgain(callback));
      }
      return delayedCallback;
   },
 
   /* apply permissions to the system and when the test case is finished (SimpleTest.finish())
      we will revert the permission back to the original.
