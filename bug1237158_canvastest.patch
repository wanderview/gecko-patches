# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  1ec3a3ff68f2d1a54e6ed33e926c28fee286bdf1
Bug 1237158 Unregister service worker at end of test_offscreen_serviceworker.html. r=ehsan

diff --git a/dom/canvas/test/test_offscreencanvas_serviceworker.html b/dom/canvas/test/test_offscreencanvas_serviceworker.html
--- a/dom/canvas/test/test_offscreencanvas_serviceworker.html
+++ b/dom/canvas/test/test_offscreencanvas_serviceworker.html
@@ -6,29 +6,36 @@
 <link rel="stylesheet" href="/tests/SimpleTest/test.css">
 </head>
 <body>
 <script>
 
 SimpleTest.waitForExplicitFinish();
 
 function runTest() {
+  var registration;
+
   window.onmessage = function(evt) {
     var msg = evt.data || {};
     if (msg.type == "test") {
       ok(msg.result, msg.name);
     }
     if (msg.type == "finish") {
-      SimpleTest.finish();
+      registration.unregister().then(function() {
+        SimpleTest.finish();
+      });
     }
   }
 
   navigator.serviceWorker.register('offscreencanvas.js', { scope: "."})
     // Wait until the service worker is active.
-    .then(navigator.serviceWorker.ready)
+    .then(function(swr) {
+      registration = swr;
+      return navigator.serviceWorker.ready;
+    })
     // ...and then show the interface for the commands once it's ready.
     .then(function() {
       iframe = document.createElement("iframe");
       iframe.setAttribute('src', "offscreencanvas_serviceworker_inner.html");
       document.body.appendChild(iframe);
     })
 }
 
