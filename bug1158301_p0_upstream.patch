# HG changeset patch
# Parent 6a881bc618fd529f68383d1c07c39d2bc119c7c5
# User Ben Kelly <ben@wanderview.com>
Bug 1158301 Fix upstream to expect .text() to consume the Response body.

diff --git a/testing/web-platform/tests/service-workers/cache-storage/script-tests/cache-put.js b/testing/web-platform/tests/service-workers/cache-storage/script-tests/cache-put.js
--- a/testing/web-platform/tests/service-workers/cache-storage/script-tests/cache-put.js
+++ b/testing/web-platform/tests/service-workers/cache-storage/script-tests/cache-put.js
@@ -308,17 +308,27 @@ cache_test(function(cache) {
   }, 'Cache.put with a used request body');
 
 cache_test(function(cache) {
     var response = new Response(test_body);
     assert_false(response.bodyUsed,
                  '[https://fetch.spec.whatwg.org/#dom-body-bodyused] ' +
                  'Response.bodyUsed should be initially false.');
     return response.text().then(function() {
-      assert_false(
+      assert_true(
         response.bodyUsed,
         '[https://fetch.spec.whatwg.org/#concept-body-consume-body] ' +
-          'The text() method should not set "body passed" flag.');
+          'The text() method should set "body used" flag.');
       return cache.put(new Request(test_url), response);
-    });
+      })
+    .then(function() {
+        assert_unreached('Cache put should reject when Response body ' +
+                         'is already used');
+      })
+    .catch(function(err) {
+        assert_equals(err.name, 'TypeError',
+                      '[https://slightlyoff.github.io/ServiceWorker/spec/service_worker/index.html#cache-put] ' +
+                      'Cache put should reject with TypeError when Response ' +
+                      'body is already used.');
+      });
   }, 'Cache.put with a used response body');
 
 done();
