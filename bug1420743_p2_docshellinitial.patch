# HG changeset patch
# User Ben Kelly <ben@wanderview.com>
# Parent  1ce0388a784ef10c5edba5634699b52610c5712d
Bug 1420743 P2 Check the inner window for an existing document instead of the outer window in nsDocShell::EnsureInitialClientSource(). r=baku

diff --git a/docshell/base/nsDocShell.cpp b/docshell/base/nsDocShell.cpp
--- a/docshell/base/nsDocShell.cpp
+++ b/docshell/base/nsDocShell.cpp
@@ -3393,17 +3393,18 @@ nsDocShell::GetParentDocshell()
   return docshell.forget().downcast<nsDocShell>();
 }
 
 void
 nsDocShell::MaybeCreateInitialClientSource(nsIPrincipal* aPrincipal)
 {
   // If there is an existing document then there is no need to create
   // a client for a future initial about:blank document.
-  if (mScriptGlobal && mScriptGlobal->GetExtantDoc()) {
+  if (mScriptGlobal && mScriptGlobal->GetCurrentInnerWindowInternal() &&
+      mScriptGlobal->GetCurrentInnerWindowInternal()->GetExtantDoc()) {
     MOZ_DIAGNOSTIC_ASSERT(
       mScriptGlobal->GetCurrentInnerWindowInternal()->GetClientInfo().isSome());
     MOZ_DIAGNOSTIC_ASSERT(!mInitialClientSource);
     return;
   }
 
   // Don't recreate the initial client source.  We call this multiple times
   // when DoChannelLoad() is called before CreateAboutBlankContentViewer.
